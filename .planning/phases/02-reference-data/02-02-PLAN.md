---
phase: 02-reference-data
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/actions/batteries.ts
  - src/components/batteries/battery-brand-form.tsx
  - src/components/batteries/battery-config-form.tsx
  - src/components/batteries/battery-list.tsx
  - src/app/(dashboard)/dashboard/batteries/page.tsx
  - src/app/(dashboard)/dashboard/batteries/brands/new/page.tsx
  - src/app/(dashboard)/dashboard/batteries/brands/[id]/page.tsx
  - src/app/(dashboard)/dashboard/batteries/configs/new/page.tsx
  - src/app/(dashboard)/dashboard/batteries/configs/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Org Admin can create a new battery brand"
    - "Org Admin can create a battery configuration with all specs"
    - "Org Admin can edit battery brand name"
    - "Org Admin can edit battery configuration specs"
    - "Org Admin can delete battery brands and configs"
    - "Closer can view battery list but cannot create/edit/delete"
    - "Battery data is scoped to organization (cannot see other orgs' batteries)"
  artifacts:
    - path: "src/actions/batteries.ts"
      provides: "Server actions for battery CRUD"
      exports: ["createBatteryBrand", "updateBatteryBrand", "deleteBatteryBrand", "createBatteryConfig", "updateBatteryConfig", "deleteBatteryConfig", "getBatteryBrands", "getBatteryConfigs"]
    - path: "src/components/batteries/battery-list.tsx"
      provides: "Battery list display component"
      min_lines: 50
    - path: "src/app/(dashboard)/dashboard/batteries/page.tsx"
      provides: "Battery management page"
      min_lines: 30
  key_links:
    - from: "src/app/(dashboard)/dashboard/batteries/page.tsx"
      to: "src/actions/batteries.ts"
      via: "getBatteryBrands call"
      pattern: "getBatteryBrands"
    - from: "src/components/batteries/battery-config-form.tsx"
      to: "src/actions/batteries.ts"
      via: "createBatteryConfig or updateBatteryConfig"
      pattern: "(create|update)BatteryConfig"
---

<objective>
Implement battery brand and configuration CRUD for Org Admins.

Purpose: Org Admins need to configure battery options that Closers will use when creating calculations. This covers requirements BATT-01 through BATT-06.

Output: Full CRUD functionality for battery brands and configs with forms, list views, and server actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reference-data/02-RESEARCH.md
@.planning/phases/02-reference-data/02-01-SUMMARY.md
@src/actions/users.ts
@src/components/users/user-form.tsx
@src/components/users/user-list.tsx
@src/app/(dashboard)/dashboard/users/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create battery server actions</name>
  <files>src/actions/batteries.ts</files>
  <action>
Create src/actions/batteries.ts following the pattern from src/actions/users.ts:

1. **Zod schemas**:
```typescript
const batteryBrandSchema = z.object({
  name: z.string().min(2, 'Varumarke maste vara minst 2 tecken').max(100),
  logoUrl: z.string().url().optional().or(z.literal('')),
});

const batteryConfigSchema = z.object({
  name: z.string().min(2, 'Namn maste vara minst 2 tecken').max(100),
  brandId: z.string().cuid('Ogiltigt varumarke'),
  capacityKwh: z.number().positive('Kapacitet maste vara positiv'),
  maxDischargeKw: z.number().positive('Maxeffekt urladdning maste vara positiv'),
  maxChargeKw: z.number().positive('Maxeffekt laddning maste vara positiv'),
  chargeEfficiency: z.number().min(0).max(100, 'Effektivitet maste vara 0-100%'),
  dischargeEfficiency: z.number().min(0).max(100, 'Effektivitet maste vara 0-100%'),
  warrantyYears: z.number().int().positive('Garantitid maste vara minst 1 ar'),
  guaranteedCycles: z.number().int().positive('Cykler maste vara minst 1'),
  degradationPerYear: z.number().min(0).max(100, 'Degradering maste vara 0-100%'),
  costPrice: z.number().min(0, 'Inkopspris far inte vara negativt'),
  isExtensionCabinet: z.boolean().default(false),
  isNewStack: z.boolean().default(true),
});
```

2. **Brand actions** (all use BATTERY_* permissions, createTenantClient for scoping):
- createBatteryBrand(data): BATTERY_CREATE permission, returns { success, brandId } or { error }
- updateBatteryBrand(id, data): BATTERY_EDIT permission
- deleteBatteryBrand(id): BATTERY_DELETE permission, check if brand has configs first
- getBatteryBrands(): BATTERY_VIEW permission, returns { brands }

3. **Config actions**:
- createBatteryConfig(data): BATTERY_CREATE permission, verify brandId belongs to same org
- updateBatteryConfig(id, data): BATTERY_EDIT permission
- deleteBatteryConfig(id): BATTERY_DELETE permission
- getBatteryConfigs(brandId?): BATTERY_VIEW permission, optional filter by brand
- getBatteryConfig(id): BATTERY_VIEW permission, single config fetch

4. **Permission checks pattern**:
```typescript
const session = await auth();
if (!session?.user) return { error: 'Ej inloggad' };

const role = session.user.role as Role;
if (!hasPermission(role, PERMISSIONS.BATTERY_CREATE)) {
  return { error: 'Du har inte behorighet' };
}

// Use tenant client for org scoping
const tenantDb = createTenantClient(session.user.orgId!);
```

5. **Revalidate paths** after mutations: revalidatePath('/dashboard/batteries')

Note: Closers can call getBatteryBrands/getBatteryConfigs (BATTERY_VIEW) but not create/edit/delete.
  </action>
  <verify>Run `npx tsc --noEmit src/actions/batteries.ts` - no type errors</verify>
  <done>Battery server actions created with full CRUD, validation, permission checks, and tenant scoping</done>
</task>

<task type="auto">
  <name>Task 2: Create battery form components</name>
  <files>src/components/batteries/battery-brand-form.tsx, src/components/batteries/battery-config-form.tsx</files>
  <action>
Create battery form components following the pattern from src/components/users/user-form.tsx:

**src/components/batteries/battery-brand-form.tsx:**
```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import { createBatteryBrand, updateBatteryBrand } from '@/actions/batteries';
// ... UI imports

interface BatteryBrandFormProps {
  brand?: { id: string; name: string; logoUrl: string | null };
}

export function BatteryBrandForm({ brand }: BatteryBrandFormProps) {
  const isEditing = !!brand;
  // Form logic with react-hook-form
  // Submit handler calls createBatteryBrand or updateBatteryBrand
  // Redirects to /dashboard/batteries on success
}
```

**src/components/batteries/battery-config-form.tsx:**
```typescript
'use client';

interface BatteryConfigFormProps {
  config?: ExistingConfig; // For edit mode
  brands: { id: string; name: string }[]; // For brand dropdown
  brandId?: string; // Pre-selected brand (for create from brand page)
}

export function BatteryConfigForm({ config, brands, brandId }: BatteryConfigFormProps) {
  // Form with all battery spec fields from BATT-03:
  // - Brand dropdown (required)
  // - Name input
  // - Capacity (kWh) - number input
  // - Max discharge/charge (kW) - number inputs
  // - Charge/discharge efficiency (%) - number inputs with max 100
  // - Warranty years, guaranteed cycles - integer inputs
  // - Degradation per year (%) - number input
  // - Cost price (SEK) - number input
  // - isExtensionCabinet, isNewStack - checkboxes (BATT-04)

  // Group fields logically:
  // Section 1: Basic info (brand, name)
  // Section 2: Power specs (capacity, discharge, charge)
  // Section 3: Efficiency (charge eff, discharge eff)
  // Section 4: Warranty (years, cycles, degradation)
  // Section 5: Pricing & flags (cost, extension, new stack)
}
```

Use Swedish labels:
- Varumarke = Brand
- Kapacitet (kWh) = Capacity
- Maxeffekt urladdning (kW) = Max discharge power
- Maxeffekt laddning (kW) = Max charge power
- Laddningseffektivitet (%) = Charge efficiency
- Urladdningseffektivitet (%) = Discharge efficiency
- Garantitid (ar) = Warranty years
- Garanterade cykler = Guaranteed cycles
- Degradering per ar (%) = Degradation per year
- Inkopspris (SEK) = Cost price
- Tillbehorsskap = Extension cabinet
- Nytt batteripaket = New stack
  </action>
  <verify>Run `npx tsc --noEmit src/components/batteries/*.tsx` - no type errors</verify>
  <done>Battery brand and config forms created with all required fields, Swedish labels, proper validation</done>
</task>

<task type="auto">
  <name>Task 3: Create battery list and pages</name>
  <files>src/components/batteries/battery-list.tsx, src/app/(dashboard)/dashboard/batteries/page.tsx, src/app/(dashboard)/dashboard/batteries/brands/new/page.tsx, src/app/(dashboard)/dashboard/batteries/brands/[id]/page.tsx, src/app/(dashboard)/dashboard/batteries/configs/new/page.tsx, src/app/(dashboard)/dashboard/batteries/configs/[id]/page.tsx</files>
  <action>
Create battery list component and pages following existing patterns:

**src/components/batteries/battery-list.tsx:**
- Display brands with expandable config list
- Each brand shows: name, logo (if present), config count
- Each config shows: name, capacity, warranty, cost price
- Edit/Delete buttons only shown if user has BATTERY_EDIT/BATTERY_DELETE permissions
- "Lagg till konfiguration" button per brand (if BATTERY_CREATE permission)
- Pass userRole prop to control button visibility

**src/app/(dashboard)/dashboard/batteries/page.tsx:**
```typescript
import { auth } from '@/lib/auth/auth';
import { redirect } from 'next/navigation';
import { getBatteryBrands } from '@/actions/batteries';
import { BatteryList } from '@/components/batteries/battery-list';
import { hasPermission, PERMISSIONS, Role } from '@/lib/auth/permissions';

export default async function BatteriesPage() {
  const session = await auth();
  if (!session?.user) redirect('/login');

  // Check view permission
  const role = session.user.role as Role;
  if (!hasPermission(role, PERMISSIONS.BATTERY_VIEW)) {
    redirect('/dashboard');
  }

  const { brands, error } = await getBatteryBrands();
  if (error) return <div>Fel: {error}</div>;

  const canCreate = hasPermission(role, PERMISSIONS.BATTERY_CREATE);

  return (
    <div>
      <header className="flex justify-between items-center mb-6">
        <h1>Batterier</h1>
        {canCreate && (
          <Link href="/dashboard/batteries/brands/new">
            <Button>Lagg till varumarke</Button>
          </Link>
        )}
      </header>
      <BatteryList brands={brands} userRole={role} />
    </div>
  );
}
```

**Create/edit pages:**
- /dashboard/batteries/brands/new - BatteryBrandForm (create mode)
- /dashboard/batteries/brands/[id] - BatteryBrandForm (edit mode), load existing brand
- /dashboard/batteries/configs/new?brandId=X - BatteryConfigForm (create mode)
- /dashboard/batteries/configs/[id] - BatteryConfigForm (edit mode), load existing config

All pages check BATTERY_CREATE or BATTERY_EDIT permission before rendering form.
Redirect unauthorized users to /dashboard/batteries with appropriate message.
  </action>
  <verify>Run `npm run build` - build should succeed with no errors</verify>
  <done>Battery list and all CRUD pages created, permission-gated, following existing patterns</done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Log in as Org Admin
3. Navigate to /dashboard/batteries
4. Create a new brand (e.g., "Emaldo")
5. Create a new config under that brand with all specs filled
6. Edit the config, verify changes save
7. Delete the config
8. Delete the brand
9. Log in as Closer - verify can view but not create/edit/delete
10. Check browser DevTools Network tab - verify no API errors

```bash
# Quick smoke test
curl -s http://localhost:3000/dashboard/batteries | grep -c "Batterier"
```
</verification>

<success_criteria>
1. BATT-01: Org Admin can create battery brands (name, optional logo)
2. BATT-02: Org Admin can create battery configurations per brand
3. BATT-03: Config includes all specs: capacity, power rates, efficiencies, warranty, cycles, degradation, cost
4. BATT-04: Config supports extension cabinet and new stack flags
5. BATT-05: Org Admin can edit and delete battery configs and brands
6. BATT-06: Battery data scoped to organization - verified by tenant client usage
7. Forms use Swedish labels and error messages
8. Closer can view batteries but cannot create/edit/delete
9. All pages follow existing dashboard UI patterns
</success_criteria>

<output>
After completion, create `.planning/phases/02-reference-data/02-02-SUMMARY.md`
</output>
