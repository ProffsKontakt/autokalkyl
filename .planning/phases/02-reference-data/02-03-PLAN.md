---
phase: 02-reference-data
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/actions/natagare.ts
  - src/components/natagare/natagare-form.tsx
  - src/components/natagare/natagare-list.tsx
  - src/app/(dashboard)/dashboard/natagare/page.tsx
  - src/app/(dashboard)/dashboard/natagare/new/page.tsx
  - src/app/(dashboard)/dashboard/natagare/[id]/page.tsx
  - prisma/seed.ts
autonomous: true

must_haves:
  truths:
    - "Org Admin can create a natagare with day/night rates"
    - "Org Admin can edit natagare rates and time windows"
    - "Org Admin can delete natagare records"
    - "New organizations get default natagare (Ellevio with verified rates)"
    - "Closer can view natagare list but cannot create/edit/delete"
    - "Natagare data is scoped to organization"
  artifacts:
    - path: "src/actions/natagare.ts"
      provides: "Server actions for natagare CRUD"
      exports: ["createNatagare", "updateNatagare", "deleteNatagare", "getNatagare", "getNatagareById"]
    - path: "src/components/natagare/natagare-list.tsx"
      provides: "Natagare list display component"
      min_lines: 40
    - path: "prisma/seed.ts"
      provides: "Default natagare seeding"
      contains: "Ellevio"
  key_links:
    - from: "src/app/(dashboard)/dashboard/natagare/page.tsx"
      to: "src/actions/natagare.ts"
      via: "getNatagare call"
      pattern: "getNatagare"
    - from: "src/components/natagare/natagare-form.tsx"
      to: "src/actions/natagare.ts"
      via: "createNatagare or updateNatagare"
      pattern: "(create|update)Natagare"
---

<objective>
Implement natagare (grid operator) CRUD for Org Admins with default seeding.

Purpose: Org Admins need to configure grid operators and their effekttariff rates for accurate ROI calculations. This covers requirements NATA-01 through NATA-05.

Output: Full CRUD functionality for natagare with forms, list views, server actions, and default seeding for common Swedish grid operators.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reference-data/02-RESEARCH.md
@.planning/phases/02-reference-data/02-01-SUMMARY.md
@src/actions/users.ts
@src/components/users/user-form.tsx
@prisma/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create natagare server actions</name>
  <files>src/actions/natagare.ts</files>
  <action>
Create src/actions/natagare.ts following the established server action pattern:

1. **Zod schema**:
```typescript
const natagareSchema = z.object({
  name: z.string().min(2, 'Namn maste vara minst 2 tecken').max(100),
  dayRateSekKw: z.number().min(0, 'Dagstariff far inte vara negativ'),
  nightRateSekKw: z.number().min(0, 'Natttariff far inte vara negativ'),
  dayStartHour: z.number().int().min(0).max(23, 'Ogiltig starttid'),
  dayEndHour: z.number().int().min(0).max(23, 'Ogiltig sluttid'),
});
```

2. **CRUD actions** (all use NATAGARE_* permissions, createTenantClient for scoping):

- **createNatagare(data):**
  - NATAGARE_CREATE permission
  - Validate with schema
  - Use tenantDb.natagare.create
  - Return { success, natagareId } or { error }
  - Revalidate /dashboard/natagare

- **updateNatagare(id, data):**
  - NATAGARE_EDIT permission
  - Cannot edit isDefault field (only set during seeding)
  - Use tenantDb.natagare.update
  - Return { success } or { error }

- **deleteNatagare(id):**
  - NATAGARE_DELETE permission
  - Cannot delete if natagare is used in calculations (future check - for now just delete)
  - Cannot delete default natagare (isDefault: true) - return error
  - Use tenantDb.natagare.delete
  - Return { success } or { error }

- **getNatagare():**
  - NATAGARE_VIEW permission
  - Use tenantDb.natagare.findMany({ orderBy: { name: 'asc' } })
  - Return { natagare } or { error }

- **getNatagareById(id):**
  - NATAGARE_VIEW permission
  - Use tenantDb.natagare.findFirst
  - Return { natagare } or { error }

3. **Seed function** (for use in prisma/seed.ts):
```typescript
export async function seedDefaultNatagare(orgId: string) {
  const DEFAULT_NATAGARE = [
    {
      name: 'Ellevio',
      dayRateSekKw: 81.25,
      nightRateSekKw: 40.625, // Half of day rate
      dayStartHour: 6,
      dayEndHour: 22,
      isDefault: true,
    },
    {
      name: 'Vattenfall Eldistribution (verifiera priser)',
      dayRateSekKw: 75.00,
      nightRateSekKw: 37.50,
      dayStartHour: 6,
      dayEndHour: 22,
      isDefault: true,
    },
    {
      name: 'E.ON Energidistribution (verifiera priser)',
      dayRateSekKw: 70.00,
      nightRateSekKw: 35.00,
      dayStartHour: 6,
      dayEndHour: 22,
      isDefault: true,
    },
  ];

  for (const natagare of DEFAULT_NATAGARE) {
    await prisma.natagare.upsert({
      where: { orgId_name: { orgId, name: natagare.name } },
      update: {},
      create: { ...natagare, orgId },
    });
  }
}
```

Note: Ellevio rates are verified (research). Vattenfall/E.ON are placeholders with "(verifiera priser)" in name per research recommendation.
  </action>
  <verify>Run `npx tsc --noEmit src/actions/natagare.ts` - no type errors</verify>
  <done>Natagare server actions created with full CRUD, validation, permission checks, tenant scoping, and seed function</done>
</task>

<task type="auto">
  <name>Task 2: Create natagare form and list components</name>
  <files>src/components/natagare/natagare-form.tsx, src/components/natagare/natagare-list.tsx</files>
  <action>
Create natagare components following existing patterns:

**src/components/natagare/natagare-form.tsx:**
```typescript
'use client';

interface NatagareFormProps {
  natagare?: {
    id: string;
    name: string;
    dayRateSekKw: number;
    nightRateSekKw: number;
    dayStartHour: number;
    dayEndHour: number;
    isDefault: boolean;
  };
}

export function NatagareForm({ natagare }: NatagareFormProps) {
  const isEditing = !!natagare;

  // Form fields:
  // - name: text input (disabled if isDefault)
  // - dayRateSekKw: number input (SEK/kW), step="0.01"
  // - nightRateSekKw: number input (SEK/kW), step="0.01"
  // - dayStartHour: select 0-23 (default 6)
  // - dayEndHour: select 0-23 (default 22)

  // Swedish labels:
  // - Namn = Name
  // - Dagtariff (SEK/kW) = Day rate
  // - Natttariff (SEK/kW) = Night rate
  // - Dagperiod startar (kl) = Day period starts
  // - Dagperiod slutar (kl) = Day period ends

  // Helper text: "Natttariff gallar fran slutet av dagperioden till borjan av nasta dag"
  // (Night rate applies from end of day period to start of next day)

  // If editing a default natagare, show info:
  // "Detta ar en forintalld natagare. Du kan andra priserna men inte ta bort den."
}
```

**src/components/natagare/natagare-list.tsx:**
```typescript
interface NatagareListProps {
  natagare: Array<{
    id: string;
    name: string;
    dayRateSekKw: number;
    nightRateSekKw: number;
    dayStartHour: number;
    dayEndHour: number;
    isDefault: boolean;
    isActive: boolean;
  }>;
  userRole: string;
}

export function NatagareList({ natagare, userRole }: NatagareListProps) {
  // Display as table or cards:
  // Columns: Namn, Dagtariff, Natttariff, Dagperiod, Atgarder
  //
  // Format time as "06:00-22:00"
  // Format rates as "81.25 SEK/kW"
  //
  // Actions column:
  // - Edit button (if NATAGARE_EDIT permission)
  // - Delete button (if NATAGARE_DELETE permission AND not isDefault)
  //
  // Show badge "Forintalld" for isDefault natagare
}
```

Use existing UI component patterns (Button, Card, etc.) from src/components/ui/.
  </action>
  <verify>Run `npx tsc --noEmit src/components/natagare/*.tsx` - no type errors</verify>
  <done>Natagare form and list components created with all required fields, Swedish labels, permission-gated actions</done>
</task>

<task type="auto">
  <name>Task 3: Create natagare pages and update seed</name>
  <files>src/app/(dashboard)/dashboard/natagare/page.tsx, src/app/(dashboard)/dashboard/natagare/new/page.tsx, src/app/(dashboard)/dashboard/natagare/[id]/page.tsx, prisma/seed.ts</files>
  <action>
Create natagare pages and integrate seeding:

**src/app/(dashboard)/dashboard/natagare/page.tsx:**
```typescript
import { auth } from '@/lib/auth/auth';
import { redirect } from 'next/navigation';
import { getNatagare } from '@/actions/natagare';
import { NatagareList } from '@/components/natagare/natagare-list';
import { hasPermission, PERMISSIONS, Role } from '@/lib/auth/permissions';
import Link from 'next/link';
import { Button } from '@/components/ui/button';

export default async function NatagarePage() {
  const session = await auth();
  if (!session?.user) redirect('/login');

  const role = session.user.role as Role;
  if (!hasPermission(role, PERMISSIONS.NATAGARE_VIEW)) {
    redirect('/dashboard');
  }

  const { natagare, error } = await getNatagare();
  if (error) return <div>Fel: {error}</div>;

  const canCreate = hasPermission(role, PERMISSIONS.NATAGARE_CREATE);

  return (
    <div>
      <header className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold">Natagare</h1>
          <p className="text-gray-600">Hantera effekttariffer for dina natoperatorer</p>
        </div>
        {canCreate && (
          <Link href="/dashboard/natagare/new">
            <Button>Lagg till natagare</Button>
          </Link>
        )}
      </header>
      <NatagareList natagare={natagare || []} userRole={role} />
    </div>
  );
}
```

**src/app/(dashboard)/dashboard/natagare/new/page.tsx:**
- Permission check: NATAGARE_CREATE
- Render NatagareForm in create mode
- Redirect unauthorized to /dashboard/natagare

**src/app/(dashboard)/dashboard/natagare/[id]/page.tsx:**
- Permission check: NATAGARE_EDIT
- Load natagare by ID using getNatagareById
- Render NatagareForm in edit mode
- Handle not found

**Update prisma/seed.ts:**
1. Import seedDefaultNatagare from @/actions/natagare (or duplicate the logic to avoid circular deps)
2. After creating organizations, call seedDefaultNatagare(org.id) for each org
3. Log seeding progress: "Seeding default natagare for org: {name}"

Example seed update:
```typescript
// After creating org
const org = await prisma.organization.upsert({...});

// Seed default natagare for this org
await seedDefaultNatagareForOrg(org.id);

async function seedDefaultNatagareForOrg(orgId: string) {
  const defaults = [
    { name: 'Ellevio', dayRateSekKw: 81.25, nightRateSekKw: 40.625, dayStartHour: 6, dayEndHour: 22, isDefault: true },
    { name: 'Vattenfall Eldistribution (verifiera priser)', dayRateSekKw: 75.00, nightRateSekKw: 37.50, dayStartHour: 6, dayEndHour: 22, isDefault: true },
    { name: 'E.ON Energidistribution (verifiera priser)', dayRateSekKw: 70.00, nightRateSekKw: 35.00, dayStartHour: 6, dayEndHour: 22, isDefault: true },
  ];

  for (const n of defaults) {
    await prisma.natagare.upsert({
      where: { orgId_name: { orgId, name: n.name } },
      update: {},
      create: { ...n, orgId },
    });
  }
}
```
  </action>
  <verify>Run `npm run build` and `npx prisma db seed` - both should complete without errors</verify>
  <done>Natagare pages created and seeding integrated, default natagare appear for all orgs</done>
</task>

</tasks>

<verification>
1. Reset and seed database: `npx prisma db push --force-reset && npx prisma db seed`
2. Start dev server: `npm run dev`
3. Log in as Org Admin
4. Navigate to /dashboard/natagare
5. Verify Ellevio and placeholder natagare appear with correct rates
6. Create a new natagare (custom grid operator)
7. Edit rates for Ellevio, verify changes save
8. Try to delete Ellevio - should show error (default natagare)
9. Delete the custom natagare - should succeed
10. Log in as Closer - verify can view but not create/edit/delete

```bash
# Verify seeding worked
npx prisma studio
# Check Natagare table has 3 records per org with isDefault=true
```
</verification>

<success_criteria>
1. NATA-01: Org Admin can create natagare records
2. NATA-02: Natagare includes: name, day rate, night rate, day start/end hours
3. NATA-03: Org Admin can edit and delete natagare records
4. NATA-04: Natagare scoped to organization (tenant client enforces)
5. NATA-05: Default natagare (Ellevio verified, Vattenfall/E.ON placeholders) seeded for each org
6. Default natagare cannot be deleted (only rates can be edited)
7. Closer can view natagare but cannot create/edit/delete
8. Forms use Swedish labels and sensible defaults (6-22 day hours)
9. Time window clearly shows "06:00-22:00" format
</success_criteria>

<output>
After completion, create `.planning/phases/02-reference-data/02-03-SUMMARY.md`
</output>
