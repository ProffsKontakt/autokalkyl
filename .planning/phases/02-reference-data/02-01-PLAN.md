---
phase: 02-reference-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/auth/permissions.ts
  - src/lib/db/tenant-client.ts
autonomous: true

must_haves:
  truths:
    - "Database can store battery brands and configurations"
    - "Database can store natagare with day/night rates"
    - "Database can store hourly electricity prices per elomrade"
    - "Permissions exist for battery, natagare, and electricity price management"
    - "Tenant client scopes battery and natagare queries by orgId"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "BatteryBrand, BatteryConfig, Natagare, ElectricityPrice, ElectricityPriceQuarterly models"
      contains: "model BatteryBrand"
    - path: "src/lib/auth/permissions.ts"
      provides: "Battery, Natagare, Electricity permissions"
      contains: "BATTERY_CREATE"
    - path: "src/lib/db/tenant-client.ts"
      provides: "Tenant scoping for new models"
      contains: "batteryBrand"
  key_links:
    - from: "prisma/schema.prisma"
      to: "Organization model"
      via: "Foreign key relations"
      pattern: "organization Organization.*@relation"
    - from: "src/lib/db/tenant-client.ts"
      to: "prisma/schema.prisma"
      via: "Model extensions matching schema"
      pattern: "batteryBrand.*\\$allOperations"
---

<objective>
Create the database schema and permissions foundation for Phase 2 reference data.

Purpose: All battery, natagare, and electricity pricing features require these models and permissions to exist before any CRUD operations can be built.

Output: Updated Prisma schema with new models, extended permissions system, and tenant-scoped client for new models.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reference-data/02-RESEARCH.md
@prisma/schema.prisma
@src/lib/auth/permissions.ts
@src/lib/db/tenant-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema with battery, natagare, and electricity models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following models to prisma/schema.prisma:

1. **Elomrade enum** (before models):
```prisma
enum Elomrade {
  SE1
  SE2
  SE3
  SE4
}
```

2. **BatteryBrand model**:
- id (cuid), name (String), logoUrl (String?), orgId (String)
- createdAt, updatedAt timestamps
- Relation to Organization (onDelete: Cascade)
- Relation to BatteryConfig[] (configs)
- @@unique([orgId, name]) - no duplicate brand names per org
- @@index([orgId])

3. **BatteryConfig model**:
- id (cuid), name (String), brandId (String), orgId (String)
- Core specs: capacityKwh, maxDischargeKw, maxChargeKw (Decimal 10,2)
- Efficiencies: chargeEfficiency, dischargeEfficiency (Decimal 5,2) - stored as percentage (95.00)
- Lifecycle: warrantyYears (Int), guaranteedCycles (Int), degradationPerYear (Decimal 5,2)
- Pricing: costPrice (Decimal 10,2) - in SEK
- Flags: isExtensionCabinet (Boolean false), isNewStack (Boolean true), isActive (Boolean true)
- Timestamps
- Relations to BatteryBrand and Organization (both onDelete: Cascade)
- @@unique([orgId, brandId, name]) - no duplicate config names per brand per org
- @@index([orgId]), @@index([brandId])

4. **Natagare model**:
- id (cuid), name (String)
- Rates: dayRateSekKw, nightRateSekKw (Decimal 10,4) - e.g., 81.2500
- Time windows: dayStartHour, dayEndHour (Int, default 6 and 22)
- orgId (String), isDefault (Boolean false), isActive (Boolean true)
- Timestamps
- Relation to Organization (onDelete: Cascade)
- @@unique([orgId, name])
- @@index([orgId])

5. **ElectricityPrice model** (NOT tenant scoped - global data):
- id (cuid), elomrade (Elomrade), date (DateTime @db.Date), hour (Int 0-23)
- priceOre (Decimal 10,2) - price in ore/kWh (e.g., 142.50)
- createdAt timestamp
- @@unique([elomrade, date, hour])
- @@index([elomrade, date]), @@index([date])

6. **ElectricityPriceQuarterly model** (NOT tenant scoped):
- id (cuid), elomrade (Elomrade), year (Int), quarter (Int 1-4)
- avgDayPriceOre, avgNightPriceOre, avgPriceOre (Decimal 10,2)
- Timestamps
- @@unique([elomrade, year, quarter])
- @@index([elomrade])

7. **Update Organization model** - add relations:
```prisma
batteryBrands  BatteryBrand[]
batteryConfigs BatteryConfig[]
natagare       Natagare[]
```

Use Decimal types for all financial/percentage values per research recommendations.
  </action>
  <verify>Run `npx prisma validate` - should exit with code 0 and no errors</verify>
  <done>Schema validates successfully with all new models, enums, relations, and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add permissions for battery, natagare, and electricity management</name>
  <files>src/lib/auth/permissions.ts</files>
  <action>
Update src/lib/auth/permissions.ts:

1. Add to PERMISSIONS object:
```typescript
// Battery permissions
BATTERY_CREATE: 'battery:create',
BATTERY_EDIT: 'battery:edit',
BATTERY_DELETE: 'battery:delete',
BATTERY_VIEW: 'battery:view',

// Natagare permissions
NATAGARE_CREATE: 'natagare:create',
NATAGARE_EDIT: 'natagare:edit',
NATAGARE_DELETE: 'natagare:delete',
NATAGARE_VIEW: 'natagare:view',

// Electricity pricing permissions (read-only for non-admins)
ELPRICES_VIEW: 'elprices:view',
ELPRICES_MANAGE: 'elprices:manage', // Super Admin only - manual entry/fetch
```

2. Update ROLE_PERMISSIONS:
- SUPER_ADMIN: Already has all permissions (Object.values(PERMISSIONS))
- ORG_ADMIN: Add BATTERY_*, NATAGARE_*, ELPRICES_VIEW
- CLOSER: Add BATTERY_VIEW, NATAGARE_VIEW, ELPRICES_VIEW

This follows the requirement pattern:
- BATT-05, NATA-03: Org Admin can create/edit/delete
- BATT-06, NATA-04: Scoped to organization (Closers can view, not edit)
- ELEC-04: Closers need to view electricity prices
  </action>
  <verify>Run `npx tsc --noEmit src/lib/auth/permissions.ts` - no type errors</verify>
  <done>Permissions file includes all battery, natagare, and electricity permissions with correct role mappings</done>
</task>

<task type="auto">
  <name>Task 3: Extend tenant client with battery and natagare scoping</name>
  <files>src/lib/db/tenant-client.ts</files>
  <action>
Update src/lib/db/tenant-client.ts createTenantClient function to add tenant scoping for new models:

1. Add batteryBrand scoping (same pattern as user):
```typescript
batteryBrand: {
  async $allOperations({ args, query, operation }) {
    // Read operations: filter by orgId
    if (operation === 'findMany' || operation === 'findFirst' || operation === 'count') {
      args.where = { ...args.where, orgId };
    }
    // Create operations: inject orgId
    if (operation === 'create') {
      const data = args.data as Record<string, unknown>;
      (args as { data: Record<string, unknown> }).data = { ...data, orgId };
    }
    // Update/Delete operations: ensure own org's data
    if (operation === 'update' || operation === 'updateMany') {
      args.where = { ...args.where, orgId };
    }
    if (operation === 'delete' || operation === 'deleteMany') {
      args.where = { ...args.where, orgId };
    }
    return query(args);
  },
},
```

2. Add batteryConfig scoping (same pattern)

3. Add natagare scoping (same pattern)

4. Update the NOTE comment to clarify:
- BatteryBrand, BatteryConfig, Natagare are tenant-scoped
- ElectricityPrice, ElectricityPriceQuarterly are NOT tenant-scoped (global data)

This ensures BATT-06 and NATA-04 (org scoping) are enforced at the database access layer.
  </action>
  <verify>Run `npx tsc --noEmit src/lib/db/tenant-client.ts` - no type errors</verify>
  <done>Tenant client includes scoping extensions for batteryBrand, batteryConfig, and natagare models</done>
</task>

</tasks>

<verification>
Run the following commands to verify schema and code:

```bash
# Validate Prisma schema
npx prisma validate

# Type check updated files
npx tsc --noEmit

# Generate Prisma client (creates types for new models)
npx prisma generate

# Apply schema to database
npx prisma db push
```

All commands should complete without errors.
</verification>

<success_criteria>
1. Prisma schema validates with all new models (BatteryBrand, BatteryConfig, Natagare, ElectricityPrice, ElectricityPriceQuarterly)
2. Elomrade enum exists with SE1-SE4 values
3. Organization model has relations to new battery and natagare models
4. Permissions file exports battery, natagare, and electricity permissions
5. Role permissions correctly assign: ORG_ADMIN full CRUD, CLOSER view-only
6. Tenant client auto-scopes batteryBrand, batteryConfig, natagare by orgId
7. Database schema pushed successfully (no migration errors)
8. TypeScript compilation passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-reference-data/02-01-SUMMARY.md`
</output>
