---
phase: 07-calculation-transparency
plan: 04
type: execute
wave: 4
depends_on: ["07-03"]
files_modified:
  - src/actions/share.ts
  - src/actions/calculations.ts
  - src/components/calculations/results-summary.tsx
autonomous: false

must_haves:
  truths:
    - "Salesperson can override any savings total from the results view"
    - "Overrides are saved to database and persist"
    - "Overrides sync to shared links (visible on next load)"
    - "Prospects see adjusted values as if they were calculated (OVRD-04)"
  artifacts:
    - path: "src/actions/calculations.ts"
      provides: "saveOverrides server action"
      contains: "saveOverrides"
    - path: "src/actions/share.ts"
      provides: "Override application in getPublicCalculation"
      contains: "overrides"
    - path: "src/components/calculations/results-summary.tsx"
      provides: "OverridableValue integration for savings totals"
      contains: "OverridableValue"
  key_links:
    - from: "results-summary.tsx"
      to: "saveOverrides action"
      via: "calls action when override changes"
      pattern: "saveOverrides"
    - from: "getPublicCalculation"
      to: "overrides"
      via: "applies overrides before returning public data"
      pattern: "overrides.*\\?"
---

<objective>
Integrate overrides into the admin results view and public data pipeline, enabling salespeople to adjust values that sync to shared links.

Purpose: OVRD-03 requires overrides to sync to shared links, and OVRD-04 requires prospects to see overrides as calculated values. This connects the override infrastructure to the real data flow.

Output: Server action to save overrides, updated share action to apply overrides, and results view with inline override editing.
</objective>

<execution_context>
@/Users/julian.nordgren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian.nordgren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-calculation-transparency/07-RESEARCH.md
@.planning/phases/07-calculation-transparency/07-03-PLAN.md

# Files to modify
@src/actions/share.ts
@src/actions/calculations.ts
@src/components/calculations/results-summary.tsx

# Override infrastructure
@src/components/calculations/overridable-value.tsx
@src/lib/share/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create saveOverrides server action</name>
  <files>src/actions/calculations.ts</files>
  <action>
Add a server action to save overrides to the database.

Add this action (import CalculationOverrides from share/types):

```typescript
// =============================================================================
// SAVE OVERRIDES (Phase 7 - OVRD-03)
// =============================================================================

/**
 * Save manual overrides for a calculation.
 * Overrides replace calculated values in shared links.
 *
 * IMPORTANT: Only closers can override their own calculations,
 * admins can override any calculation in their org.
 */
export async function saveOverrides(
  calculationId: string,
  overrides: CalculationOverrides
): Promise<{ success?: boolean; error?: string }> {
  const session = await auth()
  if (!session?.user) {
    return { error: 'Inte inloggad' }
  }

  const role = session.user.role as Role
  if (!hasPermission(role, PERMISSIONS.CALCULATION_EDIT)) {
    return { error: 'Saknar beh√∂righet' }
  }

  const tenantDb = session.user.orgId
    ? createTenantClient(session.user.orgId)
    : prisma

  const calculation = await tenantDb.calculation.findUnique({
    where: { id: calculationId },
  })

  if (!calculation) {
    return { error: 'Kalkylen hittades inte' }
  }

  // Closers can only override their own calculations
  if (role === 'CLOSER' && calculation.createdBy !== session.user.id) {
    return { error: 'Du kan bara andra dina egna kalkyler' }
  }

  // Clean overrides: remove null values to keep DB clean
  const cleanedOverrides: Record<string, number> = {}
  for (const [key, value] of Object.entries(overrides)) {
    if (value !== null && value !== undefined) {
      cleanedOverrides[key] = value
    }
  }

  // If all overrides are null, set to null (no overrides)
  const finalOverrides = Object.keys(cleanedOverrides).length > 0
    ? cleanedOverrides
    : null

  await tenantDb.calculation.update({
    where: { id: calculationId },
    data: { overrides: finalOverrides },
  })

  return { success: true }
}

/**
 * Clear all overrides for a calculation.
 */
export async function clearOverrides(
  calculationId: string
): Promise<{ success?: boolean; error?: string }> {
  return saveOverrides(calculationId, {
    spotprisSavingsSek: null,
    stodtjansterIncomeSek: null,
    effectTariffSavingsSek: null,
    cyclesPerDay: null,
    peakShavingPercent: null,
    postCampaignRate: null,
    spreadOre: null,
    tariffRateSekKw: null,
  })
}
```

Add necessary imports: CalculationOverrides from share/types.
  </action>
  <verify>
src/actions/calculations.ts contains saveOverrides function
src/actions/calculations.ts contains clearOverrides function
pnpm tsc --noEmit passes
  </verify>
  <done>
Server actions for saving and clearing overrides implemented with proper RBAC.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply overrides in getPublicCalculation</name>
  <files>src/actions/share.ts</files>
  <action>
Update getPublicCalculation to apply overrides before returning public data.

In getPublicCalculation, after fetching the calculation:

1. Extract overrides from calculation:
```typescript
const overrides = calculation.overrides as CalculationOverrides | null
```

2. When building resultsPublic, apply overrides:
```typescript
// Apply overrides to results (OVRD-03, OVRD-04)
// Prospects see overridden values as if calculated
resultsPublic = {
  totalPriceExVat: r.totalPriceExVat ?? batteries[0]?.totalPriceExVat,
  totalPriceIncVat: r.totalIncVatSek ?? batteries[0]?.totalPriceIncVat,
  costAfterGronTeknik: r.costAfterGronTeknikSek ?? batteries[0]?.costAfterGronTeknik,
  effectiveCapacityKwh: r.effectiveCapacityPerCycleKwh,
  annualEnergyKwh: r.energyFromBatteryPerYearKwh,
  // Apply savings overrides (OVRD-01)
  spotprisSavings: overrides?.spotprisSavingsSek ?? r.spotprisSavingsSek,
  effectTariffSavings: overrides?.effectTariffSavingsSek ?? r.effectTariffSavingsSek,
  gridServicesIncome: overrides?.stodtjansterIncomeSek ?? r.gridServicesIncomeSek,
  // Recalculate total if any savings are overridden
  totalAnnualSavings: (overrides?.spotprisSavingsSek ?? r.spotprisSavingsSek) +
                      (overrides?.effectTariffSavingsSek ?? r.effectTariffSavingsSek) +
                      (overrides?.stodtjansterIncomeSek ?? r.gridServicesIncomeSek),
  // Recalculate payback if total changed
  paybackYears: /* recalculate based on new total */,
  roi10Year: r.roi10YearPercent,
  roi15Year: r.roi15YearPercent,
}
```

3. When building breakdown data (from Plan 02), also apply input overrides:
```typescript
const effectiveInputs = {
  ...inputs,
  cyclesPerDay: overrides?.cyclesPerDay ?? inputs.cyclesPerDay,
  peakShavingPercent: overrides?.peakShavingPercent ?? inputs.peakShavingPercent,
  spreadOre: overrides?.spreadOre ?? inputs.spreadOre,
  tariffRateSekKw: overrides?.tariffRateSekKw ?? inputs.tariffRateSekKw,
  postCampaignRatePerKwYear: overrides?.postCampaignRate ?? inputs.postCampaignRatePerKwYear,
}
```

4. Use effectiveInputs when calling buildPublicBreakdown.

CRITICAL: The overrides object itself is NEVER returned to the public view. Only the already-applied values are sent. This satisfies OVRD-04.

Import CalculationOverrides from types.
  </action>
  <verify>
getPublicCalculation applies overrides when building resultsPublic
Overrides object is not included in returned data
pnpm tsc --noEmit passes
  </verify>
  <done>
Public calculation fetch applies overrides before returning, so prospects see adjusted values as calculated. Overrides themselves are hidden.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add override UI to results summary</name>
  <files>src/components/calculations/results-summary.tsx</files>
  <action>
Integrate OverridableValue component into the admin results view.

First, find the component that displays savings totals in the admin panel (likely results-summary.tsx or similar in components/calculations/).

If results-summary.tsx doesn't exist, check for:
- calculation-results.tsx
- results-display.tsx
- Or the component used in the calculation detail page

Update the component to:

1. Import:
```typescript
import { OverridableValue } from '@/components/calculations/overridable-value'
import { saveOverrides } from '@/actions/calculations'
import type { CalculationOverrides } from '@/lib/share/types'
```

2. Add state for current overrides (fetch from calculation or parent):
```typescript
const [overrides, setOverrides] = useState<CalculationOverrides>({})
const [isSaving, setIsSaving] = useState(false)
```

3. Create handler:
```typescript
const handleOverride = async (
  key: keyof CalculationOverrides,
  value: number | null
) => {
  const newOverrides = { ...overrides, [key]: value }
  setOverrides(newOverrides)
  setIsSaving(true)

  const result = await saveOverrides(calculationId, newOverrides)
  if (result.error) {
    toast.error(result.error)
    // Revert on error
    setOverrides(overrides)
  } else {
    toast.success('Varde uppdaterat')
  }
  setIsSaving(false)
}
```

4. Replace static savings displays with OverridableValue:
```tsx
{/* Spotprisoptimering - with override */}
<OverridableValue
  label="Spotprisoptimering"
  calculatedValue={results.spotprisSavingsSek}
  overrideValue={overrides.spotprisSavingsSek ?? null}
  onOverride={(v) => handleOverride('spotprisSavingsSek', v)}
  suffix=" kr/ar"
/>

{/* Effektavgift - with override */}
<OverridableValue
  label="Effektavgift"
  calculatedValue={results.effectTariffSavingsSek}
  overrideValue={overrides.effectTariffSavingsSek ?? null}
  onOverride={(v) => handleOverride('effectTariffSavingsSek', v)}
  suffix=" kr/ar"
/>

{/* Stodtjanster - with override */}
<OverridableValue
  label="Stodtjanster"
  calculatedValue={results.gridServicesIncomeSek}
  overrideValue={overrides.stodtjansterIncomeSek ?? null}
  onOverride={(v) => handleOverride('stodtjansterIncomeSek', v)}
  suffix=" kr/ar"
/>
```

5. Add visual indicator when any override is active:
```tsx
{Object.values(overrides).some(v => v !== null) && (
  <div className="text-sm text-blue-600 dark:text-blue-400 flex items-center gap-2">
    <span>Manuella justeringar aktiva</span>
    <button
      onClick={() => clearOverrides(calculationId)}
      className="underline"
    >
      Aterstall alla
    </button>
  </div>
)}
```

The edit pencil icon should only appear on hover (already in OverridableValue).
Only show OverridableValue for admin/closer views, not public view.
  </action>
  <verify>
Results component uses OverridableValue for savings totals
Overrides are saved via saveOverrides action
pnpm tsc --noEmit passes
  </verify>
  <done>
Admin results view allows inline editing of savings values with immediate save to database.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete override system with:
    1. Database storage for overrides
    2. Server actions for save/clear
    3. Public view applies overrides invisibly
    4. Admin view has inline override editing
  </what-built>
  <how-to-verify>
    1. Run `pnpm prisma db push` to apply schema changes
    2. Start dev server: `pnpm dev`
    3. Login as a closer and open an existing calculation
    4. In results view, hover over a savings value - edit icon should appear
    5. Click to edit, enter new value, press Enter
    6. Toast should show "Varde uppdaterat"
    7. Open the shared link for this calculation in incognito
    8. Verify the prospect view shows the overridden value (not the original calculated value)
    9. Verify the breakdown still shows calculation inputs (not marked as overridden)
    10. Back in admin view, hover and click reset icon
    11. Verify value reverts to calculated
    12. Refresh shared link - should show original calculated value again
  </how-to-verify>
  <resume-signal>Type "approved" if override flow works end-to-end, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. pnpm prisma db push applies schema without errors
2. pnpm tsc --noEmit passes
3. pnpm build passes
4. Override saves to database and persists across page loads
5. Shared link shows overridden values
6. Prospect cannot tell values were overridden
7. Admin can reset overrides
</verification>

<success_criteria>
- saveOverrides and clearOverrides actions work with RBAC
- getPublicCalculation applies overrides before filtering to public type
- Overrides object is NOT returned to public view (OVRD-04)
- Results view has inline override editing for all three savings categories
- Changes persist and sync to shared links (OVRD-03)
- TypeScript compiles and build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-calculation-transparency/07-04-SUMMARY.md`
</output>
