---
phase: 07-calculation-transparency
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/share/types.ts
  - src/actions/share.ts
  - src/components/public/public-results-view.tsx
autonomous: true

must_haves:
  truths:
    - "Prospect view shows expandable breakdowns for each savings category"
    - "Breakdown data is included when fetching public calculations"
    - "Breakdowns show the same calculation inputs used to derive totals"
    - "Margins, org cuts, and internal data remain hidden from prospects"
  artifacts:
    - path: "src/lib/share/types.ts"
      provides: "CalculationBreakdownPublic type, extended CalculationResultsPublicWithBreakdown"
      contains: "CalculationBreakdownPublic"
    - path: "src/actions/share.ts"
      provides: "buildPublicBreakdown function to construct breakdown data"
      contains: "buildPublicBreakdown"
    - path: "src/components/public/public-results-view.tsx"
      provides: "Integrated breakdown components in public view"
      contains: "SpotprisBreakdown"
  key_links:
    - from: "src/actions/share.ts"
      to: "CalculationBreakdownPublic"
      via: "buildPublicBreakdown returns this type"
      pattern: "CalculationBreakdownPublic"
    - from: "src/components/public/public-results-view.tsx"
      to: "breakdown components"
      via: "renders if breakdown data exists"
      pattern: "import.*SpotprisBreakdown"
---

<objective>
Extend the public data pipeline to include breakdown data and integrate breakdown components into the public results view.

Purpose: TRANS-02 requires prospect view to show breakdowns. This connects the breakdown components from Plan 01 to the public view, ensuring calculation transparency while maintaining privacy (TRANS-04 - no margins).

Output: Extended types in share/types.ts, breakdown data construction in actions/share.ts, and updated PublicResultsView with breakdown sections.
</objective>

<execution_context>
@/Users/julian.nordgren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian.nordgren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-calculation-transparency/07-RESEARCH.md
@.planning/phases/07-calculation-transparency/07-01-PLAN.md

# Files to modify
@src/lib/share/types.ts
@src/actions/share.ts
@src/components/public/public-results-view.tsx

# Calculation structure
@src/lib/calculations/engine.ts
@src/lib/calculations/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types with breakdown data structures</name>
  <files>src/lib/share/types.ts</files>
  <action>
Add breakdown type definitions to the share types file.

Add these new types:

```typescript
/**
 * Breakdown data for public transparency view.
 * Includes calculation inputs for each savings category.
 * EXCLUDES: margins, org cuts, cost prices (TRANS-04)
 */
export interface CalculationBreakdownPublic {
  // Spotpris breakdown (SPOT-04)
  spotpris: {
    capacityKwh: number
    cyclesPerDay: number
    efficiency: number         // 0.8 for 80%
    spreadOre: number          // ~100 ore default
    annualSavingsSek: number
  }
  // Effektavgift breakdown (PEAK-04)
  effekt: {
    currentPeakKw: number
    peakShavingPercent: number
    actualPeakShavingKw: number
    newPeakKw: number
    tariffRateSekKw: number
    annualSavingsSek: number
    isConstrained: boolean
  }
  // Stodtjanster breakdown (GRID-05)
  stodtjanster: {
    elomrade: string
    isEmaldoBattery: boolean
    batteryCapacityKw: number
    guaranteedMonthlySek?: number
    guaranteedAnnualSek?: number
    postCampaignRatePerKwYear?: number
    postCampaignAnnualSek?: number
    displayedAnnualSek: number
  }
}

/**
 * Extended CalculationResultsPublic with breakdown support.
 */
export interface CalculationResultsPublicWithBreakdown extends CalculationResultsPublic {
  breakdown?: CalculationBreakdownPublic
}
```

Update PublicCalculationData.calculation.results type to use CalculationResultsPublicWithBreakdown instead of CalculationResultsPublic.

NOTE: Do NOT add marginSek, costPriceTotal, or installerCut to any public type. These must remain server-side only (TRANS-04).
  </action>
  <verify>
src/lib/share/types.ts contains CalculationBreakdownPublic interface
src/lib/share/types.ts contains CalculationResultsPublicWithBreakdown interface
pnpm tsc --noEmit passes
  </verify>
  <done>
Share types extended with breakdown data structure that explicitly excludes sensitive business data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build breakdown data in share action</name>
  <files>src/actions/share.ts</files>
  <action>
Add a function to construct breakdown data from calculation results and inputs.

Add this function before getPublicCalculation:

```typescript
/**
 * Build public breakdown data from calculation results and stored inputs.
 * Filters out sensitive business data (TRANS-04).
 */
function buildPublicBreakdown(
  results: Record<string, number | undefined>,
  inputs: {
    capacityKwh: number
    efficiency: number
    cyclesPerDay: number
    spreadOre: number
    currentPeakKw: number
    peakShavingPercent: number
    tariffRateSekKw: number
    elomrade: string
    isEmaldoBattery: boolean
    batteryCapacityKw: number
    postCampaignRatePerKwYear: number
  }
): CalculationBreakdownPublic {
  const targetPeakShaving = inputs.currentPeakKw * (inputs.peakShavingPercent / 100)
  const actualPeakShaving = results.peakShavingKw ?? 0

  return {
    spotpris: {
      capacityKwh: inputs.capacityKwh,
      cyclesPerDay: inputs.cyclesPerDay,
      efficiency: inputs.efficiency,
      spreadOre: inputs.spreadOre,
      annualSavingsSek: results.spotprisSavingsSek ?? 0,
    },
    effekt: {
      currentPeakKw: inputs.currentPeakKw,
      peakShavingPercent: inputs.peakShavingPercent,
      actualPeakShavingKw: actualPeakShaving,
      newPeakKw: inputs.currentPeakKw - actualPeakShaving,
      tariffRateSekKw: inputs.tariffRateSekKw,
      annualSavingsSek: results.effectTariffSavingsSek ?? 0,
      isConstrained: actualPeakShaving < targetPeakShaving * 0.99, // 1% tolerance
    },
    stodtjanster: {
      elomrade: inputs.elomrade,
      isEmaldoBattery: inputs.isEmaldoBattery,
      batteryCapacityKw: inputs.batteryCapacityKw,
      guaranteedMonthlySek: inputs.isEmaldoBattery && results.stodtjansterGuaranteedSek
        ? results.stodtjansterGuaranteedSek / 36  // 36-month campaign
        : undefined,
      guaranteedAnnualSek: inputs.isEmaldoBattery && results.stodtjansterGuaranteedSek
        ? results.stodtjansterGuaranteedSek / 3   // 3 years
        : undefined,
      postCampaignRatePerKwYear: inputs.postCampaignRatePerKwYear,
      postCampaignAnnualSek: results.stodtjansterPostCampaignSek
        ? results.stodtjansterPostCampaignSek / 7  // 10 years - 3 campaign years
        : undefined,
      displayedAnnualSek: results.gridServicesIncomeSek ?? 0,
    },
  }
  // NOTE: marginSek, costPriceTotal, installerCut are NOT included (TRANS-04)
}
```

Import CalculationBreakdownPublic from types.

In getPublicCalculation, after building resultsPublic:
1. Extract input values from calculation data:
   - capacityKwh from batteries[0]
   - efficiency from batteries[0] (chargeEfficiency * dischargeEfficiency)
   - cyclesPerDay from results.cyclesPerDay or default 1
   - spreadOre from results.spreadOre or default 100
   - currentPeakKw from results or estimate from consumption
   - peakShavingPercent from results or default 50
   - tariffRateSekKw from natagare.dayRateSekKw
   - elomrade from calculation.elomrade
   - isEmaldoBattery: check if brand name includes "Emaldo"
   - batteryCapacityKw from batteries[0].maxDischargeKw
   - postCampaignRatePerKwYear from results or default 500

2. Call buildPublicBreakdown with results and inputs
3. Add breakdown to resultsPublic object

Handle case where results don't have breakdown inputs (older calculations) by using sensible defaults.
  </action>
  <verify>
src/actions/share.ts contains buildPublicBreakdown function
getPublicCalculation returns results with breakdown field
pnpm tsc --noEmit passes
  </verify>
  <done>
Public calculation fetch includes breakdown data constructed from stored results and inputs, with sensitive data excluded.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate breakdowns into public results view</name>
  <files>src/components/public/public-results-view.tsx</files>
  <action>
Update PublicResultsView to display breakdown components from Plan 01.

Changes:
1. Update import to use CalculationResultsPublicWithBreakdown
2. Import breakdown components:
   ```typescript
   import { SpotprisBreakdown } from '@/components/calculations/breakdowns/spotpris-breakdown'
   import { EffektBreakdown } from '@/components/calculations/breakdowns/effekt-breakdown'
   import { StodtjansterBreakdown } from '@/components/calculations/breakdowns/stodtjanster-breakdown'
   ```
3. Update props type: results: CalculationResultsPublicWithBreakdown

4. After the existing "Detailed breakdown" section (showDetailedBreakdown), add a new section for formula breakdowns:

```tsx
{/* TRANS-01: Expandable formula breakdowns */}
{results.breakdown && (
  <section className="space-y-4">
    <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
      Sa har vi raknat
    </h3>

    {/* SPOT-04: Spotpris breakdown */}
    {results.spotprisSavings > 0 && (
      <SpotprisBreakdown
        capacityKwh={results.breakdown.spotpris.capacityKwh}
        cyclesPerDay={results.breakdown.spotpris.cyclesPerDay}
        efficiency={results.breakdown.spotpris.efficiency}
        spreadOre={results.breakdown.spotpris.spreadOre}
        annualSavingsSek={results.breakdown.spotpris.annualSavingsSek}
      />
    )}

    {/* PEAK-04: Effektavgift breakdown */}
    {results.effectTariffSavings > 0 && (
      <EffektBreakdown
        currentPeakKw={results.breakdown.effekt.currentPeakKw}
        peakShavingPercent={results.breakdown.effekt.peakShavingPercent}
        actualPeakShavingKw={results.breakdown.effekt.actualPeakShavingKw}
        newPeakKw={results.breakdown.effekt.newPeakKw}
        tariffRateSekKw={results.breakdown.effekt.tariffRateSekKw}
        annualSavingsSek={results.breakdown.effekt.annualSavingsSek}
        isConstrained={results.breakdown.effekt.isConstrained}
      />
    )}

    {/* GRID-05: Stodtjanster breakdown */}
    {results.gridServicesIncome > 0 && (
      <StodtjansterBreakdown
        elomrade={results.breakdown.stodtjanster.elomrade}
        isEmaldoBattery={results.breakdown.stodtjanster.isEmaldoBattery}
        batteryCapacityKw={results.breakdown.stodtjanster.batteryCapacityKw}
        guaranteedMonthlySek={results.breakdown.stodtjanster.guaranteedMonthlySek}
        guaranteedAnnualSek={results.breakdown.stodtjanster.guaranteedAnnualSek}
        postCampaignRatePerKwYear={results.breakdown.stodtjanster.postCampaignRatePerKwYear}
        postCampaignAnnualSek={results.breakdown.stodtjanster.postCampaignAnnualSek}
        displayedAnnualSek={results.breakdown.stodtjanster.displayedAnnualSek}
      />
    )}
  </section>
)}
```

Place this section AFTER the existing savings breakdown section and BEFORE the ROI timeline chart.

The existing "Visa detaljer" toggle (showDetailedBreakdown) should remain - it shows simple explanations. The new breakdown section shows the actual formulas.

Consider removing the "Visa detaljer" toggle entirely since the new breakdowns are more informative. The simple explanations inside the toggle are now redundant.
  </action>
  <verify>
PublicResultsView imports all three breakdown components
Renders breakdown section when results.breakdown exists
pnpm tsc --noEmit passes
pnpm build passes (catches any SSR issues)
  </verify>
  <done>
Public results view displays expandable formula breakdowns for each savings category, showing prospects exactly how their savings numbers are calculated.
  </done>
</task>

</tasks>

<verification>
1. pnpm tsc --noEmit passes
2. pnpm build passes (no SSR/hydration issues)
3. CalculationBreakdownPublic type does NOT include margin, costPrice, or installerCut
4. PublicResultsView renders breakdown components when data exists
5. Older calculations (without breakdown data) still render without errors
</verification>

<success_criteria>
- Types extended with CalculationBreakdownPublic and CalculationResultsPublicWithBreakdown
- getPublicCalculation returns breakdown data alongside results
- PublicResultsView displays three expandable breakdown sections
- Breakdowns only show when results.breakdown exists (backwards compatibility)
- No sensitive data (margins, costs) exposed in public types
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-calculation-transparency/07-02-SUMMARY.md`
</output>
