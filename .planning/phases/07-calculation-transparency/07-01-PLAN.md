---
phase: 07-calculation-transparency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/calculations/breakdowns/expandable-breakdown.tsx
  - src/components/calculations/breakdowns/spotpris-breakdown.tsx
  - src/components/calculations/breakdowns/effekt-breakdown.tsx
  - src/components/calculations/breakdowns/stodtjanster-breakdown.tsx
autonomous: true

must_haves:
  truths:
    - "Each breakdown component renders a collapsible section with calculation details"
    - "Spotpris breakdown shows capacity, cycles, efficiency, spread -> annual savings"
    - "Effekt breakdown shows peak, reduction %, actual kW cut, tariff rate -> annual savings"
    - "Stodtjanster breakdown shows zone-based Emaldo income or manual rate"
  artifacts:
    - path: "src/components/calculations/breakdowns/expandable-breakdown.tsx"
      provides: "Reusable expand/collapse wrapper with Framer Motion"
      exports: ["ExpandableBreakdown"]
    - path: "src/components/calculations/breakdowns/spotpris-breakdown.tsx"
      provides: "Spotpris calculation transparency"
      exports: ["SpotprisBreakdown"]
    - path: "src/components/calculations/breakdowns/effekt-breakdown.tsx"
      provides: "Effektavgift calculation transparency"
      exports: ["EffektBreakdown"]
    - path: "src/components/calculations/breakdowns/stodtjanster-breakdown.tsx"
      provides: "Stodtjanster calculation transparency"
      exports: ["StodtjansterBreakdown"]
  key_links:
    - from: "All breakdown components"
      to: "ExpandableBreakdown"
      via: "import and composition"
      pattern: "import.*ExpandableBreakdown"
---

<objective>
Create reusable breakdown components that display calculation formula details for each savings category.

Purpose: TRANS-01 requires each savings category to have expandable breakdown showing how values are calculated. These components will be used in the public results view to provide transparency.

Output: Four components in src/components/calculations/breakdowns/ - one wrapper (ExpandableBreakdown) and three category-specific breakdowns (Spotpris, Effekt, Stodtjanster).
</objective>

<execution_context>
@/Users/julian.nordgren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian.nordgren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-calculation-transparency/07-RESEARCH.md

# Phase 6 outputs - these provide the calculation values used in breakdowns
@.planning/phases/06-calculation-engine/06-01-SUMMARY.md
@.planning/phases/06-calculation-engine/06-02-SUMMARY.md

# Existing patterns
@src/components/calculations/controls/stodtjanster-input.tsx
@src/lib/calculations/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExpandableBreakdown wrapper component</name>
  <files>src/components/calculations/breakdowns/expandable-breakdown.tsx</files>
  <action>
Create the reusable expand/collapse wrapper component using Framer Motion for smooth animations.

Implementation:
- Create `src/components/calculations/breakdowns/` directory
- Implement ExpandableBreakdown with these props:
  - title: string
  - subtitle?: string
  - icon?: React.ReactNode
  - color: 'green' | 'blue' | 'purple'
  - defaultOpen?: boolean (default: false)
  - children: React.ReactNode
- Use useState for isOpen toggle
- Use Framer Motion AnimatePresence for enter/exit animations
- Animate chevron rotation on open/close
- Apply color-coded styling (bg, border, text) based on color prop
- Support dark mode with Tailwind dark: variants
- Height animation: initial 0 -> auto, with opacity fade

Pattern from 07-RESEARCH.md Pattern 1 provides the exact implementation.

Do NOT use native details/summary - use button + motion.div for full animation control.
  </action>
  <verify>
File exists at src/components/calculations/breakdowns/expandable-breakdown.tsx
Exports ExpandableBreakdown component
pnpm tsc --noEmit passes
  </verify>
  <done>
ExpandableBreakdown component renders collapsible section with animated expand/collapse, colored styling based on prop, and supports dark mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create category-specific breakdown components</name>
  <files>
src/components/calculations/breakdowns/spotpris-breakdown.tsx
src/components/calculations/breakdowns/effekt-breakdown.tsx
src/components/calculations/breakdowns/stodtjanster-breakdown.tsx
  </files>
  <action>
Create three breakdown components that show formula details for each savings category.

**SpotprisBreakdown (SPOT-04):**
Props:
- capacityKwh: number
- cyclesPerDay: number
- efficiency: number (0.8 for 80%)
- spreadOre: number (~100 ore = 1 SEK)
- annualSavingsSek: number

Display:
1. Explanatory text: "Batteriet laddar nar elpriset ar lagt..."
2. Formula breakdown in mono font:
   - Batterikapacitet: X kWh
   - x Verkningsgrad: Y%
   - x Cykler/dag: Z
   - = Daglig energi: W kWh/dag
   - x Prisskillnad: V kr/kWh
   - = Daglig besparing: U kr/dag
   - x 365 dagar
   - = Arlig besparing: TOTAL kr (highlighted green)

Use ExpandableBreakdown with color="green", title="Hur beraknas spotprisoptimering?"

**EffektBreakdown (PEAK-04):**
Props:
- currentPeakKw: number
- peakShavingPercent: number
- actualPeakShavingKw: number
- newPeakKw: number
- tariffRateSekKw: number
- annualSavingsSek: number
- isConstrained: boolean

Display:
1. Explanatory text about peak shaving
2. Formula:
   - Nuvarande toppeffekt: X kW
   - x Reduktion: Y%
   - = Malreduktion: Z kW
   - (If isConstrained: amber text showing battery limit)
   - Faktisk reduktion: W kW
   - Ny toppeffekt: V kW
   - x Effekttariff: U kr/kW/man
   - = Manatlig besparing: T kr/man
   - x 12 manader
   - = Arlig besparing: TOTAL kr (highlighted blue)

Use ExpandableBreakdown with color="blue", title="Hur beraknas effektavgiftbesparing?"

**StodtjansterBreakdown (GRID-05):**
Props:
- elomrade: string
- isEmaldoBattery: boolean
- batteryCapacityKw: number
- guaranteedMonthlySek?: number
- guaranteedAnnualSek?: number
- postCampaignRatePerKwYear?: number
- postCampaignAnnualSek?: number
- displayedAnnualSek: number

Display (Emaldo mode):
1. Explanatory text about grid services
2. Elomrade: SEx
3. Section: "Emaldo garanterad intakt (36 man)"
   - Manatlig intakt: X kr/man
   - x 12 manader
   - = Arlig intakt (ar 1-3): Y kr
4. Section: "Efter kampanjperiod (ar 4+)"
   - Batterikapacitet: Z kW
   - x Uppskattad rate: W kr/kW/ar
   - = Arlig intakt (ar 4+): V kr/ar

Display (non-Emaldo mode):
- Batterikapacitet x rate = annual

Use ExpandableBreakdown with color="purple", title="Hur beraknas stodtjanster?"

Import EMALDO_CAMPAIGN_MONTHS from constants.ts for the campaign period display.

Pattern from 07-RESEARCH.md Patterns 2-4 provides the exact implementations.
  </action>
  <verify>
All three files exist in src/components/calculations/breakdowns/
Each exports its respective component
pnpm tsc --noEmit passes
  </verify>
  <done>
Three breakdown components exist, each using ExpandableBreakdown wrapper and displaying formula/inputs for their respective savings category with proper Swedish text and formatting.
  </done>
</task>

</tasks>

<verification>
1. All four files exist in src/components/calculations/breakdowns/
2. pnpm tsc --noEmit passes with no errors
3. Components follow established patterns from Phase 6 stodtjanster-input.tsx
4. Swedish text is consistent with existing UI text
5. formatSek helper uses toLocaleString('sv-SE') pattern
</verification>

<success_criteria>
- ExpandableBreakdown component renders with animated expand/collapse
- SpotprisBreakdown shows formula: capacity x efficiency x cycles x spread x 365
- EffektBreakdown shows formula: peak x reduction% = kW cut, x tariff x 12
- StodtjansterBreakdown shows Emaldo zone-based income OR manual rate
- All components support dark mode
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-calculation-transparency/07-01-SUMMARY.md`
</output>
