---
phase: 06-calculation-engine
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - src/lib/calculations/engine.ts
  - src/components/calculations/wizard/steps/results-step.tsx
  - src/components/calculations/results/savings-breakdown.tsx
autonomous: false

must_haves:
  truths:
    - "Salesperson can adjust cycles/day and see savings update instantly"
    - "Peak shaving slider affects effektavgift savings in results"
    - "Stodtjanster income reflects Emaldo zone rates and post-campaign projection"
    - "All three savings categories show in calculation results with correct values"
    - "Results update on slider drag without page refresh"
  artifacts:
    - path: "src/lib/calculations/engine.ts"
      provides: "Updated calculation engine using new slider values"
      contains: "cyclesPerDay"
    - path: "src/components/calculations/wizard/steps/results-step.tsx"
      provides: "Integrated slider controls in results view"
      contains: "CyclesSlider"
    - path: "src/components/calculations/results/savings-breakdown.tsx"
      provides: "Animated savings display with all three categories"
      contains: "motion"
  key_links:
    - from: "src/components/calculations/wizard/steps/results-step.tsx"
      to: "src/lib/calculations/engine.ts"
      via: "calculateBatteryROI call"
      pattern: "calculateBatteryROI"
    - from: "src/components/calculations/wizard/steps/results-step.tsx"
      to: "src/stores/calculation-wizard-store.ts"
      via: "slider state reads"
      pattern: "useCalculationWizardStore"
    - from: "src/components/calculations/wizard/steps/results-step.tsx"
      to: "src/components/calculations/controls"
      via: "control component imports"
      pattern: "CyclesSlider|PeakShavingSlider|StodtjansterInput"
---

<objective>
Integrate slider controls into the results view and wire up the calculation engine to use new parameters.

Purpose: Connect the slider controls (SPOT-02, PEAK-01, GRID-03) to the calculation engine so salespeople see instant results when adjusting cycles/day, peak shaving, and stodtjanster rates. This completes Phase 6 by making all calculation controls functional.

Output: Updated calculation engine accepting new parameters, results step with integrated sliders, and animated savings breakdown showing all three savings categories updating in real-time.
</objective>

<execution_context>
@/Users/julian.nordgren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian.nordgren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-calculation-engine/06-CONTEXT.md
@.planning/phases/06-calculation-engine/06-01-SUMMARY.md
@.planning/phases/06-calculation-engine/06-02-SUMMARY.md
@src/lib/calculations/engine.ts
@src/lib/calculations/formulas.ts
@src/components/calculations/wizard/steps/results-step.tsx
@src/components/calculations/results/savings-breakdown.tsx
@src/stores/calculation-wizard-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update calculation engine with new parameters</name>
  <files>
    src/lib/calculations/engine.ts
    src/lib/calculations/types.ts
  </files>
  <action>
Update the calculation engine to use the corrected formulas and new parameters:

**Update types.ts - Add to CalculationInputs interface:**
```typescript
// Phase 6: Control parameters
cyclesPerDay: number // 0.5-3, from slider
peakShavingPercent: number // 0-100, from slider
currentPeakKw?: number // Customer's current peak for shaving calc
postCampaignRatePerKwYear?: number // SEK/kW/year after Emaldo campaign
elomrade?: 'SE1' | 'SE2' | 'SE3' | 'SE4' // For zone-based stodtjanster
isEmaldoBattery?: boolean // Determines stodtjanster calculation method
totalProjectionYears?: number // For stodtjanster projection, default 10
```

**Update types.ts - Add to CalculationResults interface:**
```typescript
// Phase 6: Enhanced results
peakShavingKw: number // Actual kW shaved (after constraint)
newPeakKw: number // Peak after shaving
stodtjansterGuaranteedSek: number // Emaldo guaranteed portion
stodtjansterPostCampaignSek: number // Post-campaign portion
stodtjansterTotalSek: number // Combined over projection period
stodtjansterAnnualAverageSek: number // Average per year
```

**Update engine.ts calculateBatteryROI function:**

1. Import the new formula and constants:
   ```typescript
   import { calcSpotprisSavingsV2 } from './formulas'
   import { calculateActualPeakShaving } from './constraints'
   import { EMALDO_STODTJANSTER_RATES, EMALDO_CAMPAIGN_MONTHS, DEFAULT_ROUND_TRIP_EFFICIENCY } from './constants'
   ```

2. Replace spotpris calculation with new formula:
   ```typescript
   // SPOT-01: Corrected formula
   const spotprisSavings = calcSpotprisSavingsV2(
     inputs.battery.capacityKwh,
     inputs.cyclesPerDay,
     DEFAULT_ROUND_TRIP_EFFICIENCY,
     inputs.dayPriceOre,
     inputs.nightPriceOre,
     365
   )
   ```

3. Add peak shaving calculation with constraint:
   ```typescript
   // PEAK-01, PEAK-02, PEAK-03: Peak shaving with capacity constraint
   let peakShavingResults = { actualKw: 0, newPeakKw: inputs.currentPeakKw || 0 }
   if (inputs.currentPeakKw && inputs.peakShavingPercent > 0) {
     peakShavingResults = calculateActualPeakShaving(
       inputs.currentPeakKw,
       inputs.peakShavingPercent,
       inputs.battery.maxDischargeKw
     )
   }

   // PEAK-03: Effect tariff savings based on actual kW shaved
   const effectTariffSavings = calcEffectTariffSavings(
     peakShavingResults.actualKw,
     inputs.effectTariffDayRate
   )
   ```

4. Add stodtjanster calculation with Emaldo logic:
   ```typescript
   // GRID-01, GRID-02, GRID-03, GRID-04: Stodtjanster calculation
   const totalYears = inputs.totalProjectionYears || 10
   let stodtjansterGuaranteed = 0
   let stodtjansterPostCampaign = 0

   if (inputs.isEmaldoBattery && inputs.elomrade) {
     // Emaldo: Zone-based guaranteed income
     const monthlyRate = EMALDO_STODTJANSTER_RATES[inputs.elomrade]
     stodtjansterGuaranteed = monthlyRate * EMALDO_CAMPAIGN_MONTHS

     // Post-campaign projection
     const campaignYears = EMALDO_CAMPAIGN_MONTHS / 12
     const postCampaignYears = Math.max(0, totalYears - campaignYears)
     const postCampaignAnnual = (inputs.postCampaignRatePerKwYear || 500) * inputs.battery.maxDischargeKw
     stodtjansterPostCampaign = postCampaignAnnual * postCampaignYears
   } else {
     // Non-Emaldo: Use gridServicesRatePerKwYear directly
     stodtjansterPostCampaign = inputs.gridServicesRatePerKwYear * inputs.battery.maxDischargeKw * totalYears
   }

   const stodtjansterTotal = stodtjansterGuaranteed + stodtjansterPostCampaign
   const stodtjansterAnnualAverage = stodtjansterTotal / totalYears
   ```

5. Update total annual savings to use annual average:
   ```typescript
   // For annual comparisons, use the averaged stodtjanster
   const totalAnnualSavings = calcTotalAnnualSavings(
     spotprisSavings,
     effectTariffSavings,
     d(stodtjansterAnnualAverage)
   )
   ```

6. Add new fields to returned results:
   ```typescript
   // Add to decimals and results objects
   peakShavingKw: peakShavingResults.actualKw,
   newPeakKw: peakShavingResults.newPeakKw,
   stodtjansterGuaranteedSek: stodtjansterGuaranteed,
   stodtjansterPostCampaignSek: stodtjansterPostCampaign,
   stodtjansterTotalSek: stodtjansterTotal,
   stodtjansterAnnualAverageSek: stodtjansterAnnualAverage,
   ```

Do NOT remove backwards compatibility for existing fields.
  </action>
  <verify>
Run TypeScript compiler: `pnpm tsc --noEmit`
Verify engine.ts compiles without errors
Verify types.ts has all new fields
  </verify>
  <done>
calculateBatteryROI accepts cyclesPerDay, peakShavingPercent, currentPeakKw, postCampaignRatePerKwYear, elomrade, isEmaldoBattery
Results include peakShavingKw, newPeakKw, stodtjansterGuaranteedSek, stodtjansterPostCampaignSek, stodtjansterTotalSek
Spotpris uses corrected formula with efficiency and cycles
Effect tariff uses actual shaved kW after constraint
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate controls into results step</name>
  <files>
    src/components/calculations/wizard/steps/results-step.tsx
  </files>
  <action>
Update results-step.tsx to include the slider controls and use values from the store:

1. Add imports for new components and store fields:
   ```typescript
   import { CyclesSlider } from '@/components/calculations/controls/cycles-slider'
   import { PeakShavingSlider } from '@/components/calculations/controls/peak-shaving-slider'
   import { StodtjansterInput } from '@/components/calculations/controls/stodtjanster-input'
   ```

2. Get slider values from the store:
   ```typescript
   const {
     customerName,
     elomrade,
     natagareId,
     batteries: selectedBatteries,
     // Phase 6: Control values
     cyclesPerDay,
     peakShavingPercent,
     postCampaignRate,
   } = useCalculationWizardStore()
   ```

3. Update the calculatedResults useMemo to use new parameters:
   - Add `cyclesPerDay`, `peakShavingPercent`, `postCampaignRate` to the dependency array
   - Pass these values to calculateBatteryROI:
     ```typescript
     const { results } = calculateBatteryROI({
       // ... existing params
       cyclesPerDay,
       peakShavingPercent,
       currentPeakKw: 8, // TODO: Get from customer data or make configurable
       postCampaignRatePerKwYear: postCampaignRate,
       elomrade: elomrade || undefined,
       isEmaldoBattery: batteryInfo.brandName.toLowerCase().includes('emaldo'),
       totalProjectionYears: 10,
     })
     ```

4. Add controls section before the results display:
   ```tsx
   {/* Calculation controls */}
   <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
     <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
       Ber√§kningsparametrar
     </h3>
     <div className="grid md:grid-cols-3 gap-6">
       <div>
         <CyclesSlider />
       </div>
       <div>
         <PeakShavingSlider
           currentPeakKw={8} // TODO: Make configurable
           batteryMaxDischargeKw={batteryInfo?.maxDischargeKw || 5}
         />
       </div>
       <div>
         <StodtjansterInput
           elomrade={elomrade || 'SE3'}
           isEmaldoBattery={batteryInfo?.brandName.toLowerCase().includes('emaldo') || false}
           batteryCapacityKw={batteryInfo?.maxDischargeKw || 5}
         />
       </div>
     </div>
   </div>
   ```

5. Place the controls section between the header and the SummaryCards component.

6. Ensure the useMemo recalculates when slider values change by including them in dependencies.
  </action>
  <verify>
Run TypeScript compiler: `pnpm tsc --noEmit`
Run dev server: `pnpm dev`
Navigate to calculation wizard, go to results step
Verify sliders appear and interact correctly
  </verify>
  <done>
Results step shows three sliders: cycles/day, peak shaving, stodtjanster
Moving sliders immediately updates calculation results
Emaldo batteries show guaranteed income display
Non-Emaldo batteries show manual entry field
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 6 calculation engine with interactive controls:
- Cycles/day slider (0.5-3) with toast warning at >2
- Peak shaving slider (0-100%) with capacity constraint
- Stodtjanster input with Emaldo zone-based rates
- Real-time calculation updates on slider change
- Animated value changes in results display
  </what-built>
  <how-to-verify>
1. Run dev server: `pnpm dev`
2. Navigate to http://localhost:3000/dashboard/calculations/new
3. Complete wizard steps 1-3 (customer info, consumption, battery selection)
4. On results step (step 4):
   a. Verify cycles/day slider appears with range 0.5-3
   b. Move slider above 2.0 - verify toast notification appears
   c. Verify peak shaving slider shows current peak, target, actual values
   d. Move peak shaving to 100% - verify constraint message if battery limited
   e. Verify stodtjanster section shows Emaldo rates for selected zone
   f. Change post-campaign rate - verify total updates
5. Verify savings breakdown pie chart shows all three categories
6. Verify ROI values update when sliders change (no page refresh needed)
7. Check responsive layout on mobile viewport
  </how-to-verify>
  <resume-signal>Type "approved" if all controls work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Run full type check: `pnpm tsc --noEmit` - should pass
2. Run dev server: `pnpm dev` - should start without errors
3. Create new calculation through wizard
4. Verify all three sliders appear on results step
5. Verify slider interactions update results immediately
6. Verify toast appears when cycles > 2
7. Verify peak shaving constraint message appears when needed
8. Verify stodtjanster shows zone-based Emaldo rates
</verification>

<success_criteria>
- Cycles/day slider: 0.5-3 range, step 0.5, default 1.2, toast at >2
- Peak shaving slider: 0-100%, step 10, shows constraint when exceeded
- Stodtjanster: Emaldo zone rates (SE1-SE3: 1,110/mo, SE4: 1,370/mo), configurable post-campaign
- All three savings categories display in breakdown with correct values
- Slider changes trigger immediate recalculation (no debounce)
- Values animate on change (Framer Motion highlight)
- TypeScript compiles without errors
- User approves visual/functional verification
</success_criteria>

<output>
After completion, create `.planning/phases/06-calculation-engine/06-03-SUMMARY.md`
</output>
