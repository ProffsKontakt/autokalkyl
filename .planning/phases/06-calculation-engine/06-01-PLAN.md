---
phase: 06-calculation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/calculations/formulas.ts
  - src/lib/calculations/constants.ts
  - src/lib/calculations/constraints.ts
  - src/app/layout.tsx
  - components.json
autonomous: true

must_haves:
  truths:
    - "Spotpris calculation uses correct formula: spread x efficiency x cycles x capacity x days"
    - "Emaldo zone-based rates are defined: SE1-SE3 = 1,110 SEK/mo, SE4 = 1,370 SEK/mo"
    - "Peak shaving constraint calculates min(target, battery capacity)"
    - "Sonner toast provider is available app-wide"
  artifacts:
    - path: "src/lib/calculations/formulas.ts"
      provides: "Corrected spotpris formula with efficiency and cycles"
      contains: "calcSpotprisSavings"
    - path: "src/lib/calculations/constants.ts"
      provides: "Emaldo stodtjanster rates by zone"
      contains: "EMALDO_STODTJANSTER_RATES"
    - path: "src/lib/calculations/constraints.ts"
      provides: "Peak shaving constraint logic"
      exports: ["calculateActualPeakShaving"]
    - path: "src/app/layout.tsx"
      provides: "Sonner Toaster component"
      contains: "Toaster"
  key_links:
    - from: "src/lib/calculations/formulas.ts"
      to: "decimal.js"
      via: "Decimal arithmetic"
      pattern: "new Decimal"
    - from: "src/lib/calculations/constraints.ts"
      to: "Math.min"
      via: "capacity constraint"
      pattern: "Math\\.min"
---

<objective>
Fix calculation formulas and add foundation components for Phase 6 calculation controls.

Purpose: Correct the spotpris formula (SPOT-01), add Emaldo stodtjanster zone rates (GRID-01, GRID-02), create peak shaving constraint logic (PEAK-02), and install Sonner for toast notifications (SPOT-03 warning).

Output: Updated formulas.ts with correct spotpris calculation, constants.ts with Emaldo rates, new constraints.ts file, and Sonner toast provider in app layout.
</objective>

<execution_context>
@/Users/julian.nordgren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian.nordgren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-calculation-engine/06-CONTEXT.md
@.planning/phases/06-calculation-engine/06-RESEARCH.md
@src/lib/calculations/formulas.ts
@src/lib/calculations/constants.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix spotpris formula and add stodtjanster constants</name>
  <files>
    src/lib/calculations/formulas.ts
    src/lib/calculations/constants.ts
  </files>
  <action>
Update formulas.ts:
1. Modify calcSpotprisSavings function to use the correct formula:
   - Formula: spread x efficiency x cycles x capacity x days
   - Add cyclesPerDay parameter (number, typically 0.5-3)
   - Add efficiency parameter (number, default 0.8 for 80% round-trip)
   - Change calculation from using annualEnergyKwh to direct formula:
     `spread.times(efficiency).times(cyclesPerDay).times(capacityKwh).times(daysPerYear).div(100)`
   - Keep backwards compatibility by adding new function `calcSpotprisSavingsV2` alongside existing one
   - Default daysPerYear to 365

Update constants.ts:
1. Add EMALDO_STODTJANSTER_RATES object:
   ```typescript
   export const EMALDO_STODTJANSTER_RATES = {
     SE1: 1110, // SEK/month
     SE2: 1110,
     SE3: 1110,
     SE4: 1370,
   } as const
   ```
2. Add EMALDO_CAMPAIGN_MONTHS = 36
3. Add DEFAULT_ROUND_TRIP_EFFICIENCY = 0.8 (80%)
4. Add DEFAULT_POST_CAMPAIGN_RATE = 500 (SEK/kW/year)
5. Add HIGH_CYCLES_WARNING_THRESHOLD = 2

Do NOT modify any other existing constants.
  </action>
  <verify>
Run TypeScript compiler: `pnpm tsc --noEmit`
Verify no type errors in formulas.ts and constants.ts
  </verify>
  <done>
calcSpotprisSavingsV2 function exists with parameters (capacityKwh, cyclesPerDay, efficiency, dayPriceOre, nightPriceOre, daysPerYear)
EMALDO_STODTJANSTER_RATES constant exists with SE1-SE4 keys
EMALDO_CAMPAIGN_MONTHS equals 36
  </done>
</task>

<task type="auto">
  <name>Task 2: Create peak shaving constraints module</name>
  <files>
    src/lib/calculations/constraints.ts
  </files>
  <action>
Create new file src/lib/calculations/constraints.ts:

```typescript
/**
 * Constraint calculations for battery ROI.
 *
 * Ensures calculations respect physical limitations of the battery system.
 */

/**
 * PEAK-02: Calculate actual peak shaving respecting battery capacity.
 *
 * The battery cannot shave more power than it can deliver.
 * Actual shave = min(peak × targetPercent, batteryMaxDischargeKw)
 *
 * @param currentPeakKw - Current peak power demand in kW
 * @param targetPercent - Target reduction percentage (0-100)
 * @param batteryMaxDischargeKw - Battery max discharge power in kW
 */
export function calculateActualPeakShaving(
  currentPeakKw: number,
  targetPercent: number,
  batteryMaxDischargeKw: number
): {
  targetKw: number
  actualKw: number
  newPeakKw: number
  isConstrained: boolean
  constraintMessage: string | null
} {
  const targetKw = currentPeakKw * (targetPercent / 100)
  const actualKw = Math.min(targetKw, batteryMaxDischargeKw)
  const newPeakKw = currentPeakKw - actualKw
  const isConstrained = actualKw < targetKw

  return {
    targetKw,
    actualKw,
    newPeakKw,
    isConstrained,
    constraintMessage: isConstrained
      ? `Batteriet kan max leverera ${batteryMaxDischargeKw.toFixed(1)} kW. Mål: ${targetKw.toFixed(1)} kW.`
      : null,
  }
}

/**
 * Calculate effective cycles considering warranty impact.
 *
 * Higher cycles = more savings but faster warranty consumption.
 *
 * @param cyclesPerDay - Daily charge/discharge cycles
 * @param warrantyYears - Battery warranty in years
 * @param guaranteedCycles - Total cycles guaranteed by warranty
 */
export function calculateWarrantyLifeAtCycles(
  cyclesPerDay: number,
  warrantyYears: number,
  guaranteedCycles: number
): {
  yearsAtCurrentCycles: number
  excedesWarranty: boolean
  warningMessage: string | null
} {
  const annualCycles = cyclesPerDay * 365
  const yearsAtCurrentCycles = guaranteedCycles / annualCycles
  const excedesWarranty = yearsAtCurrentCycles < warrantyYears

  return {
    yearsAtCurrentCycles,
    excedesWarranty,
    warningMessage: excedesWarranty
      ? `Vid ${cyclesPerDay} cykler/dag räcker garanterade cykler i ${yearsAtCurrentCycles.toFixed(1)} år (garanti: ${warrantyYears} år)`
      : null,
  }
}
```
  </action>
  <verify>
Run TypeScript compiler: `pnpm tsc --noEmit`
Verify constraints.ts compiles without errors
  </verify>
  <done>
calculateActualPeakShaving function exported from constraints.ts
Function returns targetKw, actualKw, newPeakKw, isConstrained, constraintMessage
calculateWarrantyLifeAtCycles helper function exists for future use
  </done>
</task>

<task type="auto">
  <name>Task 3: Install Sonner and add toast provider</name>
  <files>
    src/app/layout.tsx
    components.json
  </files>
  <action>
1. Install Sonner via shadcn CLI:
   `pnpm dlx shadcn@latest add sonner`

   If prompted, accept defaults. This creates src/components/ui/sonner.tsx

2. Update src/app/layout.tsx to add the Toaster component:
   - Import: `import { Toaster } from '@/components/ui/sonner'`
   - Add `<Toaster />` as the last child inside the body tag, after {children}
   - Position the Toaster with richColors and closeButton:
     `<Toaster richColors closeButton position="top-right" />`

3. Verify the Toaster is rendered by checking the layout structure.

Note: Do NOT modify any other layout settings (fonts, metadata, providers).
  </action>
  <verify>
Run dev server: `pnpm dev`
Check that no console errors appear related to Sonner
Verify src/components/ui/sonner.tsx exists
  </verify>
  <done>
Sonner component installed at src/components/ui/sonner.tsx
Toaster component added to app/layout.tsx
App compiles and runs without Sonner-related errors
  </done>
</task>

</tasks>

<verification>
1. Run full type check: `pnpm tsc --noEmit` - should pass with no errors
2. Run dev server: `pnpm dev` - should start without errors
3. Verify new constants are accessible: import { EMALDO_STODTJANSTER_RATES } from '@/lib/calculations/constants'
4. Verify constraints module works: import { calculateActualPeakShaving } from '@/lib/calculations/constraints'
5. Verify toast works: import { toast } from 'sonner' in any client component
</verification>

<success_criteria>
- calcSpotprisSavingsV2 uses formula: spread x efficiency x cycles x capacity x days
- EMALDO_STODTJANSTER_RATES has SE1-SE4 rates (1110, 1110, 1110, 1370)
- EMALDO_CAMPAIGN_MONTHS = 36
- calculateActualPeakShaving returns min(target, capacity)
- Sonner Toaster is in app layout
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-calculation-engine/06-01-SUMMARY.md`
</output>
