---
phase: 06-calculation-engine
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/stores/calculation-wizard-store.ts
  - src/components/calculations/controls/cycles-slider.tsx
  - src/components/calculations/controls/peak-shaving-slider.tsx
  - src/components/calculations/controls/stodtjanster-input.tsx
  - src/components/calculations/controls/animated-value.tsx
autonomous: true

must_haves:
  truths:
    - "Salesperson can adjust cycles/day via slider (0.5-3 range, step 0.5)"
    - "High cycles warning appears as toast when cycles > 2"
    - "Peak shaving slider respects battery capacity limit"
    - "Stodtjanster shows Emaldo guaranteed income for SE1-SE4 zones"
    - "Post-campaign income rate is configurable"
  artifacts:
    - path: "src/stores/calculation-wizard-store.ts"
      provides: "Slider state: cyclesPerDay, peakShavingPercent, postCampaignRate"
      contains: "cyclesPerDay"
    - path: "src/components/calculations/controls/cycles-slider.tsx"
      provides: "Cycles/day slider with toast warning"
      exports: ["CyclesSlider"]
    - path: "src/components/calculations/controls/peak-shaving-slider.tsx"
      provides: "Peak shaving % slider with capacity constraint"
      exports: ["PeakShavingSlider"]
    - path: "src/components/calculations/controls/stodtjanster-input.tsx"
      provides: "Emaldo zone-based income display + post-campaign input"
      exports: ["StodtjansterInput"]
  key_links:
    - from: "src/components/calculations/controls/cycles-slider.tsx"
      to: "src/stores/calculation-wizard-store.ts"
      via: "Zustand state update"
      pattern: "useCalculationWizardStore"
    - from: "src/components/calculations/controls/cycles-slider.tsx"
      to: "sonner"
      via: "toast.warning on high cycles"
      pattern: "toast\\.warning"
    - from: "src/components/calculations/controls/peak-shaving-slider.tsx"
      to: "src/lib/calculations/constraints.ts"
      via: "capacity constraint"
      pattern: "calculateActualPeakShaving"
---

<objective>
Create slider control components and extend wizard store with calculation parameters.

Purpose: Enable salesperson to configure cycles/day (SPOT-02), peak shaving level (PEAK-01), and post-campaign stodtjanster rate (GRID-03). Show high cycles warning (SPOT-03) and Emaldo guaranteed income (GRID-01, GRID-02).

Output: Extended wizard store with new state fields, three control components (CyclesSlider, PeakShavingSlider, StodtjansterInput), and an AnimatedValue utility component.
</objective>

<execution_context>
@/Users/julian.nordgren/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian.nordgren/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-calculation-engine/06-CONTEXT.md
@.planning/phases/06-calculation-engine/06-RESEARCH.md
@.planning/phases/06-calculation-engine/06-01-SUMMARY.md
@src/stores/calculation-wizard-store.ts
@src/lib/calculations/constants.ts
@src/lib/calculations/constraints.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend wizard store with slider state</name>
  <files>
    src/stores/calculation-wizard-store.ts
  </files>
  <action>
Update the calculation wizard store to add three new state fields and their update actions:

1. Add to interface WizardState:
   ```typescript
   // Phase 6: Calculation controls
   cyclesPerDay: number
   peakShavingPercent: number
   postCampaignRate: number

   // Actions
   updateCyclesPerDay: (cycles: number) => void
   updatePeakShavingPercent: (percent: number) => void
   updatePostCampaignRate: (rate: number) => void
   ```

2. Add to initialState:
   ```typescript
   cyclesPerDay: 1.2,  // Default from CONTEXT.md
   peakShavingPercent: 50,  // Default 50% reduction
   postCampaignRate: 500,  // Default 500 SEK/kW/year from constants
   ```

3. Add the three update actions in the store:
   ```typescript
   updateCyclesPerDay: (cycles) => set({ cyclesPerDay: cycles }),
   updatePeakShavingPercent: (percent) => set({ peakShavingPercent: percent }),
   updatePostCampaignRate: (rate) => set({ postCampaignRate: rate }),
   ```

4. Add these fields to the `partialize` function so they persist to localStorage:
   ```typescript
   partialize: (state) => ({
     // ... existing fields
     cyclesPerDay: state.cyclesPerDay,
     peakShavingPercent: state.peakShavingPercent,
     postCampaignRate: state.postCampaignRate,
   }),
   ```

Do NOT modify existing fields or actions. Only ADD new ones.
  </action>
  <verify>
Run TypeScript compiler: `pnpm tsc --noEmit`
Verify store exports useCalculationWizardStore with new fields
  </verify>
  <done>
Store has cyclesPerDay, peakShavingPercent, postCampaignRate state fields
Store has updateCyclesPerDay, updatePeakShavingPercent, updatePostCampaignRate actions
New fields persist to localStorage
  </done>
</task>

<task type="auto">
  <name>Task 2: Create slider control components</name>
  <files>
    src/components/calculations/controls/cycles-slider.tsx
    src/components/calculations/controls/peak-shaving-slider.tsx
    src/components/calculations/controls/animated-value.tsx
  </files>
  <action>
Create the controls directory if it doesn't exist: src/components/calculations/controls/

**Create cycles-slider.tsx:**
```typescript
'use client'

import { useCalculationWizardStore } from '@/stores/calculation-wizard-store'
import { motion } from 'framer-motion'
import { useEffect, useRef } from 'react'
import { toast } from 'sonner'
import { HIGH_CYCLES_WARNING_THRESHOLD } from '@/lib/calculations/constants'

interface CyclesSliderProps {
  min?: number
  max?: number
  step?: number
}

export function CyclesSlider({
  min = 0.5,
  max = 3,
  step = 0.5,
}: CyclesSliderProps) {
  const cyclesPerDay = useCalculationWizardStore((state) => state.cyclesPerDay)
  const updateCyclesPerDay = useCalculationWizardStore((state) => state.updateCyclesPerDay)
  const hasShownWarning = useRef(false)

  // SPOT-03: Show warning toast when cycles exceed threshold
  useEffect(() => {
    if (cyclesPerDay > HIGH_CYCLES_WARNING_THRESHOLD && !hasShownWarning.current) {
      toast.warning('Höga cykler påverkar garantin', {
        description: 'Fler än 2 cykler per dag kan förkorta batteriets garantitid. Optimal livslängd uppnås vid 1-2 cykler/dag.',
        duration: 3000,
      })
      hasShownWarning.current = true
    } else if (cyclesPerDay <= HIGH_CYCLES_WARNING_THRESHOLD) {
      hasShownWarning.current = false
    }
  }, [cyclesPerDay])

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = parseFloat(e.target.value)
    updateCyclesPerDay(value) // Immediate, no debounce per requirements
  }

  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between">
        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">
          Laddningscykler per dag
        </label>
        <motion.span
          key={cyclesPerDay}
          initial={{ scale: 1.3, color: '#3B82F6' }}
          animate={{ scale: 1, color: '#1F2937' }}
          transition={{ duration: 0.3, ease: 'easeOut' }}
          className="text-lg font-bold tabular-nums dark:text-gray-100"
        >
          {cyclesPerDay.toFixed(1)}
        </motion.span>
      </div>

      <input
        type="range"
        min={min}
        max={max}
        step={step}
        value={cyclesPerDay}
        onChange={handleChange}
        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-blue-600"
        aria-label="Antal laddningscykler per dag"
        aria-valuemin={min}
        aria-valuemax={max}
        aria-valuenow={cyclesPerDay}
        aria-valuetext={`${cyclesPerDay} cykler per dag`}
      />

      <div className="flex justify-between text-xs text-gray-500 dark:text-gray-400">
        <span>0.5</span>
        <span>1.5 (typisk)</span>
        <span>3.0</span>
      </div>

      {cyclesPerDay > HIGH_CYCLES_WARNING_THRESHOLD && (
        <motion.div
          initial={{ opacity: 0, height: 0 }}
          animate={{ opacity: 1, height: 'auto' }}
          className="p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg text-xs text-amber-700 dark:text-amber-400"
        >
          <div className="flex items-start gap-2">
            <span className="text-base">⚠️</span>
            <div>
              <strong>Påverkar garantitid:</strong> Höga cykler ger högre besparing men kan förkorta batteriets livslängd.
            </div>
          </div>
        </motion.div>
      )}
    </div>
  )
}
```

**Create peak-shaving-slider.tsx:**
```typescript
'use client'

import { useCalculationWizardStore } from '@/stores/calculation-wizard-store'
import { calculateActualPeakShaving } from '@/lib/calculations/constraints'
import { motion } from 'framer-motion'

interface PeakShavingSliderProps {
  currentPeakKw: number
  batteryMaxDischargeKw: number
}

export function PeakShavingSlider({
  currentPeakKw,
  batteryMaxDischargeKw,
}: PeakShavingSliderProps) {
  const peakShavingPercent = useCalculationWizardStore((state) => state.peakShavingPercent)
  const updatePeakShavingPercent = useCalculationWizardStore((state) => state.updatePeakShavingPercent)

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = parseInt(e.target.value, 10)
    updatePeakShavingPercent(value) // Immediate, no debounce
  }

  // PEAK-02: Apply capacity constraint
  const { targetKw, actualKw, newPeakKw, isConstrained, constraintMessage } = calculateActualPeakShaving(
    currentPeakKw,
    peakShavingPercent,
    batteryMaxDischargeKw
  )

  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between">
        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">
          Effektavgift reduktion
        </label>
        <motion.span
          key={peakShavingPercent}
          initial={{ scale: 1.3, color: '#10B981' }}
          animate={{ scale: 1, color: '#1F2937' }}
          transition={{ duration: 0.3, ease: 'easeOut' }}
          className="text-lg font-bold tabular-nums dark:text-gray-100"
        >
          {peakShavingPercent}%
        </motion.span>
      </div>

      <input
        type="range"
        min={0}
        max={100}
        step={10}
        value={peakShavingPercent}
        onChange={handleChange}
        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-green-600"
        aria-label="Procentuell reduktion av toppeffekt"
        aria-valuemin={0}
        aria-valuemax={100}
        aria-valuenow={peakShavingPercent}
        aria-valuetext={`${peakShavingPercent} procent reduktion`}
      />

      <div className="flex justify-between text-xs text-gray-500 dark:text-gray-400">
        <span>0%</span>
        <span>50%</span>
        <span>100%</span>
      </div>

      <div className="space-y-1 text-sm bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
        <div className="flex items-center justify-between">
          <span className="text-gray-600 dark:text-gray-400">Nuvarande topp:</span>
          <span className="font-medium">{currentPeakKw.toFixed(1)} kW</span>
        </div>
        <div className="flex items-center justify-between">
          <span className="text-gray-600 dark:text-gray-400">Målreduktion:</span>
          <span className="font-medium">{targetKw.toFixed(1)} kW</span>
        </div>
        <div className="flex items-center justify-between">
          <span className="text-gray-600 dark:text-gray-400">Faktisk reduktion:</span>
          <span className={`font-semibold ${isConstrained ? 'text-amber-600' : 'text-green-600'}`}>
            {actualKw.toFixed(1)} kW
          </span>
        </div>
        <div className="flex items-center justify-between border-t border-gray-200 dark:border-gray-700 pt-1 mt-1">
          <span className="text-gray-600 dark:text-gray-400">Ny toppeffekt:</span>
          <span className="font-bold text-green-600">{newPeakKw.toFixed(1)} kW</span>
        </div>
      </div>

      {isConstrained && constraintMessage && (
        <div className="p-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded text-xs text-amber-700 dark:text-amber-400">
          ℹ️ {constraintMessage}
        </div>
      )}
    </div>
  )
}
```

**Create animated-value.tsx:**
```typescript
'use client'

import { motion, AnimatePresence } from 'framer-motion'
import { useEffect, useState } from 'react'

interface AnimatedValueProps {
  value: number
  formatter: (n: number) => string
  label?: string
  className?: string
  highlightColor?: string
}

export function AnimatedValue({
  value,
  formatter,
  label,
  className = '',
  highlightColor = 'rgba(59, 130, 246, 0.1)',
}: AnimatedValueProps) {
  const [isChanging, setIsChanging] = useState(false)

  useEffect(() => {
    setIsChanging(true)
    const timer = setTimeout(() => setIsChanging(false), 500)
    return () => clearTimeout(timer)
  }, [value])

  return (
    <div className={`relative ${className}`}>
      <AnimatePresence mode="wait">
        <motion.div
          key={value}
          initial={{ opacity: 0, y: -10 }}
          animate={{
            opacity: 1,
            y: 0,
            backgroundColor: isChanging ? highlightColor : 'transparent',
          }}
          exit={{ opacity: 0, y: 10 }}
          transition={{ duration: 0.3 }}
          className="rounded px-2 py-1"
        >
          {label && (
            <div className="text-sm text-gray-600 dark:text-gray-400">{label}</div>
          )}
          <div className="text-2xl font-bold text-gray-900 dark:text-white tabular-nums">
            {formatter(value)}
          </div>
        </motion.div>
      </AnimatePresence>
    </div>
  )
}
```
  </action>
  <verify>
Run TypeScript compiler: `pnpm tsc --noEmit`
Verify all three component files exist and compile
  </verify>
  <done>
CyclesSlider component shows slider with 0.5-3 range, step 0.5
CyclesSlider triggers toast warning when value > 2
PeakShavingSlider shows slider with 0-100% range, step 10
PeakShavingSlider displays constraint message when actualKw < targetKw
AnimatedValue component animates on value change
  </done>
</task>

<task type="auto">
  <name>Task 3: Create stodtjanster input component</name>
  <files>
    src/components/calculations/controls/stodtjanster-input.tsx
  </files>
  <action>
Create src/components/calculations/controls/stodtjanster-input.tsx:

```typescript
'use client'

import { useCalculationWizardStore } from '@/stores/calculation-wizard-store'
import { EMALDO_STODTJANSTER_RATES, EMALDO_CAMPAIGN_MONTHS } from '@/lib/calculations/constants'
import type { Elomrade } from '@/lib/calculations/types'
import { motion } from 'framer-motion'
import { useState } from 'react'

interface StodtjansterInputProps {
  elomrade: Elomrade
  isEmaldoBattery: boolean
  batteryCapacityKw: number
  totalYears?: number // For projection calculation, default 10
}

export function StodtjansterInput({
  elomrade,
  isEmaldoBattery,
  batteryCapacityKw,
  totalYears = 10,
}: StodtjansterInputProps) {
  const postCampaignRate = useCalculationWizardStore((state) => state.postCampaignRate)
  const updatePostCampaignRate = useCalculationWizardStore((state) => state.updatePostCampaignRate)
  const [showDetails, setShowDetails] = useState(false)

  // Non-Emaldo: Manual entry only
  if (!isEmaldoBattery) {
    return (
      <div className="space-y-2">
        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
          Stödtjänster intäkt (SEK/år)
        </label>
        <input
          type="number"
          value={postCampaignRate * batteryCapacityKw}
          onChange={(e) => {
            const annualValue = parseFloat(e.target.value) || 0
            updatePostCampaignRate(annualValue / batteryCapacityKw)
          }}
          className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
          placeholder="Ange årlig intäkt"
          min="0"
        />
        <p className="text-xs text-gray-500 dark:text-gray-400">
          Manuell uppskattning av grid services intäkt
        </p>
      </div>
    )
  }

  // Emaldo: Zone-based guaranteed income + configurable post-campaign
  const guaranteedMonthly = EMALDO_STODTJANSTER_RATES[elomrade]
  const guaranteedAnnual = guaranteedMonthly * 12
  const guaranteedTotal = guaranteedMonthly * EMALDO_CAMPAIGN_MONTHS

  // Post-campaign calculation
  const campaignYears = EMALDO_CAMPAIGN_MONTHS / 12 // 3 years
  const postCampaignYears = Math.max(0, totalYears - campaignYears)
  const postCampaignAnnual = postCampaignRate * batteryCapacityKw
  const postCampaignTotal = postCampaignAnnual * postCampaignYears

  // Combined totals
  const totalIncome = guaranteedTotal + postCampaignTotal
  const averageAnnual = totalIncome / totalYears

  return (
    <div className="space-y-4">
      {/* Guaranteed income (read-only) */}
      <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
        <div className="text-sm text-green-700 dark:text-green-400 font-medium mb-1">
          Emaldo garanterad intäkt ({EMALDO_CAMPAIGN_MONTHS} månader)
        </div>
        <motion.div
          key={guaranteedMonthly}
          initial={{ scale: 1.1 }}
          animate={{ scale: 1 }}
          className="text-2xl font-bold text-green-900 dark:text-green-300"
        >
          {guaranteedMonthly.toLocaleString('sv-SE')} kr/mån
        </motion.div>
        <div className="text-xs text-green-600 dark:text-green-500 mt-1 space-y-0.5">
          <div>= {guaranteedAnnual.toLocaleString('sv-SE')} kr/år</div>
          <div>= {guaranteedTotal.toLocaleString('sv-SE')} kr totalt ({campaignYears} år)</div>
        </div>
        <div className="mt-2 px-2 py-1 bg-green-100 dark:bg-green-800/30 rounded text-xs text-green-700 dark:text-green-400">
          Elområde {elomrade}
        </div>
      </div>

      {/* Post-campaign rate (configurable) */}
      <div className="space-y-2">
        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
          Efter kampanjperiod (SEK/kW/år)
        </label>
        <input
          type="number"
          value={postCampaignRate}
          onChange={(e) => updatePostCampaignRate(parseFloat(e.target.value) || 0)}
          className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
          step="50"
          min="0"
        />
        <p className="text-xs text-gray-500 dark:text-gray-400">
          Uppskattad intäkt per kW batterikapacitet efter {EMALDO_CAMPAIGN_MONTHS} månader
        </p>
        {postCampaignYears > 0 && (
          <div className="text-sm text-gray-600 dark:text-gray-400">
            = {postCampaignAnnual.toLocaleString('sv-SE')} kr/år ({batteryCapacityKw.toFixed(1)} kW × {postCampaignRate} kr)
          </div>
        )}
      </div>

      {/* Expandable details */}
      <button
        type="button"
        onClick={() => setShowDetails(!showDetails)}
        className="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center gap-1"
      >
        <span>{showDetails ? '▼' : '▶'}</span>
        Mer detaljer
      </button>

      {showDetails && (
        <motion.div
          initial={{ opacity: 0, height: 0 }}
          animate={{ opacity: 1, height: 'auto' }}
          exit={{ opacity: 0, height: 0 }}
          className="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg text-sm space-y-2"
        >
          <div className="font-medium text-gray-900 dark:text-gray-100">
            Beräkning över {totalYears} år
          </div>
          <div className="grid grid-cols-2 gap-2 text-gray-600 dark:text-gray-400">
            <div>Garanterad (år 1-3):</div>
            <div className="text-right font-medium">{guaranteedTotal.toLocaleString('sv-SE')} kr</div>
            <div>Efter kampanj (år {campaignYears + 1}-{totalYears}):</div>
            <div className="text-right font-medium">{postCampaignTotal.toLocaleString('sv-SE')} kr</div>
            <div className="border-t border-gray-200 dark:border-gray-700 pt-1 font-medium text-gray-900 dark:text-gray-100">
              Total intäkt:
            </div>
            <div className="border-t border-gray-200 dark:border-gray-700 pt-1 text-right font-bold text-green-600">
              {totalIncome.toLocaleString('sv-SE')} kr
            </div>
            <div className="text-gray-500">Snitt per år:</div>
            <div className="text-right">{Math.round(averageAnnual).toLocaleString('sv-SE')} kr/år</div>
          </div>
        </motion.div>
      )}
    </div>
  )
}
```
  </action>
  <verify>
Run TypeScript compiler: `pnpm tsc --noEmit`
Verify stodtjanster-input.tsx compiles without errors
  </verify>
  <done>
StodtjansterInput shows Emaldo guaranteed income for the selected zone
StodtjansterInput allows post-campaign rate configuration
Component calculates and displays total income over projection period
Non-Emaldo batteries show manual entry field
  </done>
</task>

</tasks>

<verification>
1. Run full type check: `pnpm tsc --noEmit` - should pass with no errors
2. Test store in browser console:
   - `useCalculationWizardStore.getState().cyclesPerDay` returns 1.2
   - `useCalculationWizardStore.getState().updateCyclesPerDay(2.5)` updates value
3. Verify components render:
   - Import and render CyclesSlider in a test page
   - Slider should move and value should animate
   - Moving slider above 2 should trigger toast
</verification>

<success_criteria>
- Store has cyclesPerDay (default 1.2), peakShavingPercent (default 50), postCampaignRate (default 500)
- CyclesSlider has range 0.5-3, step 0.5, triggers toast at > 2
- PeakShavingSlider has range 0-100%, step 10, shows constraint when exceeded
- StodtjansterInput shows zone-based Emaldo rates and allows post-campaign config
- All components use Zustand state directly (no local intermediate state)
- Values animate on change using Framer Motion
</success_criteria>

<output>
After completion, create `.planning/phases/06-calculation-engine/06-02-SUMMARY.md`
</output>
