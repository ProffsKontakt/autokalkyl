---
phase: 01-foundation
plan: 08
type: execute
wave: 6
depends_on: ["01-06", "01-07"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All Phase 1 requirements are implemented and working"
    - "Authentication flow is complete (login, logout, password reset)"
    - "RBAC enforces role hierarchy correctly"
    - "Organization management works for Super Admin"
    - "User management works with proper scoping"
    - "Org Admin can manage branding"
  artifacts: []
  key_links: []
---

<objective>
Verify all Phase 1 requirements are implemented and working correctly.

Purpose: Comprehensive end-to-end testing of all authentication, organization, and user management features before moving to Phase 2.

Output: Verification report confirming all requirements pass or documenting any gaps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
@.planning/phases/01-foundation/01-06-SUMMARY.md
@.planning/phases/01-foundation/01-07-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify Authentication Requirements (AUTH-01 to AUTH-06)</name>
  <what-built>
    Complete authentication system with:
    - Login with email/password
    - Session persistence across refresh
    - Logout from any page
    - Password reset via email
    - Role-based access control
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Seed the database if not done: `npx prisma db seed`

    **AUTH-01: Login with email/password**
    - Navigate to http://localhost:3000/login
    - Enter: admin@kalkyla.se / superadmin123
    - Should redirect to /dashboard
    - Should see welcome message with user name

    **AUTH-02: Session persists across refresh**
    - While logged in, refresh the page (F5)
    - Should remain logged in on /dashboard
    - Close browser, reopen, navigate to /dashboard
    - Should still be logged in (if session not expired)

    **AUTH-03: Logout from any page**
    - Click "Logga ut" button in navigation
    - Should redirect to /login
    - Try navigating directly to /dashboard
    - Should be redirected to /login

    **AUTH-04: Admin can create users with role assignment**
    - Log in as Super Admin
    - Navigate to /dashboard/users
    - Click "Skapa anvandare"
    - Fill form with role = ORG_ADMIN and select an organization
    - Submit and verify user appears in list

    **AUTH-05: Password reset via email**
    - Log out and go to /login
    - Click "Glomt losenord?"
    - Enter admin@test-solar.se
    - Check console for reset link (dev mode)
    - Visit the reset link
    - Enter new password
    - Log in with new password

    **AUTH-06: RBAC enforcement**
    - As Super Admin: can access /admin/organizations, /dashboard/users
    - As Org Admin: can access /dashboard/users (own org), /dashboard/settings
    - As Org Admin: CANNOT access /admin/organizations
    - As Closer: CANNOT access /dashboard/users or /dashboard/settings
  </how-to-verify>
  <resume-signal>Type "AUTH-PASS" if all auth requirements pass, or describe specific failures</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify Organization Requirements (ORG-01 to ORG-07)</name>
  <what-built>
    Organization management with:
    - Super Admin CRUD for organizations
    - Branding configuration (logo, colors)
    - ProffsKontakt affiliation settings
    - Org Admin branding edit
  </what-built>
  <how-to-verify>
    **ORG-01: Super Admin can create organizations**
    - Log in as admin@kalkyla.se (Super Admin)
    - Navigate to /admin/organizations
    - Click "Skapa organisation"
    - Fill: Name, Slug (lowercase-with-dashes), colors
    - Submit - should appear in list

    **ORG-02: Super Admin can set branding**
    - Edit the organization just created
    - Add a logo URL (any public image URL)
    - Change primary and secondary colors
    - Save - verify colors display correctly

    **ORG-03: Super Admin can mark as ProffsKontakt-affiliated**
    - Edit organization
    - Check "Affilierad med ProffsKontakt"
    - Partner cut and margin alert fields should appear
    - Save - verify badge shows in list

    **ORG-04: Super Admin can set partner cut**
    - Edit ProffsKontakt-affiliated org
    - Set partner cut percentage (e.g., 15%)
    - Set margin alert threshold (e.g., 20%)
    - Save - verify values persist

    **ORG-05: Super Admin can view all organizations**
    - Navigate to /admin/organizations
    - Should see all organizations in list
    - Click on any org to view details
    - Should see users list for that org

    **ORG-06: Org Admin can edit branding**
    - Log in as admin@test-solar.se (Org Admin)
    - Navigate to /dashboard/settings
    - Should see organization name, slug
    - Change colors, save
    - Verify changes persist after page reload

    **ORG-07: Org Admin can view their calculations**
    - Navigate to /dashboard/calculations
    - Should see empty state (no calcs yet)
    - Page should be accessible (not 403)
  </how-to-verify>
  <resume-signal>Type "ORG-PASS" if all org requirements pass, or describe specific failures</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify User Requirements (USER-01 to USER-05)</name>
  <what-built>
    User management with:
    - Role-based user creation
    - User editing and deactivation
    - Organization scoping
  </what-built>
  <how-to-verify>
    **USER-01: Super Admin can create Org Admins**
    - Log in as Super Admin
    - Navigate to /dashboard/users
    - Click "Skapa anvandare"
    - Select Role: ORG_ADMIN
    - Select Organization: any org
    - Fill email, name, password
    - Submit - verify user created with ORG_ADMIN role

    **USER-02: Org Admin can create Closers**
    - Log in as admin@test-solar.se (Org Admin)
    - Navigate to /dashboard/users
    - Click "Skapa anvandare"
    - Role should be CLOSER (no ORG_ADMIN option)
    - Fill email, name, password
    - Submit - verify Closer created

    **USER-03: Admin can edit user details**
    - As Org Admin, click "Redigera" on a user
    - Change name or email
    - Save - verify changes persist

    **USER-04: Admin can deactivate users**
    - As Org Admin, find a Closer user
    - Click "Inaktivera"
    - Confirm the action
    - User should show "Inaktiv" status
    - Deactivated user should NOT be able to log in

    **USER-05: Users scoped to organization**
    - As Org Admin for test-solar, view user list
    - Should ONLY see users from test-solar org
    - As Super Admin, view user list
    - Should see ALL users from ALL orgs
  </how-to-verify>
  <resume-signal>Type "USER-PASS" if all user requirements pass, or describe specific failures</resume-signal>
</task>

</tasks>

<verification>
All checkpoint tasks must pass for Phase 1 to be considered complete.

Expected outcomes:
- AUTH-01 to AUTH-06: All pass
- ORG-01 to ORG-07: All pass
- USER-01 to USER-05: All pass

If any requirement fails:
1. Document the failure in detail
2. Create gap closure plan to address
3. Re-verify after fix
</verification>

<success_criteria>
- All three verification checkpoints pass
- No blocking issues remaining
- Phase 1 ready for completion
</success_criteria>

<output>
After all checkpoints pass, create `.planning/phases/01-foundation/01-08-SUMMARY.md` with:
- Verification results for each requirement
- Any notes or observations
- Confirmation that Phase 1 is complete
</output>
