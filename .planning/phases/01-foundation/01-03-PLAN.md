---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/login-form.tsx
  - src/app/(auth)/layout.tsx
  - src/actions/auth.ts
  - src/components/ui/button.tsx
  - src/components/ui/input.tsx
  - src/components/ui/label.tsx
  - src/components/ui/card.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /login and see login form"
    - "User can enter email and password"
    - "Valid credentials redirect to /dashboard"
    - "Invalid credentials show error message"
    - "Logged-in user visiting /login is redirected to /dashboard"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page"
      min_lines: 15
    - path: "src/app/(auth)/login/login-form.tsx"
      provides: "Login form component"
      contains: "useForm"
    - path: "src/actions/auth.ts"
      provides: "Server actions for auth"
      exports: ["loginAction", "logoutAction"]
  key_links:
    - from: "src/app/(auth)/login/login-form.tsx"
      to: "src/actions/auth.ts"
      via: "form action"
      pattern: "loginAction"
    - from: "src/actions/auth.ts"
      to: "src/lib/auth/auth.ts"
      via: "signIn import"
      pattern: "import.*signIn.*from"
---

<objective>
Create login UI and authentication server actions for user sign-in and sign-out.

Purpose: Provide the user-facing authentication experience, allowing users to log in with email/password and log out from any page. Implements AUTH-01 (login), AUTH-02 (session persistence), and AUTH-03 (logout).

Output: Login page with form validation, server actions for login/logout, and basic UI components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/research/STACK.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create basic UI components</name>
  <files>
    src/components/ui/button.tsx
    src/components/ui/input.tsx
    src/components/ui/label.tsx
    src/components/ui/card.tsx
  </files>
  <action>
    Create minimal Tailwind-styled UI components (no shadcn dependency for simplicity):

    **src/components/ui/button.tsx:**
    ```typescript
    import { forwardRef, ButtonHTMLAttributes } from 'react';
    import { cn } from '@/lib/utils';

    interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
      variant?: 'default' | 'outline' | 'ghost' | 'destructive';
      size?: 'default' | 'sm' | 'lg';
    }

    export const Button = forwardRef<HTMLButtonElement, ButtonProps>(
      ({ className, variant = 'default', size = 'default', ...props }, ref) => {
        return (
          <button
            className={cn(
              'inline-flex items-center justify-center rounded-md font-medium transition-colors',
              'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2',
              'disabled:pointer-events-none disabled:opacity-50',
              {
                'bg-blue-600 text-white hover:bg-blue-700': variant === 'default',
                'border border-gray-300 bg-white hover:bg-gray-50': variant === 'outline',
                'hover:bg-gray-100': variant === 'ghost',
                'bg-red-600 text-white hover:bg-red-700': variant === 'destructive',
              },
              {
                'h-10 px-4 py-2 text-sm': size === 'default',
                'h-8 px-3 text-xs': size === 'sm',
                'h-12 px-6 text-base': size === 'lg',
              },
              className
            )}
            ref={ref}
            {...props}
          />
        );
      }
    );
    Button.displayName = 'Button';
    ```

    **src/components/ui/input.tsx:**
    ```typescript
    import { forwardRef, InputHTMLAttributes } from 'react';
    import { cn } from '@/lib/utils';

    export const Input = forwardRef<
      HTMLInputElement,
      InputHTMLAttributes<HTMLInputElement>
    >(({ className, type, ...props }, ref) => {
      return (
        <input
          type={type}
          className={cn(
            'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2',
            'text-sm placeholder:text-gray-400',
            'focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent',
            'disabled:cursor-not-allowed disabled:opacity-50',
            className
          )}
          ref={ref}
          {...props}
        />
      );
    });
    Input.displayName = 'Input';
    ```

    **src/components/ui/label.tsx:**
    ```typescript
    import { forwardRef, LabelHTMLAttributes } from 'react';
    import { cn } from '@/lib/utils';

    export const Label = forwardRef<
      HTMLLabelElement,
      LabelHTMLAttributes<HTMLLabelElement>
    >(({ className, ...props }, ref) => {
      return (
        <label
          className={cn(
            'text-sm font-medium text-gray-700',
            className
          )}
          ref={ref}
          {...props}
        />
      );
    });
    Label.displayName = 'Label';
    ```

    **src/components/ui/card.tsx:**
    ```typescript
    import { HTMLAttributes, forwardRef } from 'react';
    import { cn } from '@/lib/utils';

    export const Card = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
      ({ className, ...props }, ref) => (
        <div
          ref={ref}
          className={cn('rounded-lg border border-gray-200 bg-white shadow-sm', className)}
          {...props}
        />
      )
    );
    Card.displayName = 'Card';

    export const CardHeader = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
      ({ className, ...props }, ref) => (
        <div ref={ref} className={cn('p-6 pb-0', className)} {...props} />
      )
    );
    CardHeader.displayName = 'CardHeader';

    export const CardTitle = forwardRef<HTMLHeadingElement, HTMLAttributes<HTMLHeadingElement>>(
      ({ className, ...props }, ref) => (
        <h3 ref={ref} className={cn('text-xl font-semibold', className)} {...props} />
      )
    );
    CardTitle.displayName = 'CardTitle';

    export const CardContent = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
      ({ className, ...props }, ref) => (
        <div ref={ref} className={cn('p-6', className)} {...props} />
      )
    );
    CardContent.displayName = 'CardContent';
    ```

    Also create utility function **src/lib/utils.ts:**
    ```typescript
    import { type ClassValue, clsx } from 'clsx';
    import { twMerge } from 'tailwind-merge';

    export function cn(...inputs: ClassValue[]) {
      return twMerge(clsx(inputs));
    }
    ```

    Install required packages:
    ```bash
    npm install clsx tailwind-merge
    ```
  </action>
  <verify>
    - All component files compile without TypeScript errors
    - cn utility function works
  </verify>
  <done>Basic UI components (Button, Input, Label, Card) created with Tailwind styling</done>
</task>

<task type="auto">
  <name>Task 2: Create login page and form</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/login/login-form.tsx
  </files>
  <action>
    Create auth route group with login page:

    **src/app/(auth)/layout.tsx:**
    ```typescript
    export default function AuthLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4">
          <div className="w-full max-w-md">
            {children}
          </div>
        </div>
      );
    }
    ```

    **src/app/(auth)/login/page.tsx:**
    ```typescript
    import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
    import { LoginForm } from './login-form';

    export const metadata = {
      title: 'Logga in - Kalkyla.se',
      description: 'Logga in till ditt Kalkyla-konto',
    };

    export default function LoginPage() {
      return (
        <Card>
          <CardHeader>
            <CardTitle className="text-center">Logga in</CardTitle>
          </CardHeader>
          <CardContent>
            <LoginForm />
          </CardContent>
        </Card>
      );
    }
    ```

    **src/app/(auth)/login/login-form.tsx:**
    ```typescript
    'use client';

    import { useForm } from 'react-hook-form';
    import { zodResolver } from '@hookform/resolvers/zod';
    import { z } from 'zod';
    import { useState, useTransition } from 'react';
    import { useRouter } from 'next/navigation';

    import { Button } from '@/components/ui/button';
    import { Input } from '@/components/ui/input';
    import { Label } from '@/components/ui/label';
    import { loginAction } from '@/actions/auth';

    const loginSchema = z.object({
      email: z.string().email('Ogiltig e-postadress'),
      password: z.string().min(8, 'Losenordet maste vara minst 8 tecken'),
    });

    type LoginFormData = z.infer<typeof loginSchema>;

    export function LoginForm() {
      const [error, setError] = useState<string | null>(null);
      const [isPending, startTransition] = useTransition();
      const router = useRouter();

      const {
        register,
        handleSubmit,
        formState: { errors },
      } = useForm<LoginFormData>({
        resolver: zodResolver(loginSchema),
      });

      const onSubmit = (data: LoginFormData) => {
        setError(null);
        startTransition(async () => {
          const result = await loginAction(data);
          if (result?.error) {
            setError(result.error);
          } else {
            router.push('/dashboard');
            router.refresh();
          }
        });
      };

      return (
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {error && (
            <div className="p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm">
              {error}
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="email">E-postadress</Label>
            <Input
              id="email"
              type="email"
              placeholder="namn@foretag.se"
              {...register('email')}
            />
            {errors.email && (
              <p className="text-sm text-red-600">{errors.email.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="password">Losenord</Label>
            <Input
              id="password"
              type="password"
              {...register('password')}
            />
            {errors.password && (
              <p className="text-sm text-red-600">{errors.password.message}</p>
            )}
          </div>

          <Button type="submit" className="w-full" disabled={isPending}>
            {isPending ? 'Loggar in...' : 'Logga in'}
          </Button>

          <div className="text-center">
            <a
              href="/forgot-password"
              className="text-sm text-blue-600 hover:underline"
            >
              Glomt losenord?
            </a>
          </div>
        </form>
      );
    }
    ```
  </action>
  <verify>
    - Login page renders at /login
    - Form validates email and password fields
    - Error messages display in Swedish
  </verify>
  <done>Login page with form validation and error handling created</done>
</task>

<task type="auto">
  <name>Task 3: Create auth server actions</name>
  <files>
    src/actions/auth.ts
  </files>
  <action>
    Create server actions for login and logout:

    **src/actions/auth.ts:**
    ```typescript
    'use server';

    import { signIn, signOut } from '@/lib/auth/auth';
    import { AuthError } from 'next-auth';
    import { z } from 'zod';

    const loginSchema = z.object({
      email: z.string().email(),
      password: z.string().min(8),
    });

    export async function loginAction(data: z.infer<typeof loginSchema>) {
      try {
        const parsed = loginSchema.safeParse(data);
        if (!parsed.success) {
          return { error: 'Ogiltig inmatning' };
        }

        await signIn('credentials', {
          email: parsed.data.email,
          password: parsed.data.password,
          redirect: false,
        });

        return { success: true };
      } catch (error) {
        if (error instanceof AuthError) {
          switch (error.type) {
            case 'CredentialsSignin':
              return { error: 'Felaktig e-postadress eller losenord' };
            default:
              return { error: 'Nagot gick fel. Forsok igen.' };
          }
        }
        throw error;
      }
    }

    export async function logoutAction() {
      await signOut({ redirect: false });
      return { success: true };
    }
    ```

    This implements:
    - AUTH-01: User can log in with email and password
    - AUTH-02: Session persists (handled by Auth.js JWT)
    - AUTH-03: User can log out from any page (logoutAction)
  </action>
  <verify>
    - Server actions compile without errors
    - Actions properly call Auth.js signIn/signOut
    - Error handling returns Swedish error messages
  </verify>
  <done>Server actions for login and logout with proper error handling</done>
</task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **Type checking:**
   ```bash
   npx tsc --noEmit
   ```

2. **Build verification:**
   ```bash
   npm run build
   ```

3. **Manual testing (requires seed user):**
   - Navigate to /login
   - See login form with email/password fields
   - Submit invalid credentials -> see error message
   - Submit valid credentials -> redirect to /dashboard (will 404 until created)

4. **UI component check:**
   - Button, Input, Label, Card components render correctly
   - Form validation shows inline errors
</verification>

<success_criteria>
- Login page renders with proper styling
- Form validates with Zod schema
- Server actions handle authentication
- Error messages display in Swedish
- Logout action available for use in navigation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
