---
phase: 01-foundation
plan: 05
type: execute
wave: 4
depends_on: ["01-03", "01-04"]
files_modified:
  - src/actions/users.ts
  - src/app/(dashboard)/dashboard/users/page.tsx
  - src/app/(dashboard)/dashboard/users/new/page.tsx
  - src/app/(dashboard)/dashboard/users/[id]/page.tsx
  - src/components/users/user-form.tsx
  - src/components/users/user-list.tsx
  - prisma/seed.ts
autonomous: true

must_haves:
  truths:
    - "Super Admin can create Org Admins for any organization"
    - "Org Admin can create Closers for their organization"
    - "Admin can edit user details (name, email, role)"
    - "Admin can reset user password via edit form"
    - "Admin can deactivate users"
    - "Users are scoped to their organization (except Super Admin)"
  artifacts:
    - path: "src/actions/users.ts"
      provides: "User management server actions"
      exports: ["createUser", "updateUser", "getUsers", "deactivateUser"]
    - path: "src/app/(dashboard)/dashboard/users/page.tsx"
      provides: "User list page"
      min_lines: 20
    - path: "src/components/users/user-form.tsx"
      provides: "User create/edit form with organization dropdown"
      contains: "getOrganizations"
    - path: "prisma/seed.ts"
      provides: "Database seed script"
      contains: "SUPER_ADMIN"
  key_links:
    - from: "src/actions/users.ts"
      to: "src/lib/db/tenant-client.ts"
      via: "tenant scoping for org users"
      pattern: "createTenantClient"
    - from: "src/app/(dashboard)/dashboard/users/page.tsx"
      to: "src/actions/users.ts"
      via: "data fetching"
      pattern: "getUsers"
    - from: "src/components/users/user-form.tsx"
      to: "src/actions/organizations.ts"
      via: "organization dropdown for Super Admin"
      pattern: "getOrganizations"
---

<objective>
Implement user management with role-based creation rules and organization scoping.

Purpose: Enable Super Admin to create Org Admins for any organization, and Org Admins to create Closers within their own organization. Implements USER-01 through USER-05 and AUTH-04 (admin password reset).

Output: User CRUD functionality with proper role hierarchy enforcement, dashboard pages for user management, and seed script for initial setup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/research/ARCHITECTURE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user management server actions</name>
  <files>
    src/actions/users.ts
  </files>
  <action>
    Create server actions for user CRUD with role hierarchy enforcement:

    ```typescript
    'use server';

    import { revalidatePath } from 'next/cache';
    import bcrypt from 'bcryptjs';
    import { z } from 'zod';
    import { prisma } from '@/lib/db/client';
    import { createTenantClient } from '@/lib/db/tenant-client';
    import { auth } from '@/lib/auth/auth';
    import { hasPermission, canAccessOrg, PERMISSIONS, ROLES, Role } from '@/lib/auth/permissions';

    const userSchema = z.object({
      email: z.string().email('Ogiltig e-postadress'),
      name: z.string().min(2, 'Namn måste vara minst 2 tecken'),
      password: z.string().min(8, 'Lösenordet måste vara minst 8 tecken').optional(),
      role: z.enum(['ORG_ADMIN', 'CLOSER']),
      orgId: z.string().cuid(),
    });

    export type UserFormData = z.infer<typeof userSchema>;

    export async function createUser(data: UserFormData) {
      const session = await auth();
      if (!session?.user) {
        return { error: 'Ej inloggad' };
      }

      const currentRole = session.user.role as Role;
      const targetRole = data.role as Role;

      // Permission checks based on role hierarchy
      if (targetRole === ROLES.ORG_ADMIN) {
        // Only Super Admin can create Org Admins
        if (!hasPermission(currentRole, PERMISSIONS.USER_CREATE_ORG_ADMIN)) {
          return { error: 'Du har inte behörighet att skapa Org Admin-användare' };
        }
      } else if (targetRole === ROLES.CLOSER) {
        // Super Admin or Org Admin can create Closers
        if (!hasPermission(currentRole, PERMISSIONS.USER_CREATE_CLOSER)) {
          return { error: 'Du har inte behörighet att skapa Closer-användare' };
        }
        // Org Admin can only create in their own org
        if (currentRole === ROLES.ORG_ADMIN && session.user.orgId !== data.orgId) {
          return { error: 'Du kan bara skapa användare i din egen organisation' };
        }
      }

      // Verify org exists
      const org = await prisma.organization.findUnique({ where: { id: data.orgId } });
      if (!org) {
        return { error: 'Organisationen hittades inte' };
      }

      // Check email uniqueness
      const existingUser = await prisma.user.findUnique({ where: { email: data.email } });
      if (existingUser) {
        return { error: 'En användare med denna e-postadress finns redan' };
      }

      const parsed = userSchema.safeParse(data);
      if (!parsed.success) {
        return { error: parsed.error.errors[0].message };
      }

      // Require password for new users
      if (!parsed.data.password) {
        return { error: 'Lösenord krävs för nya användare' };
      }

      try {
        const passwordHash = await bcrypt.hash(parsed.data.password, 12);

        const user = await prisma.user.create({
          data: {
            email: parsed.data.email,
            name: parsed.data.name,
            passwordHash,
            role: parsed.data.role,
            orgId: parsed.data.orgId,
            isActive: true,
          },
        });

        revalidatePath('/dashboard/users');
        revalidatePath('/admin/organizations');
        return { success: true, userId: user.id };
      } catch (error) {
        console.error('Failed to create user:', error);
        return { error: 'Kunde inte skapa användaren' };
      }
    }

    export async function updateUser(
      userId: string,
      data: Partial<Omit<UserFormData, 'password'> & { password?: string }>
    ) {
      const session = await auth();
      if (!session?.user) {
        return { error: 'Ej inloggad' };
      }

      const currentRole = session.user.role as Role;

      // Get target user
      const targetUser = await prisma.user.findUnique({ where: { id: userId } });
      if (!targetUser) {
        return { error: 'Användaren hittades inte' };
      }

      // Check permission to edit
      if (!hasPermission(currentRole, PERMISSIONS.USER_EDIT)) {
        return { error: 'Du har inte behörighet att redigera användare' };
      }

      // Org Admin can only edit users in their own org
      if (currentRole === ROLES.ORG_ADMIN && session.user.orgId !== targetUser.orgId) {
        return { error: 'Du kan bara redigera användare i din egen organisation' };
      }

      // Cannot change Super Admin users (or become Super Admin)
      if (targetUser.role === ROLES.SUPER_ADMIN || data.role === 'SUPER_ADMIN') {
        return { error: 'Super Admin-användare kan inte redigeras' };
      }

      try {
        const updateData: any = {};
        if (data.email) updateData.email = data.email;
        if (data.name) updateData.name = data.name;
        if (data.role) updateData.role = data.role;
        // Password update - only if provided (AUTH-04: admin password reset)
        if (data.password && data.password.length >= 8) {
          updateData.passwordHash = await bcrypt.hash(data.password, 12);
        }

        await prisma.user.update({
          where: { id: userId },
          data: updateData,
        });

        revalidatePath('/dashboard/users');
        return { success: true };
      } catch (error) {
        console.error('Failed to update user:', error);
        return { error: 'Kunde inte uppdatera användaren' };
      }
    }

    export async function deactivateUser(userId: string) {
      const session = await auth();
      if (!session?.user) {
        return { error: 'Ej inloggad' };
      }

      const currentRole = session.user.role as Role;

      if (!hasPermission(currentRole, PERMISSIONS.USER_DEACTIVATE)) {
        return { error: 'Du har inte behörighet att inaktivera användare' };
      }

      const targetUser = await prisma.user.findUnique({ where: { id: userId } });
      if (!targetUser) {
        return { error: 'Användaren hittades inte' };
      }

      // Org Admin can only deactivate users in their own org
      if (currentRole === ROLES.ORG_ADMIN && session.user.orgId !== targetUser.orgId) {
        return { error: 'Du kan bara inaktivera användare i din egen organisation' };
      }

      // Cannot deactivate Super Admin
      if (targetUser.role === ROLES.SUPER_ADMIN) {
        return { error: 'Super Admin-användare kan inte inaktiveras' };
      }

      // Cannot deactivate yourself
      if (targetUser.id === session.user.id) {
        return { error: 'Du kan inte inaktivera dig själv' };
      }

      try {
        await prisma.user.update({
          where: { id: userId },
          data: { isActive: false },
        });

        revalidatePath('/dashboard/users');
        return { success: true };
      } catch (error) {
        console.error('Failed to deactivate user:', error);
        return { error: 'Kunde inte inaktivera användaren' };
      }
    }

    export async function getUsers() {
      const session = await auth();
      if (!session?.user) {
        return { error: 'Ej inloggad', users: [] };
      }

      const currentRole = session.user.role as Role;

      // Super Admin sees all users
      if (hasPermission(currentRole, PERMISSIONS.USER_VIEW_ALL)) {
        const users = await prisma.user.findMany({
          orderBy: { name: 'asc' },
          include: {
            organization: {
              select: { name: true, slug: true },
            },
          },
        });
        return { users };
      }

      // Org Admin sees users in their org
      if (hasPermission(currentRole, PERMISSIONS.USER_VIEW_ORG) && session.user.orgId) {
        const tenantClient = createTenantClient(session.user.orgId);
        const users = await tenantClient.user.findMany({
          orderBy: { name: 'asc' },
          include: {
            organization: {
              select: { name: true, slug: true },
            },
          },
        });
        return { users };
      }

      return { error: 'Du har inte behörighet att se användare', users: [] };
    }

    export async function getUser(userId: string) {
      const session = await auth();
      if (!session?.user) {
        return { error: 'Ej inloggad' };
      }

      const user = await prisma.user.findUnique({
        where: { id: userId },
        include: {
          organization: {
            select: { id: true, name: true, slug: true },
          },
        },
      });

      if (!user) {
        return { error: 'Användaren hittades inte' };
      }

      // Check access
      const currentRole = session.user.role as Role;
      if (!hasPermission(currentRole, PERMISSIONS.USER_VIEW_ALL)) {
        if (currentRole === ROLES.ORG_ADMIN && session.user.orgId !== user.orgId) {
          return { error: 'Du har inte behörighet att se denna användare' };
        }
        if (currentRole === ROLES.CLOSER && session.user.id !== user.id) {
          return { error: 'Du har inte behörighet att se denna användare' };
        }
      }

      return { user };
    }
    ```
  </action>
  <verify>
    - Server actions compile without TypeScript errors
    - Role hierarchy is enforced (Super Admin > Org Admin > Closer)
    - Org Admin can only manage users in their own organization
    - Password is hashed with bcrypt
    - updateUser supports optional password field for admin password reset (AUTH-04)
  </verify>
  <done>User CRUD server actions with role hierarchy and org scoping created</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard layout and navigation</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/dashboard/page.tsx
    src/components/layout/dashboard-nav.tsx
  </files>
  <action>
    Create dashboard layout and navigation:

    **src/app/(dashboard)/layout.tsx:**
    ```typescript
    import { redirect } from 'next/navigation';
    import { auth } from '@/lib/auth/auth';
    import { DashboardNav } from '@/components/layout/dashboard-nav';

    export default async function DashboardLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      const session = await auth();

      if (!session?.user) {
        redirect('/login');
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <DashboardNav user={session.user} />
          <main className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            {children}
          </main>
        </div>
      );
    }
    ```

    **src/components/layout/dashboard-nav.tsx:**
    ```typescript
    'use client';

    import Link from 'next/link';
    import { useRouter } from 'next/navigation';
    import { Button } from '@/components/ui/button';
    import { logoutAction } from '@/actions/auth';
    import { ROLES } from '@/lib/auth/permissions';

    interface DashboardNavProps {
      user: {
        name: string;
        role: string;
        orgSlug: string | null;
      };
    }

    export function DashboardNav({ user }: DashboardNavProps) {
      const router = useRouter();
      const isSuperAdmin = user.role === ROLES.SUPER_ADMIN;
      const isOrgAdmin = user.role === ROLES.ORG_ADMIN;

      const handleLogout = async () => {
        await logoutAction();
        router.push('/login');
        router.refresh();
      };

      return (
        <nav className="bg-white border-b border-gray-200">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between h-16">
              <div className="flex items-center space-x-8">
                <Link href="/dashboard" className="text-xl font-semibold text-gray-900">
                  Kalkyla.se
                </Link>
                <div className="hidden md:flex space-x-4">
                  <Link
                    href="/dashboard"
                    className="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm"
                  >
                    Översikt
                  </Link>
                  {(isSuperAdmin || isOrgAdmin) && (
                    <Link
                      href="/dashboard/users"
                      className="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm"
                    >
                      Användare
                    </Link>
                  )}
                  {isOrgAdmin && (
                    <Link
                      href="/dashboard/settings"
                      className="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm"
                    >
                      Inställningar
                    </Link>
                  )}
                  {isSuperAdmin && (
                    <Link
                      href="/admin/organizations"
                      className="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm"
                    >
                      Admin
                    </Link>
                  )}
                </div>
              </div>
              <div className="flex items-center space-x-4">
                <span className="text-sm text-gray-500">
                  {user.name} ({user.role})
                </span>
                <Button variant="outline" size="sm" onClick={handleLogout}>
                  Logga ut
                </Button>
              </div>
            </div>
          </div>
        </nav>
      );
    }
    ```

    **src/app/(dashboard)/dashboard/page.tsx:**
    ```typescript
    import { auth } from '@/lib/auth/auth';
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

    export const metadata = {
      title: 'Dashboard - Kalkyla.se',
    };

    export default async function DashboardPage() {
      const session = await auth();

      return (
        <div>
          <h1 className="text-2xl font-bold text-gray-900 mb-6">
            Välkommen, {session?.user?.name}!
          </h1>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Kalkyler</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-3xl font-bold">0</p>
                <p className="text-sm text-gray-500">Totalt antal kalkyler</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Visningar</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-3xl font-bold">0</p>
                <p className="text-sm text-gray-500">Delningslänk-visningar</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Denna månad</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-3xl font-bold">0</p>
                <p className="text-sm text-gray-500">Nya kalkyler</p>
              </CardContent>
            </Card>
          </div>
        </div>
      );
    }
    ```
  </action>
  <verify>
    - Dashboard layout renders with navigation
    - Navigation shows correct links based on role
    - Logout button works
  </verify>
  <done>Dashboard layout with role-based navigation</done>
</task>

<task type="auto">
  <name>Task 3: Create user list page and components</name>
  <files>
    src/app/(dashboard)/dashboard/users/page.tsx
    src/components/users/user-list.tsx
  </files>
  <action>
    Create user list page with data table:

    **src/app/(dashboard)/dashboard/users/page.tsx:**
    ```typescript
    import { redirect } from 'next/navigation';
    import Link from 'next/link';
    import { auth } from '@/lib/auth/auth';
    import { getUsers } from '@/actions/users';
    import { UserList } from '@/components/users/user-list';
    import { Button } from '@/components/ui/button';
    import { hasPermission, PERMISSIONS, ROLES, Role } from '@/lib/auth/permissions';

    export const metadata = {
      title: 'Användare - Kalkyla.se',
    };

    export default async function UsersPage() {
      const session = await auth();
      if (!session?.user) redirect('/login');

      const role = session.user.role as Role;
      const canCreateOrgAdmin = hasPermission(role, PERMISSIONS.USER_CREATE_ORG_ADMIN);
      const canCreateCloser = hasPermission(role, PERMISSIONS.USER_CREATE_CLOSER);

      if (!canCreateOrgAdmin && !canCreateCloser) {
        redirect('/dashboard');
      }

      const { users, error } = await getUsers();

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold text-gray-900">Användare</h1>
            {(canCreateOrgAdmin || canCreateCloser) && (
              <Link href="/dashboard/users/new">
                <Button>Skapa användare</Button>
              </Link>
            )}
          </div>

          {error ? (
            <div className="text-red-600">{error}</div>
          ) : (
            <UserList users={users || []} currentUserRole={role} />
          )}
        </div>
      );
    }
    ```

    **src/components/users/user-list.tsx:**
    ```typescript
    'use client';

    import Link from 'next/link';
    import { useState, useTransition } from 'react';
    import { useRouter } from 'next/navigation';
    import { Button } from '@/components/ui/button';
    import { Card, CardContent } from '@/components/ui/card';
    import { deactivateUser } from '@/actions/users';
    import { hasPermission, PERMISSIONS, ROLES, Role } from '@/lib/auth/permissions';

    interface User {
      id: string;
      name: string;
      email: string;
      role: string;
      isActive: boolean;
      organization: {
        name: string;
        slug: string;
      } | null;
    }

    interface UserListProps {
      users: User[];
      currentUserRole: Role;
    }

    export function UserList({ users, currentUserRole }: UserListProps) {
      const [isPending, startTransition] = useTransition();
      const router = useRouter();

      const handleDeactivate = (userId: string, userName: string) => {
        if (!confirm(`Är du säker på att du vill inaktivera ${userName}?`)) return;

        startTransition(async () => {
          const result = await deactivateUser(userId);
          if (result.error) {
            alert(result.error);
          } else {
            router.refresh();
          }
        });
      };

      if (users.length === 0) {
        return (
          <Card>
            <CardContent className="text-center py-8 text-gray-500">
              Inga användare att visa.
            </CardContent>
          </Card>
        );
      }

      return (
        <div className="bg-white shadow rounded-lg overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  Namn
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  E-post
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  Roll
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  Organisation
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  Status
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  Åtgärder
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr key={user.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-medium text-gray-900">{user.name}</div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm text-gray-500">{user.email}</div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                      user.role === ROLES.SUPER_ADMIN
                        ? 'bg-purple-100 text-purple-800'
                        : user.role === ROLES.ORG_ADMIN
                        ? 'bg-blue-100 text-blue-800'
                        : 'bg-gray-100 text-gray-800'
                    }`}>
                      {user.role}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {user.organization?.name || '-'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    {user.isActive ? (
                      <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        Aktiv
                      </span>
                    ) : (
                      <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                        Inaktiv
                      </span>
                    )}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                    <Link
                      href={`/dashboard/users/${user.id}`}
                      className="text-blue-600 hover:text-blue-800"
                    >
                      Redigera
                    </Link>
                    {user.isActive && user.role !== ROLES.SUPER_ADMIN && (
                      <button
                        onClick={() => handleDeactivate(user.id, user.name)}
                        disabled={isPending}
                        className="text-red-600 hover:text-red-800"
                      >
                        Inaktivera
                      </button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }
    ```
  </action>
  <verify>
    - User list shows users with role badges
    - Deactivate button works with confirmation
    - Links to edit page work
  </verify>
  <done>User list page with data table and deactivation</done>
</task>

<task type="auto">
  <name>Task 4: Create user form and create/edit pages</name>
  <files>
    src/components/users/user-form.tsx
    src/app/(dashboard)/dashboard/users/new/page.tsx
    src/app/(dashboard)/dashboard/users/[id]/page.tsx
  </files>
  <action>
    Create user form with organization dropdown and create/edit pages:

    **src/components/users/user-form.tsx:**
    ```typescript
    'use client';

    import { useForm } from 'react-hook-form';
    import { zodResolver } from '@hookform/resolvers/zod';
    import { z } from 'zod';
    import { useState, useTransition, useEffect } from 'react';
    import { useRouter } from 'next/navigation';

    import { Button } from '@/components/ui/button';
    import { Input } from '@/components/ui/input';
    import { Label } from '@/components/ui/label';
    import { createUser, updateUser, UserFormData } from '@/actions/users';
    import { getOrganizations } from '@/actions/organizations';
    import { ROLES, hasPermission, PERMISSIONS, Role } from '@/lib/auth/permissions';

    const userSchema = z.object({
      email: z.string().email('Ogiltig e-postadress'),
      name: z.string().min(2, 'Namn måste vara minst 2 tecken'),
      password: z.string().min(8, 'Lösenordet måste vara minst 8 tecken').optional().or(z.literal('')),
      role: z.enum(['ORG_ADMIN', 'CLOSER']),
      orgId: z.string().min(1, 'Välj en organisation'),
    });

    type FormData = z.infer<typeof userSchema>;

    interface Organization {
      id: string;
      name: string;
      slug: string;
    }

    interface UserFormProps {
      user?: {
        id: string;
        email: string;
        name: string;
        role: string;
        orgId: string | null;
        organization?: {
          id: string;
          name: string;
          slug: string;
        } | null;
      };
      currentUserRole: Role;
      currentUserOrgId: string | null;
    }

    export function UserForm({ user, currentUserRole, currentUserOrgId }: UserFormProps) {
      const [error, setError] = useState<string | null>(null);
      const [isPending, startTransition] = useTransition();
      const [organizations, setOrganizations] = useState<Organization[]>([]);
      const [loadingOrgs, setLoadingOrgs] = useState(false);
      const router = useRouter();
      const isEditing = !!user;
      const isSuperAdmin = currentUserRole === ROLES.SUPER_ADMIN;
      const canCreateOrgAdmin = hasPermission(currentUserRole, PERMISSIONS.USER_CREATE_ORG_ADMIN);

      // Load organizations for Super Admin
      useEffect(() => {
        if (isSuperAdmin) {
          setLoadingOrgs(true);
          getOrganizations().then(({ organizations: orgs }) => {
            setOrganizations(orgs || []);
            setLoadingOrgs(false);
          });
        }
      }, [isSuperAdmin]);

      const {
        register,
        handleSubmit,
        formState: { errors },
      } = useForm<FormData>({
        resolver: zodResolver(userSchema),
        defaultValues: user ? {
          email: user.email,
          name: user.name,
          password: '',
          role: user.role as 'ORG_ADMIN' | 'CLOSER',
          orgId: user.orgId || '',
        } : {
          role: 'CLOSER',
          orgId: currentUserOrgId || '',
        },
      });

      const onSubmit = (data: FormData) => {
        setError(null);
        startTransition(async () => {
          // For editing, only include password if provided
          const submitData = isEditing
            ? {
                email: data.email,
                name: data.name,
                role: data.role,
                ...(data.password && data.password.length >= 8 ? { password: data.password } : {}),
              }
            : data;

          const result = isEditing
            ? await updateUser(user.id, submitData)
            : await createUser(data as UserFormData);

          if (result.error) {
            setError(result.error);
          } else {
            router.push('/dashboard/users');
            router.refresh();
          }
        });
      };

      // Determine available roles based on current user
      const availableRoles = canCreateOrgAdmin
        ? [{ value: 'ORG_ADMIN', label: 'Org Admin' }, { value: 'CLOSER', label: 'Closer' }]
        : [{ value: 'CLOSER', label: 'Closer' }];

      return (
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6 max-w-xl">
          {error && (
            <div className="p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm">
              {error}
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="name">Namn *</Label>
            <Input id="name" {...register('name')} />
            {errors.name && <p className="text-sm text-red-600">{errors.name.message}</p>}
          </div>

          <div className="space-y-2">
            <Label htmlFor="email">E-postadress *</Label>
            <Input id="email" type="email" {...register('email')} />
            {errors.email && <p className="text-sm text-red-600">{errors.email.message}</p>}
          </div>

          <div className="space-y-2">
            <Label htmlFor="password">
              {isEditing ? 'Nytt lösenord (valfritt)' : 'Lösenord *'}
            </Label>
            <Input
              id="password"
              type="password"
              {...register('password')}
              placeholder={isEditing ? 'Lämna tomt för att behålla nuvarande lösenord' : ''}
            />
            {errors.password && <p className="text-sm text-red-600">{errors.password.message}</p>}
            {isEditing && (
              <p className="text-xs text-gray-500">
                Lämna tomt för att behålla nuvarande lösenord. Minst 8 tecken för nytt lösenord.
              </p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="role">Roll *</Label>
            <select
              id="role"
              className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
              {...register('role')}
            >
              {availableRoles.map((role) => (
                <option key={role.value} value={role.value}>
                  {role.label}
                </option>
              ))}
            </select>
            {errors.role && <p className="text-sm text-red-600">{errors.role.message}</p>}
          </div>

          {/* Organization dropdown - only for Super Admin */}
          {isSuperAdmin ? (
            <div className="space-y-2">
              <Label htmlFor="orgId">Organisation *</Label>
              {loadingOrgs ? (
                <p className="text-sm text-gray-500">Laddar organisationer...</p>
              ) : (
                <select
                  id="orgId"
                  className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                  {...register('orgId')}
                  disabled={isEditing}
                >
                  <option value="">Välj organisation</option>
                  {organizations.map((org) => (
                    <option key={org.id} value={org.id}>
                      {org.name} ({org.slug})
                    </option>
                  ))}
                </select>
              )}
              {errors.orgId && <p className="text-sm text-red-600">{errors.orgId.message}</p>}
              {isEditing && (
                <p className="text-xs text-gray-500">
                  Organisation kan inte ändras efter att användaren skapats.
                </p>
              )}
            </div>
          ) : (
            /* Org Admin - hidden field with their org */
            <input type="hidden" {...register('orgId')} value={currentUserOrgId || ''} />
          )}

          <div className="flex gap-4 pt-4">
            <Button type="submit" disabled={isPending}>
              {isPending ? 'Sparar...' : isEditing ? 'Spara ändringar' : 'Skapa användare'}
            </Button>
            <Button type="button" variant="outline" onClick={() => router.back()}>
              Avbryt
            </Button>
          </div>
        </form>
      );
    }
    ```

    **src/app/(dashboard)/dashboard/users/new/page.tsx:**
    ```typescript
    import { redirect } from 'next/navigation';
    import { auth } from '@/lib/auth/auth';
    import { UserForm } from '@/components/users/user-form';
    import { hasPermission, PERMISSIONS, Role } from '@/lib/auth/permissions';

    export const metadata = {
      title: 'Skapa användare - Kalkyla.se',
    };

    export default async function NewUserPage() {
      const session = await auth();
      if (!session?.user) redirect('/login');

      const role = session.user.role as Role;
      const canCreateOrgAdmin = hasPermission(role, PERMISSIONS.USER_CREATE_ORG_ADMIN);
      const canCreateCloser = hasPermission(role, PERMISSIONS.USER_CREATE_CLOSER);

      if (!canCreateOrgAdmin && !canCreateCloser) {
        redirect('/dashboard');
      }

      return (
        <div>
          <h1 className="text-2xl font-bold text-gray-900 mb-6">Skapa ny användare</h1>
          <UserForm
            currentUserRole={role}
            currentUserOrgId={session.user.orgId}
          />
        </div>
      );
    }
    ```

    **src/app/(dashboard)/dashboard/users/[id]/page.tsx:**
    ```typescript
    import { redirect, notFound } from 'next/navigation';
    import { auth } from '@/lib/auth/auth';
    import { getUser } from '@/actions/users';
    import { UserForm } from '@/components/users/user-form';
    import { hasPermission, PERMISSIONS, ROLES, Role } from '@/lib/auth/permissions';

    export const metadata = {
      title: 'Redigera användare - Kalkyla.se',
    };

    export default async function EditUserPage({
      params,
    }: {
      params: Promise<{ id: string }>;
    }) {
      const session = await auth();
      if (!session?.user) redirect('/login');

      const role = session.user.role as Role;

      if (!hasPermission(role, PERMISSIONS.USER_EDIT)) {
        redirect('/dashboard');
      }

      const { id } = await params;
      const { user, error } = await getUser(id);

      if (error || !user) {
        notFound();
      }

      // Prevent editing Super Admin users
      if (user.role === ROLES.SUPER_ADMIN) {
        redirect('/dashboard/users');
      }

      return (
        <div>
          <h1 className="text-2xl font-bold text-gray-900 mb-6">
            Redigera {user.name}
          </h1>
          <UserForm
            user={user}
            currentUserRole={role}
            currentUserOrgId={session.user.orgId}
          />
        </div>
      );
    }
    ```
  </action>
  <verify>
    - Create page shows form with role dropdown
    - Super Admin sees organization dropdown with all organizations
    - Org Admin does not see organization dropdown (uses their org)
    - Edit page loads existing user data
    - Edit page shows optional password field with "Leave blank to keep current" hint
    - Password update works when provided (AUTH-04)
  </verify>
  <done>User form with organization dropdown and create/edit pages</done>
</task>

<task type="auto">
  <name>Task 5: Create database seed script</name>
  <files>
    prisma/seed.ts
    package.json
  </files>
  <action>
    Create seed script for initial Super Admin and test data:

    **prisma/seed.ts:**
    ```typescript
    import { PrismaClient } from '@prisma/client';
    import bcrypt from 'bcryptjs';

    const prisma = new PrismaClient();

    async function main() {
      console.log('Seeding database...');

      // Create Super Admin
      const superAdminPassword = await bcrypt.hash('superadmin123', 12);
      const superAdmin = await prisma.user.upsert({
        where: { email: 'admin@kalkyla.se' },
        update: {},
        create: {
          email: 'admin@kalkyla.se',
          name: 'Super Admin',
          passwordHash: superAdminPassword,
          role: 'SUPER_ADMIN',
          isActive: true,
        },
      });
      console.log('Created Super Admin:', superAdmin.email);

      // Create a test organization
      const testOrg = await prisma.organization.upsert({
        where: { slug: 'test-solar' },
        update: {},
        create: {
          name: 'Test Solar AB',
          slug: 'test-solar',
          primaryColor: '#3B82F6',
          secondaryColor: '#1E40AF',
          isProffsKontaktAffiliated: false,
        },
      });
      console.log('Created test organization:', testOrg.slug);

      // Create Org Admin for test org
      const orgAdminPassword = await bcrypt.hash('orgadmin123', 12);
      const orgAdmin = await prisma.user.upsert({
        where: { email: 'admin@test-solar.se' },
        update: {},
        create: {
          email: 'admin@test-solar.se',
          name: 'Test Org Admin',
          passwordHash: orgAdminPassword,
          role: 'ORG_ADMIN',
          orgId: testOrg.id,
          isActive: true,
        },
      });
      console.log('Created Org Admin:', orgAdmin.email);

      // Create Closer for test org
      const closerPassword = await bcrypt.hash('closer123', 12);
      const closer = await prisma.user.upsert({
        where: { email: 'closer@test-solar.se' },
        update: {},
        create: {
          email: 'closer@test-solar.se',
          name: 'Test Closer',
          passwordHash: closerPassword,
          role: 'CLOSER',
          orgId: testOrg.id,
          isActive: true,
        },
      });
      console.log('Created Closer:', closer.email);

      // Create a ProffsKontakt-affiliated org
      const proffsOrg = await prisma.organization.upsert({
        where: { slug: 'proffs-partner' },
        update: {},
        create: {
          name: 'ProffsKontakt Partner AB',
          slug: 'proffs-partner',
          primaryColor: '#10B981',
          secondaryColor: '#059669',
          isProffsKontaktAffiliated: true,
          partnerCutPercent: 15,
          marginAlertThreshold: 20,
        },
      });
      console.log('Created ProffsKontakt org:', proffsOrg.slug);

      console.log('Seeding complete!');
      console.log('');
      console.log('Test accounts:');
      console.log('  Super Admin: admin@kalkyla.se / superadmin123');
      console.log('  Org Admin:   admin@test-solar.se / orgadmin123');
      console.log('  Closer:      closer@test-solar.se / closer123');
    }

    main()
      .catch((e) => {
        console.error(e);
        process.exit(1);
      })
      .finally(async () => {
        await prisma.$disconnect();
      });
    ```

    Add to **package.json** in prisma config:
    ```json
    {
      "prisma": {
        "seed": "ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"
      }
    }
    ```

    Install ts-node:
    ```bash
    npm install -D ts-node
    ```

    Run seed:
    ```bash
    npx prisma db seed
    ```
  </action>
  <verify>
    - `npx prisma db seed` runs without errors
    - Super Admin can log in with seeded credentials
    - Test organization exists in database
    - All three test users (Super Admin, Org Admin, Closer) can log in
  </verify>
  <done>Database seed script creates Super Admin, test organization, and test users</done>
</task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **Seed database:**
   ```bash
   npx prisma db push
   npx prisma db seed
   ```

2. **Test login for all roles:**
   - Log in as admin@kalkyla.se (Super Admin)
   - Navigate to /dashboard/users - see all users
   - Navigate to /admin/organizations - see all orgs
   - Log out and log in as admin@test-solar.se (Org Admin)
   - Navigate to /dashboard/users - see only org users
   - Cannot access /admin routes
   - Log out and log in as closer@test-solar.se (Closer)
   - Cannot access /dashboard/users

3. **User creation tests:**
   - As Super Admin, create new Org Admin (select organization from dropdown)
   - As Org Admin, create new Closer (no org dropdown shown)
   - As Org Admin, attempt to create Org Admin - should only see Closer option

4. **User edit tests (AUTH-04):**
   - As Super Admin, edit a user
   - Leave password blank - user keeps current password
   - Enter new password - user password is updated
</verification>

<success_criteria>
- Super Admin can create Org Admins for any organization (via dropdown)
- Org Admin can create Closers for their organization only
- Users are properly scoped to their organizations
- Admin can reset user password via edit form (AUTH-04)
- Deactivate functionality works with proper authorization
- Seed script creates working test accounts
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
