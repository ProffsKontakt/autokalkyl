---
phase: 01-foundation
plan: 07
type: execute
wave: 5
depends_on: ["01-05"]
files_modified:
  - src/app/(dashboard)/dashboard/settings/page.tsx
  - src/app/(dashboard)/dashboard/settings/org-branding-form.tsx
  - src/actions/organizations.ts
autonomous: true

must_haves:
  truths:
    - "Org Admin can access organization settings page"
    - "Org Admin can edit organization branding (logo, colors)"
    - "Org Admin cannot change ProffsKontakt affiliation status"
    - "Changes are saved and reflected in organization data"
  artifacts:
    - path: "src/app/(dashboard)/dashboard/settings/page.tsx"
      provides: "Organization settings page"
      min_lines: 20
    - path: "src/app/(dashboard)/dashboard/settings/org-branding-form.tsx"
      provides: "Branding edit form"
      contains: "useForm"
  key_links:
    - from: "src/app/(dashboard)/dashboard/settings/page.tsx"
      to: "src/actions/organizations.ts"
      via: "updateOrganization action"
      pattern: "updateOrganization"
---

<objective>
Create organization settings page for Org Admin to manage branding.

Purpose: Allow Org Admins to customize their organization's branding (logo, colors) without Super Admin involvement. Implements ORG-06 and ORG-07.

Output: Settings page with branding form that updates organization data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-04-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create organization settings page</name>
  <files>
    src/app/(dashboard)/dashboard/settings/page.tsx
    src/app/(dashboard)/dashboard/settings/org-branding-form.tsx
  </files>
  <action>
    Create settings page accessible to Org Admins:

    **src/app/(dashboard)/dashboard/settings/page.tsx:**
    ```typescript
    import { redirect, notFound } from 'next/navigation';
    import { auth } from '@/lib/auth/auth';
    import { getOrganization } from '@/actions/organizations';
    import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
    import { OrgBrandingForm } from './org-branding-form';
    import { hasPermission, PERMISSIONS, ROLES, Role } from '@/lib/auth/permissions';

    export const metadata = {
      title: 'Installningar - Kalkyla.se',
    };

    export default async function SettingsPage() {
      const session = await auth();
      if (!session?.user) redirect('/login');

      const role = session.user.role as Role;

      // Only Org Admin can access settings (Super Admin uses admin panel)
      if (role !== ROLES.ORG_ADMIN) {
        redirect('/dashboard');
      }

      if (!session.user.orgId) {
        redirect('/dashboard');
      }

      const { organization, error } = await getOrganization(session.user.orgId);

      if (error || !organization) {
        notFound();
      }

      return (
        <div className="space-y-6">
          <h1 className="text-2xl font-bold text-gray-900">Organisationsinstallningar</h1>

          <Card>
            <CardHeader>
              <CardTitle>Grunduppgifter</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <span className="text-sm text-gray-500">Organisationsnamn</span>
                <p className="font-medium">{organization.name}</p>
              </div>
              <div>
                <span className="text-sm text-gray-500">Slug (URL)</span>
                <p className="font-medium">{organization.slug}</p>
                <p className="text-xs text-gray-400">
                  Dina delade kalkyler visas pa: kalkyla.se/{organization.slug}/...
                </p>
              </div>
              {organization.isProffsKontaktAffiliated && (
                <div>
                  <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                    ProffsKontakt-affilierad
                  </span>
                  {organization.partnerCutPercent && (
                    <p className="text-xs text-gray-500 mt-1">
                      Partner-provision: {organization.partnerCutPercent}%
                    </p>
                  )}
                </div>
              )}
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Varum√§rke</CardTitle>
            </CardHeader>
            <CardContent>
              <OrgBrandingForm
                organizationId={organization.id}
                defaultValues={{
                  logoUrl: organization.logoUrl || '',
                  primaryColor: organization.primaryColor,
                  secondaryColor: organization.secondaryColor,
                }}
              />
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Organisation-statistik</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-3 gap-4 text-center">
                <div>
                  <p className="text-2xl font-bold">{organization.users?.length || 0}</p>
                  <p className="text-sm text-gray-500">Anvandare</p>
                </div>
                <div>
                  <p className="text-2xl font-bold">0</p>
                  <p className="text-sm text-gray-500">Kalkyler</p>
                </div>
                <div>
                  <p className="text-2xl font-bold">0</p>
                  <p className="text-sm text-gray-500">Visningar</p>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      );
    }
    ```

    **src/app/(dashboard)/dashboard/settings/org-branding-form.tsx:**
    ```typescript
    'use client';

    import { useForm } from 'react-hook-form';
    import { zodResolver } from '@hookform/resolvers/zod';
    import { z } from 'zod';
    import { useState, useTransition } from 'react';
    import { useRouter } from 'next/navigation';

    import { Button } from '@/components/ui/button';
    import { Input } from '@/components/ui/input';
    import { Label } from '@/components/ui/label';
    import { updateOrganization } from '@/actions/organizations';

    const brandingSchema = z.object({
      logoUrl: z.string().url('Ogiltig URL').optional().or(z.literal('')),
      primaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/, 'Ogiltig fargkod'),
      secondaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/, 'Ogiltig fargkod'),
    });

    type BrandingFormData = z.infer<typeof brandingSchema>;

    interface OrgBrandingFormProps {
      organizationId: string;
      defaultValues: BrandingFormData;
    }

    export function OrgBrandingForm({ organizationId, defaultValues }: OrgBrandingFormProps) {
      const [success, setSuccess] = useState(false);
      const [error, setError] = useState<string | null>(null);
      const [isPending, startTransition] = useTransition();
      const router = useRouter();

      const {
        register,
        handleSubmit,
        watch,
        formState: { errors },
      } = useForm<BrandingFormData>({
        resolver: zodResolver(brandingSchema),
        defaultValues,
      });

      const primaryColor = watch('primaryColor');
      const secondaryColor = watch('secondaryColor');

      const onSubmit = (data: BrandingFormData) => {
        setError(null);
        setSuccess(false);
        startTransition(async () => {
          const result = await updateOrganization(organizationId, data);
          if (result.error) {
            setError(result.error);
          } else {
            setSuccess(true);
            router.refresh();
            // Clear success after 3 seconds
            setTimeout(() => setSuccess(false), 3000);
          }
        });
      };

      return (
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {error && (
            <div className="p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm">
              {error}
            </div>
          )}

          {success && (
            <div className="p-3 bg-green-50 border border-green-200 rounded-md text-green-700 text-sm">
              Andringarna har sparats!
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="logoUrl">Logotyp URL</Label>
            <Input
              id="logoUrl"
              type="url"
              placeholder="https://example.com/logo.png"
              {...register('logoUrl')}
            />
            {errors.logoUrl && (
              <p className="text-sm text-red-600">{errors.logoUrl.message}</p>
            )}
            <p className="text-xs text-gray-500">
              Lankning till er logotyp. Rekommenderad storlek: 200x50 px (PNG eller SVG)
            </p>
          </div>

          <div className="grid grid-cols-2 gap-6">
            <div className="space-y-2">
              <Label htmlFor="primaryColor">Primarfarg</Label>
              <div className="flex gap-2">
                <Input
                  type="color"
                  className="w-12 h-10 p-1 cursor-pointer"
                  {...register('primaryColor')}
                />
                <Input {...register('primaryColor')} />
              </div>
              {errors.primaryColor && (
                <p className="text-sm text-red-600">{errors.primaryColor.message}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="secondaryColor">Sekundarfarg</Label>
              <div className="flex gap-2">
                <Input
                  type="color"
                  className="w-12 h-10 p-1 cursor-pointer"
                  {...register('secondaryColor')}
                />
                <Input {...register('secondaryColor')} />
              </div>
              {errors.secondaryColor && (
                <p className="text-sm text-red-600">{errors.secondaryColor.message}</p>
              )}
            </div>
          </div>

          {/* Preview */}
          <div className="border rounded-lg p-4 bg-gray-50">
            <p className="text-sm text-gray-500 mb-3">Forhandsgranskning:</p>
            <div className="flex items-center gap-4">
              <div
                className="w-24 h-8 rounded flex items-center justify-center text-white text-sm font-medium"
                style={{ backgroundColor: primaryColor }}
              >
                Knapp
              </div>
              <div
                className="w-24 h-8 rounded flex items-center justify-center text-white text-sm font-medium"
                style={{ backgroundColor: secondaryColor }}
              >
                Sekundar
              </div>
            </div>
          </div>

          <Button type="submit" disabled={isPending}>
            {isPending ? 'Sparar...' : 'Spara andringar'}
          </Button>
        </form>
      );
    }
    ```
  </action>
  <verify>
    - Settings page only accessible to Org Admin
    - Branding form shows current values
    - Color pickers work and preview updates
    - Form submission updates organization
    - Success message displays after save
  </verify>
  <done>Organization settings page with branding form for Org Admins</done>
</task>

<task type="auto">
  <name>Task 2: Add calculations view page for Org Admin</name>
  <files>
    src/app/(dashboard)/dashboard/calculations/page.tsx
  </files>
  <action>
    Create placeholder calculations page that shows org's calculations (implements ORG-07):

    **src/app/(dashboard)/dashboard/calculations/page.tsx:**
    ```typescript
    import { redirect } from 'next/navigation';
    import { auth } from '@/lib/auth/auth';
    import { Card, CardContent } from '@/components/ui/card';
    import { Button } from '@/components/ui/button';
    import Link from 'next/link';

    export const metadata = {
      title: 'Kalkyler - Kalkyla.se',
    };

    export default async function CalculationsPage() {
      const session = await auth();
      if (!session?.user) redirect('/login');

      // Placeholder - will be implemented in Phase 2
      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold text-gray-900">Kalkyler</h1>
            <Link href="/dashboard/calculations/new">
              <Button>Ny kalkyl</Button>
            </Link>
          </div>

          <Card>
            <CardContent className="py-12 text-center">
              <p className="text-gray-500 mb-4">
                Du har inga kalkyler annu.
              </p>
              <p className="text-sm text-gray-400">
                Skapa din forsta ROI-kalkyl for att komma igang!
              </p>
            </CardContent>
          </Card>
        </div>
      );
    }
    ```

    Update navigation in **src/components/layout/dashboard-nav.tsx** to include Calculations link for all authenticated users:

    Add this link before the Users link:
    ```typescript
    <Link
      href="/dashboard/calculations"
      className="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm"
    >
      Kalkyler
    </Link>
    ```
  </action>
  <verify>
    - Calculations page renders
    - All authenticated users can access it
    - Navigation includes Kalkyler link
  </verify>
  <done>Placeholder calculations page and updated navigation</done>
</task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **Type checking:**
   ```bash
   npx tsc --noEmit
   ```

2. **Build verification:**
   ```bash
   npm run build
   ```

3. **Org Admin settings access:**
   - Log in as admin@test-solar.se (Org Admin)
   - Navigate to /dashboard/settings
   - See organization details and branding form
   - Change colors, save
   - Verify changes saved

4. **Access control:**
   - As Org Admin, confirm no access to /admin routes
   - As Closer, confirm no access to /dashboard/settings
   - As Super Admin, confirm redirected away from /dashboard/settings (use admin panel instead)
</verification>

<success_criteria>
- Org Admin can access /dashboard/settings
- Org Admin can edit branding (logo, colors)
- Org Admin cannot change ProffsKontakt affiliation (field not shown)
- Changes persist and are reflected in UI
- Closers and Super Admins redirected appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-07-SUMMARY.md`
</output>
