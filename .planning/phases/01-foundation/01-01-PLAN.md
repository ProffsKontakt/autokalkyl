---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - tailwind.config.ts
  - tsconfig.json
  - prisma/schema.prisma
  - src/lib/db/client.ts
  - src/lib/db/tenant-client.ts
  - .env.example
  - .env.local
autonomous: true
user_setup:
  - service: neon
    why: "PostgreSQL database hosting"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Console -> Project -> Connection Details -> Connection string (pooled)"

must_haves:
  truths:
    - "Next.js 15 app compiles and runs on localhost"
    - "Prisma can connect to Neon database"
    - "Database schema includes User, Organization, and Role tables"
    - "Tenant-scoped Prisma client filters queries by orgId"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "next"
    - path: "prisma/schema.prisma"
      provides: "Database schema"
      contains: "model User"
    - path: "src/lib/db/client.ts"
      provides: "Base Prisma client"
      exports: ["prisma"]
    - path: "src/lib/db/tenant-client.ts"
      provides: "Tenant-scoped client factory"
      exports: ["createTenantClient"]
  key_links:
    - from: "src/lib/db/tenant-client.ts"
      to: "src/lib/db/client.ts"
      via: "imports and extends"
      pattern: "prisma\\.\\$extends"
---

<objective>
Initialize Next.js 15 project with Prisma ORM and PostgreSQL database schema for multi-tenant SaaS.

Purpose: Establish the foundational project structure and database models that all subsequent features depend on. This includes the critical tenant-scoping pattern that prevents data leakage.

Output: Working Next.js app with Prisma connected to Neon, core database models, and tenant-scoped client factory.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js 15 project with dependencies</name>
  <files>
    package.json
    next.config.ts
    tailwind.config.ts
    tsconfig.json
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
  </files>
  <action>
    Create Next.js 15.5+ project using create-next-app with these options:
    - TypeScript enabled
    - Tailwind CSS v4 enabled
    - App Router (src/app directory)
    - ESLint enabled
    - No import alias customization (use default @/)

    After project creation, install additional dependencies:
    ```bash
    npm install prisma @prisma/client
    npm install next-auth@5 @auth/prisma-adapter bcryptjs
    npm install zod react-hook-form @hookform/resolvers
    npm install @tanstack/react-query
    npm install -D @types/bcryptjs
    ```

    Configure next.config.ts for Prisma edge compatibility:
    ```typescript
    const nextConfig = {
      experimental: {
        serverComponentsExternalPackages: ['@prisma/client', 'bcryptjs'],
      },
    };
    ```

    Update root layout.tsx with basic HTML structure and metadata for Kalkyla.se.
  </action>
  <verify>
    - `npm run dev` starts server without errors
    - `npm run build` completes successfully
    - Localhost:3000 shows Next.js app
  </verify>
  <done>Next.js 15 project runs locally with all dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create Prisma schema with multi-tenant models</name>
  <files>
    prisma/schema.prisma
    .env.example
    .env.local
  </files>
  <action>
    Initialize Prisma and create comprehensive schema for Phase 1:

    ```bash
    npx prisma init
    ```

    Define schema with these models:

    **Organization model:**
    - id (cuid)
    - name (string)
    - slug (string, unique) - for URLs like /acme-solar/calc123
    - logoUrl (string, optional)
    - primaryColor (string, default "#3B82F6")
    - secondaryColor (string, default "#1E40AF")
    - isProffsKontaktAffiliated (boolean, default false)
    - partnerCutPercent (decimal, optional) - only for affiliated orgs
    - marginAlertThreshold (decimal, optional)
    - createdAt, updatedAt timestamps

    **User model:**
    - id (cuid)
    - email (string, unique)
    - passwordHash (string)
    - name (string)
    - role (enum: SUPER_ADMIN, ORG_ADMIN, CLOSER)
    - orgId (string, optional) - null for SUPER_ADMIN
    - isActive (boolean, default true)
    - createdAt, updatedAt timestamps
    - Relation to Organization

    **Session model (for Auth.js):**
    - id (cuid)
    - sessionToken (string, unique)
    - userId (string)
    - expires (datetime)

    **Account model (for Auth.js):**
    - Standard Auth.js Prisma adapter fields

    **PasswordResetToken model:**
    - id (cuid)
    - token (string, unique)
    - userId (string)
    - expiresAt (datetime)
    - usedAt (datetime, optional)

    Add indexes:
    - @@index([orgId]) on User
    - @@index([slug]) on Organization
    - @@index([email]) on User

    Create .env.example with DATABASE_URL placeholder.
    Create .env.local (gitignored) with actual Neon connection string placeholder.
  </action>
  <verify>
    - `npx prisma validate` passes without errors
    - `npx prisma generate` creates client successfully
    - Schema includes all required models with proper relations
  </verify>
  <done>Prisma schema defines User, Organization, Session, Account, PasswordResetToken models with proper indexes and relations</done>
</task>

<task type="auto">
  <name>Task 3: Create Prisma client with tenant-scoping extension</name>
  <files>
    src/lib/db/client.ts
    src/lib/db/tenant-client.ts
  </files>
  <action>
    Create base Prisma client singleton in src/lib/db/client.ts:
    ```typescript
    import { PrismaClient } from '@prisma/client';

    const globalForPrisma = globalThis as unknown as {
      prisma: PrismaClient | undefined;
    };

    export const prisma = globalForPrisma.prisma ?? new PrismaClient({
      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
    });

    if (process.env.NODE_ENV !== 'production') {
      globalForPrisma.prisma = prisma;
    }
    ```

    Create tenant-scoped client factory in src/lib/db/tenant-client.ts:
    ```typescript
    import { prisma } from './client';

    export function createTenantClient(orgId: string) {
      return prisma.$extends({
        query: {
          // Auto-filter all queries on tenant-scoped models
          user: {
            async $allOperations({ args, query, operation }) {
              if (operation === 'findMany' || operation === 'findFirst' || operation === 'count') {
                args.where = { ...args.where, orgId };
              }
              if (operation === 'create') {
                args.data = { ...args.data, orgId };
              }
              return query(args);
            },
          },
          // Add more models as they're created (Calculation, etc.)
        },
      });
    }

    export type TenantPrismaClient = ReturnType<typeof createTenantClient>;
    ```

    This pattern ensures:
    - Base client for SUPER_ADMIN operations (cross-org access)
    - Tenant client auto-filters by orgId (prevents data leakage)
    - Type-safe with proper TypeScript inference
  </action>
  <verify>
    - TypeScript compiles without errors
    - Both exports are properly typed
    - Extension pattern follows Prisma 6.x best practices
  </verify>
  <done>Prisma client singleton and tenant-scoped extension factory are created with proper TypeScript types</done>
</task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **Build verification:**
   ```bash
   npm run build
   ```
   Should complete without errors.

2. **Prisma verification:**
   ```bash
   npx prisma validate
   npx prisma generate
   ```
   Should pass and generate client.

3. **Database connection (requires Neon setup):**
   ```bash
   npx prisma db push
   ```
   Should create tables in Neon database.

4. **Type checking:**
   ```bash
   npx tsc --noEmit
   ```
   Should pass without type errors.
</verification>

<success_criteria>
- Next.js 15 dev server runs on localhost:3000
- Prisma schema validates with all Phase 1 models
- Tenant-scoped client factory compiles and exports correctly
- All npm scripts (dev, build, lint) work
- .env.example documents required environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
