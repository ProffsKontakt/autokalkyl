---
phase: 04-customer-experience
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(public)/[org]/[shareCode]/page.tsx
  - src/app/(public)/[org]/[shareCode]/loading.tsx
  - src/app/(public)/[org]/[shareCode]/not-found.tsx
  - src/app/(public)/layout.tsx
  - src/middleware.ts
  - src/components/public/public-header.tsx
  - src/components/public/public-greeting.tsx
  - src/components/public/public-battery-summary.tsx
  - src/components/public/public-results-view.tsx
  - src/components/public/public-footer.tsx
  - src/components/public/password-gate.tsx
autonomous: true

must_haves:
  truths:
    - "Public URL accessible without authentication"
    - "Public view displays organization branding (logo, colors)"
    - "Public view shows personalized greeting with customer name"
    - "Public view shows battery specs and pricing (no margin)"
    - "Public view shows savings breakdown and ROI charts"
    - "Invalid/expired links show friendly error with contact info"
  artifacts:
    - path: "src/app/(public)/[org]/[shareCode]/page.tsx"
      provides: "Main public view page"
      min_lines: 50
    - path: "src/components/public/public-header.tsx"
      provides: "Branded header component"
      exports: ["PublicHeader"]
    - path: "src/components/public/public-results-view.tsx"
      provides: "Read-only results display"
      exports: ["PublicResultsView"]
  key_links:
    - from: "src/app/(public)/[org]/[shareCode]/page.tsx"
      to: "src/actions/share.ts"
      via: "getPublicCalculation call"
      pattern: "getPublicCalculation"
    - from: "src/middleware.ts"
      to: "auth callback"
      via: "public route bypass"
      pattern: "pathname\\.startsWith.*public|\\[org\\]"
---

<objective>
Create the public route structure and view components for prospects to access shared calculations without authentication.

Purpose: Prospects can view branded, interactive ROI calculations via shareable links
Output: Public route with org branding, greeting, battery specs, and results display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-experience/04-CONTEXT.md
@.planning/phases/04-customer-experience/04-01-SUMMARY.md
@src/actions/share.ts
@src/lib/share/types.ts
@src/middleware.ts
@src/lib/auth/auth.config.ts
@src/components/calculations/results/summary-cards.tsx
@src/components/calculations/results/savings-breakdown.tsx
@src/components/calculations/results/roi-timeline-chart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Public route structure and middleware</name>
  <files>src/app/(public)/layout.tsx, src/app/(public)/[org]/[shareCode]/page.tsx, src/app/(public)/[org]/[shareCode]/loading.tsx, src/app/(public)/[org]/[shareCode]/not-found.tsx, src/middleware.ts</files>
  <action>
Create `src/app/(public)/layout.tsx`:

```typescript
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'Batterikalkyl | Kalkyla.se',
  description: 'Din personliga batterikalkyl',
}

export default function PublicLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // Minimal layout - no nav, no auth context
  return (
    <div className="min-h-screen bg-gray-50">
      {children}
    </div>
  )
}
```

Create `src/app/(public)/[org]/[shareCode]/page.tsx`:

```typescript
import { getPublicCalculation, recordView } from '@/actions/share'
import { notFound } from 'next/navigation'
import { headers } from 'next/headers'
import { PublicHeader } from '@/components/public/public-header'
import { PublicGreeting } from '@/components/public/public-greeting'
import { PublicBatterySummary } from '@/components/public/public-battery-summary'
import { PublicResultsView } from '@/components/public/public-results-view'
import { PublicFooter } from '@/components/public/public-footer'
import { PasswordGate } from '@/components/public/password-gate'

interface PageProps {
  params: Promise<{
    org: string
    shareCode: string
  }>
  searchParams: Promise<{
    pwd?: string
  }>
}

export default async function PublicCalculationPage({ params, searchParams }: PageProps) {
  const { org, shareCode } = await params
  const { pwd } = await searchParams

  // Fetch public calculation data
  const result = await getPublicCalculation(org, shareCode, pwd)

  // Password required - show gate
  if (result.passwordRequired) {
    return (
      <PasswordGate
        orgSlug={org}
        shareCode={shareCode}
        error={undefined}
      />
    )
  }

  // Error (expired, not found, wrong password)
  if (result.error) {
    if (result.error === 'Fel lösenord') {
      return (
        <PasswordGate
          orgSlug={org}
          shareCode={shareCode}
          error={result.error}
        />
      )
    }
    notFound()
  }

  if (!result.data) {
    notFound()
  }

  const { calculation, organization, closer } = result.data

  // Record view (fire-and-forget)
  const headersList = await headers()
  const userAgent = headersList.get('user-agent')
  const forwardedFor = headersList.get('x-forwarded-for')
  const ip = forwardedFor?.split(',')[0] || headersList.get('x-real-ip')
  recordView(calculation.id, userAgent, ip)

  // Get primary battery (first one)
  const primaryBattery = calculation.batteries[0]
  const results = calculation.results

  return (
    <div
      className="min-h-screen"
      style={{
        '--primary-color': organization.primaryColor,
        '--secondary-color': organization.secondaryColor,
      } as React.CSSProperties}
    >
      <PublicHeader
        orgName={organization.name}
        logoUrl={organization.logoUrl}
        primaryColor={organization.primaryColor}
      />

      <main className="max-w-4xl mx-auto px-4 py-8 space-y-8">
        <PublicGreeting
          customerName={calculation.customerName}
          closerName={closer.name}
          customGreeting={calculation.customGreeting}
        />

        {primaryBattery && results && (
          <>
            <PublicBatterySummary
              battery={primaryBattery}
              allBatteries={calculation.batteries}
              results={results}
            />

            <PublicResultsView
              results={results}
              primaryColor={organization.primaryColor}
            />
          </>
        )}
      </main>

      <PublicFooter
        closerName={closer.name}
        primaryColor={organization.primaryColor}
      />
    </div>
  )
}
```

Create `src/app/(public)/[org]/[shareCode]/loading.tsx`:

```typescript
export default function Loading() {
  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
      <div className="text-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p className="mt-4 text-gray-600">Laddar din kalkyl...</p>
      </div>
    </div>
  )
}
```

Create `src/app/(public)/[org]/[shareCode]/not-found.tsx`:

```typescript
import Link from 'next/link'

export default function NotFound() {
  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center px-4">
      <div className="max-w-md text-center">
        <h1 className="text-4xl font-bold text-gray-900 mb-4">
          Kalkylen hittades inte
        </h1>
        <p className="text-gray-600 mb-6">
          Länken kan ha gått ut eller så har kalkylen tagits bort.
          Kontakta din säljare för att få en ny länk.
        </p>
        <div className="bg-white rounded-lg shadow p-6">
          <p className="text-sm text-gray-500 mb-2">Behöver du hjälp?</p>
          <p className="text-gray-700">
            Kontakta säljaren som skickade länken till dig.
          </p>
        </div>
        <Link
          href="https://kalkyla.se"
          className="inline-block mt-6 text-blue-600 hover:underline"
        >
          Besök Kalkyla.se
        </Link>
      </div>
    </div>
  )
}
```

Update `src/middleware.ts` to ensure public routes bypass auth:

The current auth config already allows non-dashboard/admin routes. Verify the middleware properly handles the (public) route group.

If using route matcher, ensure it excludes public routes:
```typescript
export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|public|api/auth).*)',
  ],
}
```

The auth.config.ts `authorized` callback should already return true for routes not starting with `/dashboard` or `/admin`. The (public) group renders at `/[org]/[shareCode]` which is allowed.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Public route structure created with page, loading, not-found components, middleware allows unauthenticated access</done>
</task>

<task type="auto">
  <name>Task 2: Public header, greeting, and footer components</name>
  <files>src/components/public/public-header.tsx, src/components/public/public-greeting.tsx, src/components/public/public-footer.tsx, src/components/public/password-gate.tsx</files>
  <action>
Create `src/components/public/public-header.tsx`:

```typescript
import Image from 'next/image'

interface PublicHeaderProps {
  orgName: string
  logoUrl: string | null
  primaryColor: string
}

export function PublicHeader({ orgName, logoUrl, primaryColor }: PublicHeaderProps) {
  return (
    <header
      className="bg-white border-b sticky top-0 z-40"
      style={{ borderBottomColor: primaryColor }}
    >
      <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          {logoUrl ? (
            <Image
              src={logoUrl}
              alt={`${orgName} logo`}
              width={120}
              height={40}
              className="h-10 w-auto object-contain"
            />
          ) : (
            <span
              className="text-xl font-bold"
              style={{ color: primaryColor }}
            >
              {orgName}
            </span>
          )}
        </div>
        <div className="text-sm text-gray-500">
          Batterikalkyl
        </div>
      </div>
    </header>
  )
}
```

Create `src/components/public/public-greeting.tsx`:

```typescript
interface PublicGreetingProps {
  customerName: string
  closerName: string
  customGreeting: string | null
}

const DEFAULT_GREETING = `Hej {namn}, här är din batterikalkyl som du och {closer} har pratat om. Nedan ser du hur mycket du kan spara med ett batterisystem.`

export function PublicGreeting({
  customerName,
  closerName,
  customGreeting,
}: PublicGreetingProps) {
  // Use custom greeting or default
  const template = customGreeting || DEFAULT_GREETING

  // Replace placeholders
  const greeting = template
    .replace(/\{namn\}/gi, customerName)
    .replace(/\{closer\}/gi, closerName)

  return (
    <section className="bg-white rounded-lg shadow-sm p-6">
      <p className="text-lg text-gray-700 leading-relaxed">
        {greeting}
      </p>
    </section>
  )
}
```

Create `src/components/public/public-footer.tsx`:

```typescript
interface PublicFooterProps {
  closerName: string
  primaryColor: string
}

export function PublicFooter({ closerName, primaryColor }: PublicFooterProps) {
  return (
    <footer className="bg-white border-t mt-12">
      <div className="max-w-4xl mx-auto px-4 py-8">
        <div className="flex flex-col md:flex-row items-center justify-between gap-4">
          <div className="text-center md:text-left">
            <p className="text-gray-700">
              Har du frågor? Kontakta{' '}
              <span className="font-medium">{closerName}</span>
            </p>
          </div>
          <div className="text-sm text-gray-500 flex items-center gap-2">
            Powered by{' '}
            <a
              href="https://kalkyla.se"
              target="_blank"
              rel="noopener noreferrer"
              className="font-medium hover:underline"
              style={{ color: primaryColor }}
            >
              Kalkyla.se
            </a>
          </div>
        </div>
      </div>
    </footer>
  )
}
```

Create `src/components/public/password-gate.tsx`:

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

interface PasswordGateProps {
  orgSlug: string
  shareCode: string
  error?: string
}

export function PasswordGate({ orgSlug, shareCode, error }: PasswordGateProps) {
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    // Redirect with password as query param
    router.push(`/${orgSlug}/${shareCode}?pwd=${encodeURIComponent(password)}`)
  }

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center px-4">
      <div className="max-w-md w-full">
        <div className="bg-white rounded-lg shadow-lg p-8">
          <div className="text-center mb-6">
            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg
                className="w-8 h-8 text-blue-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
            </div>
            <h1 className="text-xl font-semibold text-gray-900">
              Skyddad kalkyl
            </h1>
            <p className="text-gray-600 mt-2">
              Ange lösenordet du fått av din säljare
            </p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-4">
            {error && (
              <div className="bg-red-50 text-red-700 px-4 py-3 rounded-md text-sm">
                {error}
              </div>
            )}

            <div>
              <label htmlFor="password" className="sr-only">
                Lösenord
              </label>
              <input
                id="password"
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Ange lösenord"
                required
                className="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                autoFocus
              />
            </div>

            <button
              type="submit"
              disabled={loading || !password}
              className="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium"
            >
              {loading ? 'Laddar...' : 'Visa kalkyl'}
            </button>
          </form>
        </div>
      </div>
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>PublicHeader with branding, PublicGreeting with personalization, PublicFooter with contact info, PasswordGate for protected links</done>
</task>

<task type="auto">
  <name>Task 3: Public battery summary and results view</name>
  <files>src/components/public/public-battery-summary.tsx, src/components/public/public-results-view.tsx</files>
  <action>
Create `src/components/public/public-battery-summary.tsx`:

```typescript
'use client'

import { useState } from 'react'
import type { PublicBatteryInfo, CalculationResultsPublic } from '@/lib/share/types'

interface PublicBatterySummaryProps {
  battery: PublicBatteryInfo
  allBatteries: PublicBatteryInfo[]
  results: CalculationResultsPublic
}

function formatSek(value: number): string {
  return new Intl.NumberFormat('sv-SE', {
    style: 'currency',
    currency: 'SEK',
    maximumFractionDigits: 0,
  }).format(value)
}

function formatPercent(value: number): string {
  return `${value.toFixed(1)}%`
}

export function PublicBatterySummary({
  battery,
  allBatteries,
  results,
}: PublicBatterySummaryProps) {
  const [selectedIndex, setSelectedIndex] = useState(0)
  const currentBattery = allBatteries[selectedIndex] || battery
  const hasMultipleBatteries = allBatteries.length > 1

  return (
    <section className="bg-white rounded-lg shadow-sm overflow-hidden">
      {/* Battery selector (if multiple) */}
      {hasMultipleBatteries && (
        <div className="border-b bg-gray-50 px-6 py-3">
          <div className="flex gap-2 overflow-x-auto">
            {allBatteries.map((b, index) => (
              <button
                key={index}
                onClick={() => setSelectedIndex(index)}
                className={`px-4 py-2 rounded-md text-sm font-medium whitespace-nowrap ${
                  selectedIndex === index
                    ? 'bg-blue-600 text-white'
                    : 'bg-white border text-gray-700 hover:bg-gray-50'
                }`}
              >
                {b.brandName} {b.name}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Battery header */}
      <div className="p-6 border-b">
        <div className="flex items-center gap-4">
          {currentBattery.brandLogoUrl && (
            <img
              src={currentBattery.brandLogoUrl}
              alt={currentBattery.brandName}
              className="h-12 w-auto object-contain"
            />
          )}
          <div>
            <h2 className="text-xl font-semibold text-gray-900">
              {currentBattery.brandName} {currentBattery.name}
            </h2>
            <p className="text-gray-500">
              {currentBattery.capacityKwh} kWh batterisystem
            </p>
          </div>
        </div>
      </div>

      {/* Key metrics - payback first per CONTEXT.md */}
      <div className="grid grid-cols-2 lg:grid-cols-4 divide-x divide-y lg:divide-y-0">
        <div className="p-4 text-center">
          <p className="text-sm text-gray-500">Återbetalningstid</p>
          <p className="text-2xl font-bold text-green-600">
            {results.paybackYears.toFixed(1)} år
          </p>
        </div>
        <div className="p-4 text-center">
          <p className="text-sm text-gray-500">Årlig besparing</p>
          <p className="text-2xl font-bold text-gray-900">
            {formatSek(results.totalAnnualSavings)}
          </p>
        </div>
        <div className="p-4 text-center">
          <p className="text-sm text-gray-500">Avkastning 10 år</p>
          <p className="text-2xl font-bold text-blue-600">
            {formatPercent(results.roi10Year)}
          </p>
        </div>
        <div className="p-4 text-center">
          <p className="text-sm text-gray-500">Avkastning 15 år</p>
          <p className="text-2xl font-bold text-blue-600">
            {formatPercent(results.roi15Year)}
          </p>
        </div>
      </div>

      {/* Battery specs (expandable) */}
      <details className="border-t">
        <summary className="px-6 py-4 cursor-pointer hover:bg-gray-50 flex items-center justify-between">
          <span className="font-medium text-gray-700">Batteridetaljer</span>
          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </summary>
        <div className="px-6 pb-6 grid grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
          <div>
            <p className="text-gray-500">Kapacitet</p>
            <p className="font-medium">{currentBattery.capacityKwh} kWh</p>
          </div>
          <div>
            <p className="text-gray-500">Max urladdning</p>
            <p className="font-medium">{currentBattery.maxDischargeKw} kW</p>
          </div>
          <div>
            <p className="text-gray-500">Max laddning</p>
            <p className="font-medium">{currentBattery.maxChargeKw} kW</p>
          </div>
          <div>
            <p className="text-gray-500">Laddningseffektivitet</p>
            <p className="font-medium">{formatPercent(currentBattery.chargeEfficiency)}</p>
          </div>
          <div>
            <p className="text-gray-500">Urladdningseffektivitet</p>
            <p className="font-medium">{formatPercent(currentBattery.dischargeEfficiency)}</p>
          </div>
          <div>
            <p className="text-gray-500">Garanti</p>
            <p className="font-medium">{currentBattery.warrantyYears} år</p>
          </div>
          <div>
            <p className="text-gray-500">Garanterade cykler</p>
            <p className="font-medium">{currentBattery.guaranteedCycles.toLocaleString('sv-SE')}</p>
          </div>
          <div>
            <p className="text-gray-500">Degradering/år</p>
            <p className="font-medium">{formatPercent(currentBattery.degradationPerYear)}</p>
          </div>
        </div>
      </details>

      {/* Pricing (product cost only, NO margin per CONTEXT.md) */}
      <div className="border-t p-6 bg-gray-50">
        <h3 className="font-medium text-gray-900 mb-3">Kostnad</h3>
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span className="text-gray-600">Pris exkl. moms</span>
            <span className="font-medium">{formatSek(currentBattery.totalPriceExVat)}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">Pris inkl. moms</span>
            <span className="font-medium">{formatSek(currentBattery.totalPriceIncVat)}</span>
          </div>
          <div className="flex justify-between pt-2 border-t">
            <span className="text-gray-900 font-medium">Efter Grön Teknik-avdrag (48.5%)</span>
            <span className="text-lg font-bold text-green-600">
              {formatSek(currentBattery.costAfterGronTeknik)}
            </span>
          </div>
        </div>
      </div>
    </section>
  )
}
```

Create `src/components/public/public-results-view.tsx`:

```typescript
'use client'

import { useState } from 'react'
import type { CalculationResultsPublic } from '@/lib/share/types'
import {
  PieChart,
  Pie,
  Cell,
  ResponsiveContainer,
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ReferenceLine,
} from 'recharts'

interface PublicResultsViewProps {
  results: CalculationResultsPublic
  primaryColor: string
}

function formatSek(value: number): string {
  return new Intl.NumberFormat('sv-SE', {
    style: 'currency',
    currency: 'SEK',
    maximumFractionDigits: 0,
  }).format(value)
}

export function PublicResultsView({ results, primaryColor }: PublicResultsViewProps) {
  const [showDetailedBreakdown, setShowDetailedBreakdown] = useState(false)

  // Savings breakdown data
  const savingsData = [
    { name: 'Spotprisoptimering', value: results.spotprisSavings, color: '#10B981' },
    { name: 'Effekttariffbesparing', value: results.effectTariffSavings, color: '#3B82F6' },
    { name: 'Stödtjänster', value: results.gridServicesIncome, color: '#8B5CF6' },
  ].filter(d => d.value > 0)

  // 15-year ROI timeline data
  const timelineData = Array.from({ length: 16 }, (_, year) => {
    const cumulativeSavings = results.totalAnnualSavings * year
    const investment = results.costAfterGronTeknik
    const netPosition = cumulativeSavings - investment

    return {
      year,
      savings: cumulativeSavings,
      investment,
      net: netPosition,
    }
  })

  const breakEvenYear = Math.ceil(results.paybackYears)

  return (
    <div className="space-y-6">
      {/* Savings breakdown */}
      <section className="bg-white rounded-lg shadow-sm p-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-900">
            Årlig besparing: {formatSek(results.totalAnnualSavings)}
          </h3>
          <button
            onClick={() => setShowDetailedBreakdown(!showDetailedBreakdown)}
            className="text-sm text-blue-600 hover:underline"
          >
            {showDetailedBreakdown ? 'Visa mindre' : 'Visa detaljer'}
          </button>
        </div>

        {/* Grouped view (default) */}
        {!showDetailedBreakdown && (
          <div className="flex flex-col lg:flex-row items-center gap-6">
            <div className="w-48 h-48">
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={savingsData}
                    dataKey="value"
                    nameKey="name"
                    cx="50%"
                    cy="50%"
                    innerRadius={40}
                    outerRadius={70}
                    paddingAngle={2}
                  >
                    {savingsData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                </PieChart>
              </ResponsiveContainer>
            </div>
            <div className="flex-1 space-y-3">
              {savingsData.map((item) => (
                <div key={item.name} className="flex items-center gap-3">
                  <div
                    className="w-4 h-4 rounded-full"
                    style={{ backgroundColor: item.color }}
                  />
                  <span className="flex-1 text-gray-700">{item.name}</span>
                  <span className="font-medium">{formatSek(item.value)}/år</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Detailed breakdown (expanded) */}
        {showDetailedBreakdown && (
          <div className="space-y-4 text-sm">
            <div className="border rounded-lg p-4">
              <h4 className="font-medium text-gray-900 mb-2">Spotprisoptimering</h4>
              <p className="text-gray-600 mb-2">
                Batteriet laddar när elpriset är lågt (natt) och använder energin när priset är högt (dag).
              </p>
              <p className="text-lg font-bold text-green-600">
                {formatSek(results.spotprisSavings)}/år
              </p>
            </div>
            <div className="border rounded-lg p-4">
              <h4 className="font-medium text-gray-900 mb-2">Effekttariffbesparing</h4>
              <p className="text-gray-600 mb-2">
                Batteriet minskar dina effekttoppar och sänker din elnätsavgift.
              </p>
              <p className="text-lg font-bold text-blue-600">
                {formatSek(results.effectTariffSavings)}/år
              </p>
            </div>
            <div className="border rounded-lg p-4">
              <h4 className="font-medium text-gray-900 mb-2">Stödtjänster</h4>
              <p className="text-gray-600 mb-2">
                Du kan tjäna pengar på att låta elnätet använda ditt batteri för frekvensreglering.
              </p>
              <p className="text-lg font-bold text-purple-600">
                {formatSek(results.gridServicesIncome)}/år
              </p>
            </div>
          </div>
        )}
      </section>

      {/* ROI Timeline Chart */}
      <section className="bg-white rounded-lg shadow-sm p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">
          Avkastning över tid
        </h3>
        <div className="h-72">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={timelineData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#E5E7EB" />
              <XAxis
                dataKey="year"
                label={{ value: 'År', position: 'insideBottom', offset: -5 }}
                tick={{ fontSize: 12 }}
              />
              <YAxis
                tickFormatter={(value) => {
                  if (Math.abs(value) >= 1000000) {
                    return `${(value / 1000000).toFixed(1)}mkr`
                  }
                  if (Math.abs(value) >= 1000) {
                    return `${(value / 1000).toFixed(0)}tkr`
                  }
                  return value.toString()
                }}
                tick={{ fontSize: 12 }}
              />
              <Tooltip
                formatter={(value: number) => formatSek(value)}
                labelFormatter={(label) => `År ${label}`}
              />
              <Legend />
              <ReferenceLine
                x={breakEvenYear}
                stroke="#10B981"
                strokeDasharray="5 5"
                label={{
                  value: 'Break-even',
                  position: 'top',
                  fill: '#10B981',
                  fontSize: 12,
                }}
              />
              <Line
                type="monotone"
                dataKey="savings"
                name="Kumulativ besparing"
                stroke="#10B981"
                strokeWidth={2}
                dot={false}
              />
              <Line
                type="monotone"
                dataKey="investment"
                name="Investeringskostnad"
                stroke="#EF4444"
                strokeWidth={2}
                strokeDasharray="5 5"
                dot={false}
              />
              <Line
                type="monotone"
                dataKey="net"
                name="Nettoposition"
                stroke={primaryColor}
                strokeWidth={3}
                dot={false}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
        <p className="text-sm text-gray-500 mt-4 text-center">
          Efter {results.paybackYears.toFixed(1)} år har du tjänat tillbaka din investering.
          På 15 år sparar du totalt {formatSek(results.totalAnnualSavings * 15 - results.costAfterGronTeknik)}.
        </p>
      </section>
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>PublicBatterySummary with battery selector, specs, and pricing. PublicResultsView with savings pie chart and 15-year ROI timeline</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run build` - Build succeeds
3. Test: Access /test-org/invalid-code shows not-found page
4. Test: Public routes do not redirect to login
5. Verify: No margin, costPrice, or installerCut visible in public components
</verification>

<success_criteria>
- Public route at /[org]/[shareCode] accessible without login
- Loading state while fetching calculation
- Not-found page for invalid/expired links
- Password gate for protected calculations
- PublicHeader shows org logo and branding colors
- PublicGreeting shows personalized message with customer name
- PublicBatterySummary shows battery selection, specs, pricing (no margin)
- PublicResultsView shows savings breakdown and ROI timeline
- PublicFooter shows closer name and "Powered by Kalkyla.se"
- View recorded on page load
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-experience/04-03-SUMMARY.md`
</output>
