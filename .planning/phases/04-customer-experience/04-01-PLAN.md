---
phase: 04-customer-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/share/generate-code.ts
  - src/lib/share/types.ts
  - src/actions/share.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Share code field has metadata (expiry, password, created timestamp)"
    - "View tracking model exists for analytics"
    - "Variant model exists for prospect adjustments"
    - "Share code generation produces unguessable strings"
    - "Public calculation fetch returns safe data only"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Share link fields, CalculationView, CalculationVariant models"
      contains: "model CalculationView"
    - path: "src/lib/share/generate-code.ts"
      provides: "Share code generation using nanoid"
      exports: ["generateShareCode"]
    - path: "src/lib/share/types.ts"
      provides: "TypeScript types for share data"
      exports: ["PublicCalculationData", "ShareLinkSettings"]
    - path: "src/actions/share.ts"
      provides: "Server actions for sharing"
      exports: ["generateShareLink", "getPublicCalculation", "recordView"]
  key_links:
    - from: "src/actions/share.ts"
      to: "src/lib/share/generate-code.ts"
      via: "import generateShareCode"
      pattern: "import.*generateShareCode.*from"
    - from: "src/actions/share.ts"
      to: "prisma.calculation"
      via: "database queries"
      pattern: "prisma\\.calculation\\.(findFirst|update)"
---

<objective>
Create database schema for share link metadata and view tracking, plus core server actions for share link generation and public data fetching.

Purpose: Foundation for shareable public calculation views with analytics
Output: Schema migrations, nanoid integration, share server actions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-customer-experience/04-RESEARCH.md
@.planning/phases/04-customer-experience/04-CONTEXT.md
@prisma/schema.prisma
@src/lib/calculations/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extension for sharing</name>
  <files>prisma/schema.prisma</files>
  <action>
Add share link metadata fields to the Calculation model:

```prisma
// Add to Calculation model (after existing shareCode field):
shareExpiresAt    DateTime?           // Optional expiration date
sharePassword     String?             // Optional bcrypt hash for password protection
shareCreatedAt    DateTime?           // When link was generated
shareIsActive     Boolean @default(true) // Can be deactivated without deleting
customGreeting    String?             // Customizable greeting message (default set in code)

// Add relations
views             CalculationView[]
variants          CalculationVariant[]
```

Create CalculationView model for view tracking:

```prisma
model CalculationView {
  id            String   @id @default(cuid())
  calculationId String
  viewedAt      DateTime @default(now())
  userAgent     String?
  ipHash        String?  // SHA256 hash of IP, truncated for privacy

  calculation   Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  @@index([calculationId])
  @@index([viewedAt])
}
```

Create CalculationVariant model for prospect adjustments:

```prisma
model CalculationVariant {
  id                   String   @id @default(cuid())
  calculationId        String
  consumptionProfile   Json     // Modified 12x24 profile
  annualConsumptionKwh Decimal  @db.Decimal(10, 2)
  results              Json     // Recalculated results
  createdAt            DateTime @default(now())

  calculation          Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  @@index([calculationId])
}
```

Note: Do NOT add any new enums - use existing types.
  </action>
  <verify>npx tsc --noEmit && npx prisma validate</verify>
  <done>Schema includes share metadata fields, CalculationView model, CalculationVariant model with proper relations and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Share code generation with nanoid</name>
  <files>package.json, src/lib/share/generate-code.ts, src/lib/share/types.ts</files>
  <action>
Install nanoid:
```bash
npm install nanoid
```

Create `src/lib/share/types.ts`:

```typescript
import type { Elomrade } from '@prisma/client'

// Settings for creating/updating a share link
export interface ShareLinkSettings {
  expiresAt?: Date | null
  password?: string | null  // Raw password, will be hashed
  customGreeting?: string | null
}

// Public-safe battery info (excludes costPrice, margin)
export interface PublicBatteryInfo {
  name: string
  brandName: string
  brandLogoUrl: string | null
  capacityKwh: number
  maxDischargeKw: number
  maxChargeKw: number
  chargeEfficiency: number
  dischargeEfficiency: number
  warrantyYears: number
  guaranteedCycles: number
  degradationPerYear: number
  // Pricing shown to prospect (product cost only, NO margin)
  totalPriceExVat: number
  totalPriceIncVat: number
  costAfterGronTeknik: number
}

// Public calculation data (no sensitive pricing)
export interface PublicCalculationData {
  calculation: {
    id: string
    customerName: string
    elomrade: Elomrade
    annualConsumptionKwh: number
    consumptionProfile: { data: number[][] }
    customGreeting: string | null
    results: CalculationResultsPublic | null
    batteries: PublicBatteryInfo[]
    natagare: {
      name: string
      dayRateSekKw: number
      nightRateSekKw: number
      dayStartHour: number
      dayEndHour: number
    }
  }
  organization: {
    name: string
    slug: string
    logoUrl: string | null
    primaryColor: string
    secondaryColor: string
  }
  closer: {
    name: string
    // Phone exposed only if closer opts in (future enhancement)
  }
}

// Results subset safe for public view
export interface CalculationResultsPublic {
  totalPriceExVat: number
  totalPriceIncVat: number
  costAfterGronTeknik: number
  effectiveCapacityKwh: number
  annualEnergyKwh: number
  spotprisSavings: number
  effectTariffSavings: number
  gridServicesIncome: number
  totalAnnualSavings: number
  paybackYears: number
  roi10Year: number
  roi15Year: number
  // Exclude: marginSek, costPriceTotal, installerCut - sensitive
}

// View statistics for Closer dashboard
export interface ViewStats {
  totalViews: number
  lastViewedAt: Date | null
  uniqueViews?: number  // Future: count unique IP hashes
}
```

Create `src/lib/share/generate-code.ts`:

```typescript
import { nanoid } from 'nanoid'

/**
 * Generate a secure, URL-friendly share code.
 * Uses 21 characters (126 bits of entropy) - unguessable.
 * Example: "V1StGXR8_Z5jdHi6B-myT"
 */
export function generateShareCode(): string {
  return nanoid()
}

/**
 * Generate a shorter code for display purposes.
 * 12 characters (72 bits) - still secure for share links.
 * Example: "V1StGXR8_Z5j"
 */
export function generateShortShareCode(): string {
  return nanoid(12)
}
```
  </action>
  <verify>npx tsc --noEmit && node -e "import('nanoid').then(m => console.log('nanoid OK'))"</verify>
  <done>nanoid installed, share code generation function created, types defined for public-safe data structures</done>
</task>

<task type="auto">
  <name>Task 3: Server actions for sharing</name>
  <files>src/actions/share.ts</files>
  <action>
Create `src/actions/share.ts` with server actions for share link management:

```typescript
'use server'

import { auth } from '@/lib/auth/auth'
import { prisma } from '@/lib/db/client'
import { createTenantClient } from '@/lib/db/tenant'
import { hasPermission } from '@/lib/auth/permissions'
import { generateShareCode } from '@/lib/share/generate-code'
import type { ShareLinkSettings, PublicCalculationData, ViewStats, PublicBatteryInfo, CalculationResultsPublic } from '@/lib/share/types'
import bcrypt from 'bcryptjs'
import { createHash } from 'crypto'
import { VAT_RATE, GRON_TEKNIK_DEDUCTION_RATE } from '@/lib/calculations/constants'

// ============================================================================
// GENERATE/UPDATE SHARE LINK (Authenticated - Closer/Admin)
// ============================================================================

export async function generateShareLink(
  calculationId: string,
  settings: ShareLinkSettings = {}
): Promise<{ shareCode?: string; shareUrl?: string; error?: string }> {
  const session = await auth()
  if (!session?.user) {
    return { error: 'Inte inloggad' }
  }

  // Verify permission
  if (!hasPermission(session.user.role, 'CALCULATION_EDIT')) {
    return { error: 'Saknar behörighet' }
  }

  // Fetch calculation to verify ownership/org
  const tenantDb = session.user.orgId
    ? createTenantClient(session.user.orgId)
    : prisma

  const calculation = await tenantDb.calculation.findUnique({
    where: { id: calculationId },
    include: { organization: { select: { slug: true } } }
  })

  if (!calculation) {
    return { error: 'Kalkylen hittades inte' }
  }

  // For Closer role, verify they own the calculation
  if (session.user.role === 'CLOSER' && calculation.createdBy !== session.user.id) {
    return { error: 'Du kan bara dela dina egna kalkyler' }
  }

  // Generate new share code or keep existing
  const shareCode = calculation.shareCode || generateShareCode()

  // Hash password if provided
  let passwordHash = calculation.sharePassword
  if (settings.password !== undefined) {
    passwordHash = settings.password
      ? await bcrypt.hash(settings.password, 12)
      : null
  }

  // Update calculation with share settings
  await tenantDb.calculation.update({
    where: { id: calculationId },
    data: {
      shareCode,
      shareExpiresAt: settings.expiresAt,
      sharePassword: passwordHash,
      shareCreatedAt: calculation.shareCreatedAt || new Date(),
      shareIsActive: true,
      customGreeting: settings.customGreeting !== undefined
        ? settings.customGreeting
        : calculation.customGreeting,
    },
  })

  const shareUrl = `https://${calculation.organization.slug}.kalkyla.se/${shareCode}`

  return { shareCode, shareUrl }
}

// ============================================================================
// DEACTIVATE SHARE LINK
// ============================================================================

export async function deactivateShareLink(
  calculationId: string
): Promise<{ success?: boolean; error?: string }> {
  const session = await auth()
  if (!session?.user) {
    return { error: 'Inte inloggad' }
  }

  if (!hasPermission(session.user.role, 'CALCULATION_EDIT')) {
    return { error: 'Saknar behörighet' }
  }

  const tenantDb = session.user.orgId
    ? createTenantClient(session.user.orgId)
    : prisma

  const calculation = await tenantDb.calculation.findUnique({
    where: { id: calculationId },
  })

  if (!calculation) {
    return { error: 'Kalkylen hittades inte' }
  }

  if (session.user.role === 'CLOSER' && calculation.createdBy !== session.user.id) {
    return { error: 'Du kan bara hantera dina egna kalkyler' }
  }

  await tenantDb.calculation.update({
    where: { id: calculationId },
    data: { shareIsActive: false },
  })

  return { success: true }
}

// ============================================================================
// REGENERATE SHARE LINK (New code, invalidates old)
// ============================================================================

export async function regenerateShareLink(
  calculationId: string
): Promise<{ shareCode?: string; shareUrl?: string; error?: string }> {
  const session = await auth()
  if (!session?.user) {
    return { error: 'Inte inloggad' }
  }

  if (!hasPermission(session.user.role, 'CALCULATION_EDIT')) {
    return { error: 'Saknar behörighet' }
  }

  const tenantDb = session.user.orgId
    ? createTenantClient(session.user.orgId)
    : prisma

  const calculation = await tenantDb.calculation.findUnique({
    where: { id: calculationId },
    include: { organization: { select: { slug: true } } }
  })

  if (!calculation) {
    return { error: 'Kalkylen hittades inte' }
  }

  if (session.user.role === 'CLOSER' && calculation.createdBy !== session.user.id) {
    return { error: 'Du kan bara hantera dina egna kalkyler' }
  }

  const newShareCode = generateShareCode()

  await tenantDb.calculation.update({
    where: { id: calculationId },
    data: {
      shareCode: newShareCode,
      shareCreatedAt: new Date(),
      shareIsActive: true,
      // Keep existing password and expiry settings
    },
  })

  const shareUrl = `https://${calculation.organization.slug}.kalkyla.se/${newShareCode}`

  return { shareCode: newShareCode, shareUrl }
}

// ============================================================================
// GET PUBLIC CALCULATION (Unauthenticated - for public view)
// ============================================================================

export async function getPublicCalculation(
  orgSlug: string,
  shareCode: string,
  password?: string
): Promise<{ data?: PublicCalculationData; error?: string; passwordRequired?: boolean }> {
  // Find calculation by org slug and share code
  const calculation = await prisma.calculation.findFirst({
    where: {
      shareCode,
      organization: { slug: orgSlug },
      status: { not: 'ARCHIVED' },
      shareIsActive: true,
    },
    include: {
      organization: {
        select: {
          name: true,
          slug: true,
          logoUrl: true,
          primaryColor: true,
          secondaryColor: true,
        },
      },
      natagare: {
        select: {
          name: true,
          dayRateSekKw: true,
          nightRateSekKw: true,
          dayStartHour: true,
          dayEndHour: true,
        },
      },
      batteries: {
        include: {
          batteryConfig: {
            include: {
              brand: { select: { name: true, logoUrl: true } },
            },
          },
        },
        orderBy: { sortOrder: 'asc' },
      },
    },
  })

  if (!calculation) {
    return { error: 'Kalkylen hittades inte eller är inte längre tillgänglig' }
  }

  // Check expiration
  if (calculation.shareExpiresAt && calculation.shareExpiresAt < new Date()) {
    return { error: 'Länken har gått ut. Kontakta din säljare för en ny länk.' }
  }

  // Check password if required
  if (calculation.sharePassword) {
    if (!password) {
      return { passwordRequired: true }
    }
    const valid = await bcrypt.compare(password, calculation.sharePassword)
    if (!valid) {
      return { error: 'Fel lösenord' }
    }
  }

  // Get closer info
  const closer = await prisma.user.findUnique({
    where: { id: calculation.createdBy },
    select: { name: true },
  })

  // Transform to public-safe data
  const batteries: PublicBatteryInfo[] = calculation.batteries.map((b) => {
    const totalExVat = Number(b.totalPriceExVat)
    const totalIncVat = totalExVat * (1 + VAT_RATE)
    const afterGronTeknik = totalIncVat * (1 - GRON_TEKNIK_DEDUCTION_RATE)

    return {
      name: b.batteryConfig.name,
      brandName: b.batteryConfig.brand.name,
      brandLogoUrl: b.batteryConfig.brand.logoUrl,
      capacityKwh: Number(b.batteryConfig.capacityKwh),
      maxDischargeKw: Number(b.batteryConfig.maxDischargeKw),
      maxChargeKw: Number(b.batteryConfig.maxChargeKw),
      chargeEfficiency: Number(b.batteryConfig.chargeEfficiency),
      dischargeEfficiency: Number(b.batteryConfig.dischargeEfficiency),
      warrantyYears: b.batteryConfig.warrantyYears,
      guaranteedCycles: b.batteryConfig.guaranteedCycles,
      degradationPerYear: Number(b.batteryConfig.degradationPerYear),
      totalPriceExVat: totalExVat,
      totalPriceIncVat: totalIncVat,
      costAfterGronTeknik: afterGronTeknik,
      // Note: costPrice, marginSek, installerCut NOT included
    }
  })

  // Extract public-safe results
  let resultsPublic: CalculationResultsPublic | null = null
  if (calculation.results) {
    const r = calculation.results as Record<string, number>
    resultsPublic = {
      totalPriceExVat: r.totalPriceExVat,
      totalPriceIncVat: r.totalPriceIncVat,
      costAfterGronTeknik: r.costAfterGronTeknik,
      effectiveCapacityKwh: r.effectiveCapacityKwh,
      annualEnergyKwh: r.annualEnergyKwh,
      spotprisSavings: r.spotprisSavings,
      effectTariffSavings: r.effectTariffSavings,
      gridServicesIncome: r.gridServicesIncome,
      totalAnnualSavings: r.totalAnnualSavings,
      paybackYears: r.paybackYears,
      roi10Year: r.roi10Year,
      roi15Year: r.roi15Year,
      // Exclude sensitive fields
    }
  }

  return {
    data: {
      calculation: {
        id: calculation.id,
        customerName: calculation.customerName,
        elomrade: calculation.elomrade,
        annualConsumptionKwh: Number(calculation.annualConsumptionKwh),
        consumptionProfile: calculation.consumptionProfile as { data: number[][] },
        customGreeting: calculation.customGreeting,
        results: resultsPublic,
        batteries,
        natagare: {
          name: calculation.natagare.name,
          dayRateSekKw: Number(calculation.natagare.dayRateSekKw),
          nightRateSekKw: Number(calculation.natagare.nightRateSekKw),
          dayStartHour: calculation.natagare.dayStartHour,
          dayEndHour: calculation.natagare.dayEndHour,
        },
      },
      organization: calculation.organization,
      closer: {
        name: closer?.name || 'Din säljare',
      },
    },
  }
}

// ============================================================================
// VIEW TRACKING (Unauthenticated - called from public view)
// ============================================================================

export async function recordView(
  calculationId: string,
  userAgent: string | null,
  ipAddress: string | null
): Promise<void> {
  // Hash IP for privacy (only first 16 chars of hash)
  const ipHash = ipAddress
    ? createHash('sha256').update(ipAddress).digest('hex').slice(0, 16)
    : null

  // Fire-and-forget: don't block page load
  await prisma.calculationView.create({
    data: {
      calculationId,
      userAgent: userAgent?.slice(0, 500) || null, // Truncate long user agents
      ipHash,
    },
  }).catch(() => {
    // Silently fail - view tracking shouldn't break the page
  })
}

// ============================================================================
// GET VIEW STATS (Authenticated - for Closer dashboard)
// ============================================================================

export async function getViewStats(
  calculationId: string
): Promise<{ data?: ViewStats; error?: string }> {
  const session = await auth()
  if (!session?.user) {
    return { error: 'Inte inloggad' }
  }

  if (!hasPermission(session.user.role, 'CALCULATION_VIEW')) {
    return { error: 'Saknar behörighet' }
  }

  const tenantDb = session.user.orgId
    ? createTenantClient(session.user.orgId)
    : prisma

  // Verify calculation exists and user has access
  const calculation = await tenantDb.calculation.findUnique({
    where: { id: calculationId },
  })

  if (!calculation) {
    return { error: 'Kalkylen hittades inte' }
  }

  if (session.user.role === 'CLOSER' && calculation.createdBy !== session.user.id) {
    return { error: 'Du kan bara se statistik för dina egna kalkyler' }
  }

  // Get view stats
  const stats = await prisma.calculationView.aggregate({
    where: { calculationId },
    _count: true,
    _max: { viewedAt: true },
  })

  return {
    data: {
      totalViews: stats._count,
      lastViewedAt: stats._max.viewedAt,
    },
  }
}
```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Server actions created for: generateShareLink, deactivateShareLink, regenerateShareLink, getPublicCalculation, recordView, getViewStats</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` - Schema is valid
2. `npx tsc --noEmit` - No TypeScript errors
3. `npm ls nanoid` - nanoid installed
4. Check share types exclude sensitive fields (costPrice, marginSek, installerCut)
</verification>

<success_criteria>
- Calculation model has share metadata fields (shareExpiresAt, sharePassword, shareIsActive, customGreeting)
- CalculationView model exists for view tracking
- CalculationVariant model exists for prospect adjustments
- nanoid installed and share code generation works
- Server actions handle authenticated link management and unauthenticated public fetch
- Public calculation data explicitly excludes sensitive pricing (margin, cost price, installer cut)
</success_criteria>

<output>
After completion, create `.planning/phases/04-customer-experience/04-01-SUMMARY.md`
</output>
