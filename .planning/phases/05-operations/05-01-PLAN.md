---
phase: 05-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/layout.tsx
  - src/app/providers.tsx
  - src/components/analytics/posthog-provider.tsx
  - src/components/analytics/posthog-pageview.tsx
  - src/components/analytics/identify-user.tsx
  - src/lib/analytics/posthog.ts
  - src/lib/analytics/events.ts
  - src/app/(public)/[org]/[shareCode]/page.tsx
  - sentry.client.config.ts
  - sentry.server.config.ts
  - sentry.edge.config.ts
  - instrumentation.ts
  - next.config.ts
autonomous: true
user_setup:
  - service: posthog
    why: "Analytics, session replays, heatmaps"
    env_vars:
      - name: NEXT_PUBLIC_POSTHOG_KEY
        source: "PostHog Project Settings -> Project API Key"
      - name: NEXT_PUBLIC_POSTHOG_HOST
        source: "Use https://eu.i.posthog.com for EU hosting"
    dashboard_config:
      - task: "Enable Session Replay"
        location: "PostHog -> Project Settings -> Session Replay -> Enable"
      - task: "Enable Heatmaps"
        location: "PostHog -> Toolbar -> Heatmaps toggle"
  - service: sentry
    why: "Error tracking and API performance monitoring"
    env_vars:
      - name: NEXT_PUBLIC_SENTRY_DSN
        source: "Sentry Project -> Settings -> Client Keys (DSN)"
      - name: SENTRY_AUTH_TOKEN
        source: "Sentry -> Settings -> Auth Tokens -> Create new"
      - name: SENTRY_ORG
        source: "Sentry organization slug"
      - name: SENTRY_PROJECT
        source: "Sentry project slug"

must_haves:
  truths:
    - "PostHog captures page views on customer-facing pages"
    - "PostHog captures session replays (enabled in project settings)"
    - "PostHog records heatmaps (enabled in project settings)"
    - "Custom events fire: calculation_viewed, simulator_adjusted"
    - "Sentry captures errors with stack traces"
    - "Sentry monitors API performance"
  artifacts:
    - path: "src/components/analytics/posthog-provider.tsx"
      provides: "PostHog client initialization"
      exports: ["PHProvider"]
    - path: "src/components/analytics/posthog-pageview.tsx"
      provides: "Manual page view tracking for App Router"
      exports: ["PostHogPageview"]
    - path: "src/lib/analytics/events.ts"
      provides: "Custom event capture functions"
      exports: ["trackCalculationViewed", "trackSimulatorAdjusted"]
    - path: "sentry.client.config.ts"
      provides: "Sentry client-side configuration"
      contains: "Sentry.init"
    - path: "instrumentation.ts"
      provides: "Sentry server/edge registration"
      contains: "register"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/app/providers.tsx"
      via: "Providers wrapper"
      pattern: "<Providers>"
    - from: "src/app/providers.tsx"
      to: "src/components/analytics/posthog-provider.tsx"
      via: "PHProvider import"
      pattern: "PHProvider"
    - from: "src/app/(public)/[org]/[shareCode]/page.tsx"
      to: "src/lib/analytics/events.ts"
      via: "Custom event tracking"
      pattern: "trackCalculationViewed"
---

<objective>
Set up PostHog analytics and Sentry error monitoring for the application.

Purpose: Enable tracking of customer engagement on public calculation pages and capture errors with full context for debugging.

Output:
- PostHog provider with manual page view tracking (App Router compatible)
- Custom event definitions for calculation_viewed, simulator_adjusted
- Sentry configuration for client, server, and edge runtimes
- Analytics integrated into public pages
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-operations/05-RESEARCH.md

Key patterns from research:
- PostHog: capture_pageview: false, manual tracking via usePathname
- Sentry: wizard creates config files, use instrumentation.ts for server/edge
- EU hosting: https://eu.i.posthog.com (Swedish business)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install analytics dependencies</name>
  <files>package.json</files>
  <action>
Install PostHog and Sentry packages:

```bash
npm install posthog-js @sentry/nextjs
```

Sentry wizard will be run manually later - for now just install the package.
  </action>
  <verify>
`npm list posthog-js @sentry/nextjs` shows both packages installed
  </verify>
  <done>
posthog-js and @sentry/nextjs added to package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PostHog provider and page tracking</name>
  <files>
    src/components/analytics/posthog-provider.tsx
    src/components/analytics/posthog-pageview.tsx
    src/components/analytics/identify-user.tsx
    src/lib/analytics/posthog.ts
    src/lib/analytics/events.ts
  </files>
  <action>
Create PostHog provider following App Router pattern from research:

**src/components/analytics/posthog-provider.tsx:**
- 'use client' directive
- Initialize PostHog in useEffect with:
  - api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST || 'https://eu.i.posthog.com'
  - capture_pageview: false (manual tracking for App Router)
  - capture_pageleave: true
  - person_profiles: 'identified_only'
  - autocapture: true
- Wrap children in PostHogProvider from posthog-js/react

**src/components/analytics/posthog-pageview.tsx:**
- 'use client' directive
- Use usePathname() and useSearchParams() from next/navigation
- Capture pageview on path/search changes via useEffect
- Pattern: posthog.capture('$pageview')

**src/components/analytics/identify-user.tsx:**
- 'use client' directive
- Use useSession() from next-auth/react
- Use usePostHog() from posthog-js/react
- In useEffect, check session.user and posthog._isIdentified()
- If not identified, call posthog.identify(session.user.id, { email, name, role, orgId })
- Also set Sentry user context: Sentry.setUser({ id, email })
- Return null (no UI)

**src/lib/analytics/posthog.ts:**
- Export helper to get PostHog client: getPostHog()
- Use typeof window check for SSR safety

**src/lib/analytics/events.ts:**
- Export typed event capture functions:
  - trackCalculationViewed(calculationId: string, orgSlug: string)
  - trackSimulatorAdjusted(calculationId: string, month: number, hour: number, oldValue: number, newValue: number)
  - trackScrollDepth(calculationId: string, depth: number)
  - trackTimeOnPage(calculationId: string, seconds: number)
- Each function calls posthog.capture() with proper event name and properties
- Guard with typeof window check for SSR safety
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
PostHog provider, pageview tracker, user identification, and custom event functions created
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Sentry configuration files</name>
  <files>
    sentry.client.config.ts
    sentry.server.config.ts
    sentry.edge.config.ts
    instrumentation.ts
    next.config.ts
  </files>
  <action>
Create Sentry config files following research patterns:

**sentry.client.config.ts:**
```typescript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
  integrations: [Sentry.replayIntegration()],
  ignoreErrors: [
    'ResizeObserver loop',
    'Non-Error promise rejection',
    /Loading chunk \d+ failed/,
  ],
})
```

**sentry.server.config.ts:**
```typescript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
})
```

**sentry.edge.config.ts:**
```typescript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
})
```

**instrumentation.ts:**
```typescript
import * as Sentry from '@sentry/nextjs'

export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./sentry.server.config')
  }
  if (process.env.NEXT_RUNTIME === 'edge') {
    await import('./sentry.edge.config')
  }
}

export const onRequestError = Sentry.captureRequestError
```

**Update next.config.ts:**
- Wrap existing config with withSentryConfig from @sentry/nextjs
- Add Sentry webpack plugin options for source map upload
- Add silenceSourcemapWarnings: true
- Only enable source map upload in production (check SENTRY_AUTH_TOKEN)
  </action>
  <verify>
`npm run build` completes without Sentry-related errors (DSN not required for build)
  </verify>
  <done>
Sentry configuration files created for client, server, and edge runtimes
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate analytics into app layout and public pages</name>
  <files>
    src/app/layout.tsx
    src/app/providers.tsx
    src/app/(public)/[org]/[shareCode]/page.tsx
  </files>
  <action>
**Create src/app/providers.tsx:**
- 'use client' directive
- Import PHProvider from '@/components/analytics/posthog-provider'
- Import PostHogPageview from '@/components/analytics/posthog-pageview'
- Import IdentifyUser from '@/components/analytics/identify-user'
- Import SessionProvider from 'next-auth/react'
- Wrap children: SessionProvider -> PHProvider -> children + PostHogPageview + IdentifyUser
- Wrap PostHogPageview in Suspense (uses useSearchParams)

**Update src/app/layout.tsx:**
- Import Providers from './providers'
- Wrap {children} with Providers component
- Keep existing metadata, fonts, and styling

**Update src/app/(public)/[org]/[shareCode]/page.tsx:**
- Import trackCalculationViewed from '@/lib/analytics/events'
- Call trackCalculationViewed(calculation.id, org) after recordView
- This is fire-and-forget (no await needed for client-side tracking)
- Note: Server component - need to add client component for tracking

Create a small client component for public page tracking:
**src/components/public/public-analytics.tsx:**
- 'use client' directive
- Props: calculationId, orgSlug
- useEffect that calls trackCalculationViewed on mount
- Return null (no UI)

Add PublicAnalytics component to public page after InteractivePublicView
  </action>
  <verify>
- App loads without errors in browser
- PostHog events visible in dev console (posthog.capture logs)
- `npm run build` succeeds
  </verify>
  <done>
Analytics provider integrated into app layout, PostHog tracking on all pages, custom events on public calculation pages
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. TypeScript compiles: `npx tsc --noEmit`
3. PostHog provider wraps app (check React DevTools or console)
4. Custom events defined with correct types
5. Sentry config files exist at project root
6. instrumentation.ts registers Sentry for server/edge
</verification>

<success_criteria>
- ANLY-01: PostHog provider initialized with capture_pageview: false, manual tracking in place
- ANLY-02: Session replay configured in sentry.client.config.ts (enabled in PostHog dashboard)
- ANLY-03: Heatmaps enabled via autocapture: true (requires PostHog dashboard toggle)
- ANLY-04: Custom events trackCalculationViewed, trackSimulatorAdjusted exported from events.ts
- ANLY-05: Sentry client/server/edge configs created with error capture
- ANLY-06: Sentry tracesSampleRate configured for API performance monitoring
</success_criteria>

<output>
After completion, create `.planning/phases/05-operations/05-01-SUMMARY.md`
</output>
