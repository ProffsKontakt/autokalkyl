---
phase: 05-operations
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - .planning/phases/05-operations/05-VERIFICATION.md
  - .planning/STATE.md
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - "All Phase 5 requirements verified"
    - "STATE.md updated with phase completion"
    - "REQUIREMENTS.md checkboxes marked complete"
  artifacts:
    - path: ".planning/phases/05-operations/05-VERIFICATION.md"
      provides: "Phase verification results"
      contains: "VERIFICATION COMPLETE"
  key_links:
    - from: ".planning/phases/05-operations/05-VERIFICATION.md"
      to: ".planning/REQUIREMENTS.md"
      via: "requirement traceability"
      pattern: "ALERT-|ANLY-|DASH-"
---

<objective>
Verify all Phase 5 requirements are implemented and update planning documents.

Purpose: Confirm operations infrastructure is complete before marking phase done.

Output:
- Verification document with pass/fail for each requirement
- Updated STATE.md with phase completion status
- Updated REQUIREMENTS.md with checked requirements
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

Phase 5 Requirements:
- ALERT-01: N8N webhook fires when margin < threshold for affiliated orgs
- ALERT-02: Default margin threshold is 24,000 SEK
- ALERT-03: Webhook payload includes all required fields
- ALERT-04: N8N sends email to julian@proffskontakt.se (configured externally)
- ALERT-05: Non-affiliated orgs see margin but no alerts
- ANLY-01: PostHog tracks page views on customer-facing pages
- ANLY-02: PostHog captures session replays
- ANLY-03: PostHog records heatmaps
- ANLY-04: Custom events: calculation_viewed, simulator_adjusted, scroll_depth, time_on_page
- ANLY-05: Sentry captures errors with stack traces
- ANLY-06: Sentry monitors API performance
- DASH-01: Super Admin sees all organizations with calculation counts
- DASH-02: Super Admin sees all calculations filterable by org, closer, date
- DASH-03: Org Admin sees their org's calculations
- DASH-04: Closer sees their own calculations with view counts
- DASH-05: Dashboard shows link analytics (views, last viewed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify all Phase 5 requirements</name>
  <files>.planning/phases/05-operations/05-VERIFICATION.md</files>
  <action>
Create verification document checking each requirement:

```markdown
# Phase 5: Operations - Verification

**Verified:** [current date]
**Status:** PENDING

## Success Criteria Verification

### 1. Role-Based Dashboard Visibility
- [ ] Super Admin sees all orgs and calculations
- [ ] Org Admin sees their org's calculations
- [ ] Closer sees their own calculations

**Test:**
1. Login as Super Admin -> /admin shows OrgList and CalculationsTable
2. Login as Org Admin -> /dashboard shows org calculations
3. Login as Closer -> /dashboard shows own calculations only

### 2. Link Analytics Display
- [ ] View counts display in dashboard
- [ ] Last viewed timestamps display

**Test:**
1. Share a calculation
2. View it via public link
3. Check dashboard shows viewCount incremented and lastViewedAt populated

### 3. N8N Margin Alerts
- [ ] Webhook fires for affiliated orgs with low margin
- [ ] Default threshold is 24,000 SEK
- [ ] Non-affiliated orgs do NOT trigger alerts

**Test:**
1. Create calculation for ProffsKontakt org with margin < 24000
2. Console shows "[N8N] Margin alert (webhook not configured)" log
3. Create calculation for non-affiliated org with low margin -> no log

### 4. PostHog Analytics
- [ ] Provider initialized in layout
- [ ] Page views captured manually (capture_pageview: false)
- [ ] Custom events exported

**Test:**
1. Check React DevTools for PHProvider in tree
2. Check browser console for posthog.capture calls
3. Check events.ts exports trackCalculationViewed, trackSimulatorAdjusted

### 5. Sentry Error Monitoring
- [ ] Client config exists
- [ ] Server config exists
- [ ] Edge config exists
- [ ] instrumentation.ts registers configs

**Test:**
1. Verify sentry.client.config.ts exists
2. Verify sentry.server.config.ts exists
3. Verify sentry.edge.config.ts exists
4. Verify instrumentation.ts imports and registers

## Requirements Checklist

### Margin Alerts
| Req | Description | Status |
|-----|-------------|--------|
| ALERT-01 | N8N webhook fires for affiliated orgs when margin < threshold | |
| ALERT-02 | Default threshold is 24,000 SEK | |
| ALERT-03 | Payload includes all required fields | |
| ALERT-04 | N8N sends email (external config) | |
| ALERT-05 | Non-affiliated orgs see margin but no alerts | |

### Analytics & Monitoring
| Req | Description | Status |
|-----|-------------|--------|
| ANLY-01 | PostHog tracks page views | |
| ANLY-02 | PostHog captures session replays | |
| ANLY-03 | PostHog records heatmaps | |
| ANLY-04 | Custom events defined | |
| ANLY-05 | Sentry captures errors | |
| ANLY-06 | Sentry monitors API performance | |

### Admin Dashboard
| Req | Description | Status |
|-----|-------------|--------|
| DASH-01 | Super Admin sees all orgs with counts | |
| DASH-02 | Super Admin sees all calculations filterable | |
| DASH-03 | Org Admin sees org calculations | |
| DASH-04 | Closer sees own calculations with views | |
| DASH-05 | Dashboard shows link analytics | |

## Verification Results

[Fill in after running tests]
```

Run verification checks:

1. **Code verification** (file existence):
```bash
# Analytics
ls -la src/components/analytics/
ls -la src/lib/analytics/
ls -la sentry.*.config.ts instrumentation.ts

# Webhooks
ls -la src/lib/webhooks/

# Dashboard
ls -la src/components/dashboard/
ls -la src/actions/dashboard.ts
```

2. **TypeScript verification**:
```bash
npx tsc --noEmit
```

3. **Build verification**:
```bash
npm run build
```

Update verification document with results (PASS/FAIL for each requirement).
  </action>
  <verify>
05-VERIFICATION.md exists with all requirements checked
  </verify>
  <done>
Verification document created with pass/fail status for all Phase 5 requirements
  </done>
</task>

<task type="auto">
  <name>Task 2: Update STATE.md and REQUIREMENTS.md</name>
  <files>
    .planning/STATE.md
    .planning/REQUIREMENTS.md
  </files>
  <action>
**Update .planning/STATE.md:**

1. Change "Current focus" to "Phase 5 - Operations (COMPLETE)"
2. Update "Current Position" section:
   - Phase: 5 of 5 (Operations)
   - Plan: 4 of 4 complete
   - Status: Phase complete
   - Last activity: [current date] - Completed 05-04-PLAN.md (Phase Verification)
3. Update Progress bar to 100%
4. Update "Performance Metrics" with Phase 5 stats
5. Update "Next Steps" to indicate project complete or next phase

**Update .planning/REQUIREMENTS.md:**

Mark all Phase 5 requirements as complete:
- [x] ALERT-01 through ALERT-05
- [x] ANLY-01 through ANLY-06
- [x] DASH-01 through DASH-05

Update traceability table:
- ALERT-01 | Phase 5 | Complete
- (etc for all Phase 5 requirements)
  </action>
  <verify>
- STATE.md shows Phase 5 complete
- REQUIREMENTS.md has all Phase 5 checkboxes marked
  </verify>
  <done>
Planning documents updated to reflect Phase 5 completion
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ROADMAP.md with phase completion</name>
  <files>.planning/ROADMAP.md</files>
  <action>
Update ROADMAP.md:

1. Mark Phase 5 checkbox as complete: `- [x] **Phase 5: Operations**`

2. Update Phase 5 Plans section:
```markdown
Plans:
- [x] 05-01: PostHog & Sentry Setup
- [x] 05-02: N8N Margin Alerts
- [x] 05-03: Admin Dashboards
- [x] 05-04: Phase Verification
```

3. Update Progress table:
```markdown
| 5. Operations | 4/4 | Complete | [current date] |
```

4. Update total plans count if needed
  </action>
  <verify>
ROADMAP.md shows Phase 5 complete with all plans checked
  </verify>
  <done>
ROADMAP.md updated with Phase 5 completion status
  </done>
</task>

</tasks>

<verification>
1. 05-VERIFICATION.md exists with all requirements verified
2. STATE.md shows Phase 5 complete
3. REQUIREMENTS.md has all Phase 5 checkboxes marked [x]
4. ROADMAP.md shows Phase 5 complete
5. All plans marked complete in roadmap
</verification>

<success_criteria>
- All 16 Phase 5 requirements verified (ALERT-01-05, ANLY-01-06, DASH-01-05)
- STATE.md updated with phase completion
- REQUIREMENTS.md checkboxes marked complete
- ROADMAP.md progress updated
- Project ready for production deployment
</success_criteria>

<output>
After completion, create `.planning/phases/05-operations/05-04-SUMMARY.md`
</output>
