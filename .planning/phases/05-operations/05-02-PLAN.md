---
phase: 05-operations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/webhooks/n8n.ts
  - src/actions/calculations.ts
  - prisma/schema.prisma
autonomous: true
user_setup:
  - service: n8n
    why: "Margin alerts via webhook"
    env_vars:
      - name: N8N_MARGIN_ALERT_WEBHOOK_URL
        source: "N8N workflow -> Webhook node -> Production URL"
      - name: N8N_WEBHOOK_SECRET
        source: "Custom secret for webhook authentication (optional)"
    dashboard_config:
      - task: "Create margin alert workflow"
        location: "N8N -> New Workflow -> Add Webhook trigger -> Add Email node"

must_haves:
  truths:
    - "N8N webhook fires when ProffsKontakt-affiliated org saves calculation with margin below threshold"
    - "Default margin threshold is 24,000 SEK"
    - "Webhook payload includes calculation details, closer name, org name, margin breakdown, link"
    - "Non-affiliated orgs do NOT trigger margin alerts"
    - "Webhook failures do not block calculation save"
  artifacts:
    - path: "src/lib/webhooks/n8n.ts"
      provides: "Margin alert webhook trigger"
      exports: ["triggerMarginAlert", "MarginAlertPayload"]
    - path: "src/actions/calculations.ts"
      provides: "Updated saveDraft with margin alert check"
      contains: "triggerMarginAlert"
  key_links:
    - from: "src/actions/calculations.ts"
      to: "src/lib/webhooks/n8n.ts"
      via: "triggerMarginAlert import"
      pattern: "triggerMarginAlert"
    - from: "src/lib/webhooks/n8n.ts"
      to: "N8N_MARGIN_ALERT_WEBHOOK_URL"
      via: "environment variable"
      pattern: "process.env.N8N_MARGIN_ALERT_WEBHOOK_URL"
---

<objective>
Implement N8N webhook integration for margin alerts when ProffsKontakt-affiliated organizations save calculations with margins below the configured threshold.

Purpose: Automatically notify julian@proffskontakt.se when a calculation has a low margin, enabling proactive intervention before closing the deal.

Output:
- N8N webhook utility with fire-and-forget pattern
- Integration into calculation save flow with margin check
- Payload includes all required fields for actionable email
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-operations/05-RESEARCH.md

Key patterns from research:
- Fire-and-forget: try-catch around fetch, log but don't throw
- Never block user actions on webhook success/failure
- Include all context in payload for standalone email

Existing margin calculation:
- Organization has isProffsKontaktAffiliated, installerFixedCut, marginAlertThreshold
- Margin = Sale Price (ex VAT) - Battery Cost - Installer Fixed Cut
- Default threshold: 24,000 SEK
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create N8N webhook utility</name>
  <files>src/lib/webhooks/n8n.ts</files>
  <action>
Create the N8N webhook trigger utility:

```typescript
// src/lib/webhooks/n8n.ts

export interface MarginAlertPayload {
  eventType: 'calculation_saved'
  calculationId: string
  orgId: string
  orgName: string
  closerId: string
  closerName: string
  closerEmail: string
  customerName: string
  batteryName: string
  totalPriceExVat: number
  batteryCostPrice: number
  installerFixedCut: number
  marginSek: number
  threshold: number
  shareUrl: string | null
  createdAt: string
  viewCount: number
}

/**
 * Trigger margin alert webhook to N8N.
 *
 * Fire-and-forget pattern: logs errors but never throws.
 * Webhook failure should never block user actions.
 */
export async function triggerMarginAlert(payload: MarginAlertPayload): Promise<void> {
  const webhookUrl = process.env.N8N_MARGIN_ALERT_WEBHOOK_URL

  if (!webhookUrl) {
    // Dev mode: log to console instead
    console.log('[N8N] Margin alert (webhook not configured):', {
      org: payload.orgName,
      closer: payload.closerName,
      customer: payload.customerName,
      margin: payload.marginSek,
      threshold: payload.threshold,
    })
    return
  }

  try {
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(process.env.N8N_WEBHOOK_SECRET && {
          'X-Webhook-Secret': process.env.N8N_WEBHOOK_SECRET,
        }),
      },
      body: JSON.stringify({
        ...payload,
        timestamp: new Date().toISOString(),
        source: 'kalkyla',
        environment: process.env.NODE_ENV,
      }),
    })

    if (!response.ok) {
      console.error(`[N8N] Webhook failed: ${response.status} ${response.statusText}`)
    } else {
      console.log(`[N8N] Margin alert sent for calculation ${payload.calculationId}`)
    }
  } catch (error) {
    // Fire-and-forget: log but don't throw
    console.error('[N8N] Webhook error:', error)
  }
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
N8N webhook utility created with fire-and-forget pattern and dev mode logging
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate margin alerts into calculation save</name>
  <files>src/actions/calculations.ts</files>
  <action>
Update saveDraft action to trigger margin alerts for ProffsKontakt-affiliated orgs:

1. Import triggerMarginAlert from '@/lib/webhooks/n8n'

2. After successful save (both create and update paths), add margin alert check:

```typescript
// After saving calculation, check for margin alert
// Only for ProffsKontakt-affiliated orgs with a primary battery
if (data.batteries.length > 0) {
  // Fetch org with affiliation info
  const org = await prisma.organization.findUnique({
    where: { id: session.user.orgId! },
    select: {
      isProffsKontaktAffiliated: true,
      installerFixedCut: true,
      marginAlertThreshold: true,
      name: true,
      slug: true,
    },
  })

  if (org?.isProffsKontaktAffiliated) {
    // Get primary battery and its config
    const primaryBattery = data.batteries[0]
    const batteryConfig = await prisma.batteryConfig.findUnique({
      where: { id: primaryBattery.configId },
      select: { name: true, costPrice: true, brand: { select: { name: true } } },
    })

    if (batteryConfig) {
      const totalPriceExVat = primaryBattery.totalPriceExVat
      const batteryCost = Number(batteryConfig.costPrice)
      const installerCut = Number(org.installerFixedCut || 0)
      const marginSek = totalPriceExVat - batteryCost - installerCut
      const threshold = Number(org.marginAlertThreshold || 24000)

      if (marginSek < threshold) {
        // Get closer info
        const closer = await prisma.user.findUnique({
          where: { id: session.user.id },
          select: { name: true, email: true },
        })

        // Get current calculation for share info
        const calc = await prisma.calculation.findUnique({
          where: { id: calculationId },
          select: { shareCode: true, _count: { select: { views: true } } },
        })

        const shareUrl = calc?.shareCode
          ? `https://${org.slug}.kalkyla.se/${calc.shareCode}`
          : null

        // Fire-and-forget - don't await
        triggerMarginAlert({
          eventType: 'calculation_saved',
          calculationId,
          orgId: session.user.orgId!,
          orgName: org.name,
          closerId: session.user.id,
          closerName: closer?.name || 'Okand',
          closerEmail: closer?.email || '',
          customerName: data.customerName,
          batteryName: `${batteryConfig.brand.name} ${batteryConfig.name}`,
          totalPriceExVat,
          batteryCostPrice: batteryCost,
          installerFixedCut: installerCut,
          marginSek,
          threshold,
          shareUrl,
          createdAt: new Date().toISOString(),
          viewCount: calc?._count?.views || 0,
        })
      }
    }
  }
}
```

3. Note: The margin alert check runs AFTER the save completes successfully. It's fire-and-forget - if the webhook fails, the save still succeeds.

4. Use the calculationId from the save result (either updated.id or created.id).
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Console shows "[N8N] Margin alert (webhook not configured)" when saving with low margin (test locally)
  </verify>
  <done>
Margin alert integration added to saveDraft action, fires for ProffsKontakt orgs when margin < threshold
  </done>
</task>

<task type="auto">
  <name>Task 3: Add default marginAlertThreshold to seed data</name>
  <files>prisma/seed.ts</files>
  <action>
Update seed data to include marginAlertThreshold for ProffsKontakt-affiliated organizations:

If prisma/seed.ts exists, update the ProffsKontakt org creation to include:
```typescript
marginAlertThreshold: 24000,
```

If no seed file, document in SUMMARY that marginAlertThreshold defaults to 24000 in the webhook logic.

The Organization model already has marginAlertThreshold field (Decimal(10,2), nullable).
  </action>
  <verify>
Either seed.ts updated or documented that default is handled in code
  </verify>
  <done>
Default margin threshold of 24,000 SEK documented/seeded
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. N8N webhook utility exists at src/lib/webhooks/n8n.ts
3. saveDraft action imports and calls triggerMarginAlert
4. Margin check only runs for isProffsKontaktAffiliated = true
5. Webhook is fire-and-forget (no await, wrapped in try-catch)
6. Dev mode logs margin alert to console when N8N_MARGIN_ALERT_WEBHOOK_URL not set
</verification>

<success_criteria>
- ALERT-01: triggerMarginAlert called when margin < threshold for affiliated orgs
- ALERT-02: Default threshold 24,000 SEK used when org.marginAlertThreshold is null
- ALERT-03: Payload includes all required fields (calculation details, closer name, org name, margin breakdown, link)
- ALERT-04: N8N workflow will send email (configured externally, not in code)
- ALERT-05: Non-affiliated orgs bypass the margin alert check entirely
</success_criteria>

<output>
After completion, create `.planning/phases/05-operations/05-02-SUMMARY.md`
</output>
