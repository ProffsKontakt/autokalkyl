---
phase: 03-calculator-engine
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/calculations/wizard/steps/battery-step.tsx
  - src/components/calculations/wizard/steps/results-step.tsx
  - src/components/calculations/results/summary-cards.tsx
  - src/components/calculations/results/savings-breakdown.tsx
  - src/components/calculations/results/roi-timeline-chart.tsx
  - src/components/calculations/results/comparison-view.tsx
autonomous: true

must_haves:
  truths:
    - "Closer can select 1-4 batteries with individual pricing"
    - "Results display shows savings breakdown, payback period, and ROI"
    - "Battery comparison shows side-by-side results"
    - "Margin is visible to Closer (commission, not total profit)"
  artifacts:
    - path: "src/components/calculations/wizard/steps/battery-step.tsx"
      provides: "Battery selection step with pricing inputs"
      exports: ["BatteryStep"]
    - path: "src/components/calculations/wizard/steps/results-step.tsx"
      provides: "Results display with calculations"
      exports: ["ResultsStep"]
    - path: "src/components/calculations/results/comparison-view.tsx"
      provides: "Side-by-side battery comparison"
      exports: ["ComparisonView"]
  key_links:
    - from: "src/components/calculations/wizard/steps/results-step.tsx"
      to: "src/lib/calculations/engine.ts"
      via: "calculateBatteryROI import"
      pattern: "calculateBatteryROI"
    - from: "src/components/calculations/wizard/steps/results-step.tsx"
      to: "natagareList prop"
      via: "natagareId lookup for effect tariff rates"
      pattern: "natagareList.find.*natagareId"
    - from: "src/components/calculations/results/roi-timeline-chart.tsx"
      to: "recharts"
      via: "LineChart import"
      pattern: "import.*LineChart.*from 'recharts'"
---

<objective>
Build battery selection step (CALC-08 through CALC-13) and results display (LOGIC-06 through LOGIC-09) with savings breakdown, ROI timeline chart, and multi-battery comparison.

Purpose: Closers need to select batteries with pricing and see calculated ROI to complete the sales quote - this is where the calculation engine produces visible value.

Output: Battery selection UI with pricing inputs, results dashboard with summary cards, savings breakdown pie chart, ROI timeline line chart, and side-by-side comparison view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calculator-engine/03-CONTEXT.md
@.planning/phases/03-calculator-engine/03-RESEARCH.md

# Dependencies
@.planning/phases/03-calculator-engine/03-01-PLAN.md
@.planning/phases/03-calculator-engine/03-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create battery selection step</name>
  <files>src/components/calculations/wizard/steps/battery-step.tsx</files>
  <action>
Replace src/components/calculations/wizard/steps/battery-step.tsx:
```typescript
'use client'

import { useState } from 'react'
import { useCalculationWizardStore } from '@/stores/calculation-wizard-store'

interface BatteryOption {
  id: string
  name: string
  brandName: string
  capacityKwh: number
  maxDischargeKw: number
  maxChargeKw: number
  chargeEfficiency: number
  dischargeEfficiency: number
  costPrice: number
}

interface BatteryStepProps {
  batteryList: BatteryOption[]
  orgSettings?: {
    isProffsKontaktAffiliated: boolean
    installerFixedCut: number | null
  }
}

export function BatteryStep({ batteryList, orgSettings }: BatteryStepProps) {
  const { batteries, addBattery, removeBattery, updateBatteryPricing } = useCalculationWizardStore()
  const [selectedBatteryId, setSelectedBatteryId] = useState<string>('')

  const handleAddBattery = () => {
    if (!selectedBatteryId) return
    const battery = batteryList.find(b => b.id === selectedBatteryId)
    if (!battery) return

    // Check if already added
    if (batteries.some(b => b.configId === selectedBatteryId)) {
      return
    }

    // Max 4 batteries for comparison
    if (batteries.length >= 4) {
      return
    }

    addBattery({
      configId: selectedBatteryId,
      totalPriceExVat: 0,
      installationCost: 0,
    })
    setSelectedBatteryId('')
  }

  const getBatteryInfo = (configId: string) => {
    return batteryList.find(b => b.id === configId)
  }

  const formatSek = (n: number) =>
    n.toLocaleString('sv-SE', { maximumFractionDigits: 0 }) + ' kr'

  return (
    <div className="max-w-4xl mx-auto">
      <h2 className="text-xl font-semibold text-gray-900 mb-2">Valj batteri</h2>
      <p className="text-sm text-gray-600 mb-6">
        Valj ett eller flera batterier for att jamfora (max 4).
      </p>

      {/* Battery selector */}
      <div className="flex gap-2 mb-6">
        <select
          value={selectedBatteryId}
          onChange={(e) => setSelectedBatteryId(e.target.value)}
          className="flex-1 px-3 py-2 border border-gray-300 rounded-md"
          disabled={batteries.length >= 4}
        >
          <option value="">Valj batteri...</option>
          {batteryList
            .filter(b => !batteries.some(sel => sel.configId === b.id))
            .map((b) => (
              <option key={b.id} value={b.id}>
                {b.brandName} {b.name} - {b.capacityKwh} kWh
              </option>
            ))}
        </select>
        <button
          type="button"
          onClick={handleAddBattery}
          disabled={!selectedBatteryId || batteries.length >= 4}
          className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Lagg till
        </button>
      </div>

      {/* Selected batteries */}
      {batteries.length === 0 ? (
        <div className="text-center py-12 bg-gray-50 rounded-lg">
          <p className="text-gray-500">Inga batterier valda.</p>
          <p className="text-sm text-gray-400 mt-1">
            Valj minst ett batteri for att fortsatta.
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          {batteries.map((selected, index) => {
            const info = getBatteryInfo(selected.configId)
            if (!info) return null

            return (
              <div
                key={selected.configId}
                className="border border-gray-200 rounded-lg p-4"
              >
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <h3 className="font-medium text-gray-900">
                      {info.brandName} {info.name}
                    </h3>
                    <div className="text-sm text-gray-500 mt-1 space-x-4">
                      <span>{info.capacityKwh} kWh</span>
                      <span>{info.maxDischargeKw} kW uteffekt</span>
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={() => removeBattery(index)}
                    className="text-red-600 hover:text-red-800 text-sm"
                  >
                    Ta bort
                  </button>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  {/* Total price ex VAT */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Totalpris ex. moms (SEK) *
                    </label>
                    <input
                      type="number"
                      value={selected.totalPriceExVat || ''}
                      onChange={(e) =>
                        updateBatteryPricing(index, {
                          totalPriceExVat: Number(e.target.value),
                        })
                      }
                      placeholder="0"
                      min={0}
                      step={1000}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Inkl. batteri, vaxelriktare, installation
                    </p>
                  </div>

                  {/* Installation cost */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Installationskostnad (SEK)
                    </label>
                    <input
                      type="number"
                      value={selected.installationCost || ''}
                      onChange={(e) =>
                        updateBatteryPricing(index, {
                          installationCost: Number(e.target.value),
                        })
                      }
                      placeholder="0"
                      min={0}
                      step={1000}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Om separat fran totalpris
                    </p>
                  </div>
                </div>

                {/* Price summary */}
                {selected.totalPriceExVat > 0 && (
                  <div className="mt-4 p-3 bg-gray-50 rounded-md">
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Totalt ex. moms:</span>
                        <span className="font-medium">
                          {formatSek(selected.totalPriceExVat + selected.installationCost)}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Totalt inkl. moms (25%):</span>
                        <span className="font-medium">
                          {formatSek((selected.totalPriceExVat + selected.installationCost) * 1.25)}
                        </span>
                      </div>
                      <div className="flex justify-between col-span-2 pt-2 border-t">
                        <span className="text-gray-600">Efter Gron Teknik (48.5%):</span>
                        <span className="font-medium text-green-600">
                          {formatSek(
                            (selected.totalPriceExVat + selected.installationCost) * 1.25 * (1 - 0.485)
                          )}
                        </span>
                      </div>
                    </div>

                    {/* Margin info for ProffsKontakt affiliates */}
                    {orgSettings?.isProffsKontaktAffiliated && orgSettings.installerFixedCut && (
                      <div className="mt-2 pt-2 border-t border-gray-200">
                        <div className="flex justify-between text-sm">
                          <span className="text-gray-600">Din provision (installatorsarvode):</span>
                          <span className="font-medium text-blue-600">
                            {formatSek(orgSettings.installerFixedCut)}
                          </span>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )
          })}
        </div>
      )}

      {/* Comparison hint */}
      {batteries.length > 1 && (
        <p className="text-sm text-blue-600 mt-4">
          {batteries.length} batterier valda - jamforelse visas i resultatsteget.
        </p>
      )}
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit src/components/calculations/wizard/steps/battery-step.tsx</verify>
  <done>Battery step compiles with multi-battery selection, pricing inputs, price calculations, and margin display for ProffsKontakt affiliates</done>
</task>

<task type="auto">
  <name>Task 2: Create results display components</name>
  <files>src/components/calculations/results/summary-cards.tsx, src/components/calculations/results/savings-breakdown.tsx, src/components/calculations/results/roi-timeline-chart.tsx</files>
  <action>
Create src/components/calculations/results/summary-cards.tsx:
```typescript
'use client'

import type { CalculationResults } from '@/lib/calculations/types'

interface SummaryCardsProps {
  results: CalculationResults
  batteryName: string
}

export function SummaryCards({ results, batteryName }: SummaryCardsProps) {
  const formatSek = (n: number) =>
    Math.round(n).toLocaleString('sv-SE') + ' kr'

  const formatYears = (n: number) => {
    const years = Math.floor(n)
    const months = Math.round((n - years) * 12)
    if (months === 0) return `${years} ar`
    return `${years} ar ${months} man`
  }

  const formatPercent = (n: number) =>
    n.toLocaleString('sv-SE', { maximumFractionDigits: 1 }) + '%'

  return (
    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
      {/* Payback period */}
      <div className="bg-white border rounded-lg p-4">
        <h3 className="text-sm text-gray-500 mb-1">Aterbetaltningstid</h3>
        <p className="text-2xl font-bold text-gray-900">
          {formatYears(results.paybackPeriodYears)}
        </p>
        <p className="text-xs text-gray-400 mt-1">efter Gron Teknik</p>
      </div>

      {/* Annual savings */}
      <div className="bg-white border rounded-lg p-4">
        <h3 className="text-sm text-gray-500 mb-1">Arlig besparing</h3>
        <p className="text-2xl font-bold text-green-600">
          {formatSek(results.totalAnnualSavingsSek)}
        </p>
        <p className="text-xs text-gray-400 mt-1">/ar</p>
      </div>

      {/* 10-year ROI */}
      <div className="bg-white border rounded-lg p-4">
        <h3 className="text-sm text-gray-500 mb-1">ROI 10 ar</h3>
        <p className={`text-2xl font-bold ${results.roi10YearPercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
          {formatPercent(results.roi10YearPercent)}
        </p>
        <p className="text-xs text-gray-400 mt-1">
          {formatSek(results.totalAnnualSavingsSek * 10 - results.costAfterGronTeknikSek)} netto
        </p>
      </div>

      {/* 15-year ROI */}
      <div className="bg-white border rounded-lg p-4">
        <h3 className="text-sm text-gray-500 mb-1">ROI 15 ar</h3>
        <p className={`text-2xl font-bold ${results.roi15YearPercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
          {formatPercent(results.roi15YearPercent)}
        </p>
        <p className="text-xs text-gray-400 mt-1">
          {formatSek(results.totalAnnualSavingsSek * 15 - results.costAfterGronTeknikSek)} netto
        </p>
      </div>
    </div>
  )
}
```

Create src/components/calculations/results/savings-breakdown.tsx:
```typescript
'use client'

import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts'
import type { CalculationResults } from '@/lib/calculations/types'

interface SavingsBreakdownProps {
  results: CalculationResults
}

const COLORS = ['#3B82F6', '#10B981', '#8B5CF6']

export function SavingsBreakdown({ results }: SavingsBreakdownProps) {
  const data = [
    {
      name: 'Spotprisoptimering',
      value: results.spotprisSavingsSek,
      description: 'Ladda billigt pa natten, anvand dagtid',
    },
    {
      name: 'Effekttariffbesparing',
      value: results.effectTariffSavingsSek,
      description: 'Minska toppeffekt, lagre natnatsavgift',
    },
    {
      name: 'Stodtjanster',
      value: results.gridServicesIncomeSek,
      description: 'Intakt fran frekvensreglering m.m.',
    },
  ].filter(d => d.value > 0)

  const total = data.reduce((sum, d) => sum + d.value, 0)

  const formatSek = (n: number) =>
    Math.round(n).toLocaleString('sv-SE') + ' kr'

  return (
    <div className="bg-white border rounded-lg p-4">
      <h3 className="font-medium text-gray-900 mb-4">Besparingsfordelning</h3>

      <div className="flex items-center gap-6">
        <div className="w-48 h-48">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie
                data={data}
                cx="50%"
                cy="50%"
                innerRadius={40}
                outerRadius={70}
                paddingAngle={2}
                dataKey="value"
              >
                {data.map((_, index) => (
                  <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                ))}
              </Pie>
              <Tooltip
                formatter={(value: number) => formatSek(value)}
              />
            </PieChart>
          </ResponsiveContainer>
        </div>

        <div className="flex-1 space-y-3">
          {data.map((item, index) => (
            <div key={item.name} className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div
                  className="w-3 h-3 rounded-full"
                  style={{ backgroundColor: COLORS[index % COLORS.length] }}
                />
                <div>
                  <span className="text-sm font-medium text-gray-900">{item.name}</span>
                  <p className="text-xs text-gray-500">{item.description}</p>
                </div>
              </div>
              <div className="text-right">
                <span className="text-sm font-medium text-gray-900">
                  {formatSek(item.value)}
                </span>
                <p className="text-xs text-gray-500">
                  {((item.value / total) * 100).toFixed(0)}%
                </p>
              </div>
            </div>
          ))}

          <div className="pt-3 border-t">
            <div className="flex justify-between">
              <span className="font-medium text-gray-900">Total</span>
              <span className="font-bold text-green-600">{formatSek(total)}/ar</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
```

Create src/components/calculations/results/roi-timeline-chart.tsx:
```typescript
'use client'

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  ReferenceLine,
} from 'recharts'
import type { CalculationResults } from '@/lib/calculations/types'

interface ROITimelineChartProps {
  results: CalculationResults
  batteryName?: string
}

export function ROITimelineChart({ results, batteryName }: ROITimelineChartProps) {
  // Generate 15-year timeline data
  const data = Array.from({ length: 16 }, (_, year) => {
    const cumulativeSavings = results.totalAnnualSavingsSek * year
    const netPosition = cumulativeSavings - results.costAfterGronTeknikSek

    return {
      year,
      savings: Math.round(cumulativeSavings),
      net: Math.round(netPosition),
      cost: Math.round(results.costAfterGronTeknikSek),
    }
  })

  const formatSek = (n: number) => {
    if (Math.abs(n) >= 1000000) {
      return (n / 1000000).toFixed(1) + ' mkr'
    }
    if (Math.abs(n) >= 1000) {
      return (n / 1000).toFixed(0) + ' tkr'
    }
    return n.toFixed(0) + ' kr'
  }

  // Find break-even year
  const breakEvenYear = data.find(d => d.net >= 0)?.year || 15

  return (
    <div className="bg-white border rounded-lg p-4">
      <h3 className="font-medium text-gray-900 mb-4">ROI-utveckling over 15 ar</h3>

      <ResponsiveContainer width="100%" height={300}>
        <LineChart data={data} margin={{ top: 10, right: 30, left: 10, bottom: 10 }}>
          <CartesianGrid strokeDasharray="3 3" vertical={false} />
          <XAxis
            dataKey="year"
            label={{ value: 'Ar', position: 'bottom', offset: -5 }}
            tick={{ fontSize: 11 }}
          />
          <YAxis
            tickFormatter={formatSek}
            tick={{ fontSize: 11 }}
            width={70}
          />
          <Tooltip
            formatter={(value: number, name: string) => [
              formatSek(value),
              name === 'savings' ? 'Kumulativ besparing' :
              name === 'net' ? 'Nettoresultat' : 'Investeringskostnad'
            ]}
            labelFormatter={(year) => `Ar ${year}`}
          />
          <ReferenceLine y={0} stroke="#666" strokeDasharray="3 3" />

          {/* Cost line (flat) */}
          <Line
            type="monotone"
            dataKey="cost"
            stroke="#EF4444"
            strokeWidth={2}
            strokeDasharray="5 5"
            dot={false}
            name="Kostnad"
          />

          {/* Cumulative savings */}
          <Line
            type="monotone"
            dataKey="savings"
            stroke="#10B981"
            strokeWidth={2}
            dot={false}
            name="Besparing"
          />

          {/* Net position */}
          <Line
            type="monotone"
            dataKey="net"
            stroke="#3B82F6"
            strokeWidth={3}
            dot={{ fill: '#3B82F6', r: 3 }}
            activeDot={{ r: 6 }}
            name="Netto"
          />

          {/* Break-even marker */}
          <ReferenceLine
            x={breakEvenYear}
            stroke="#22C55E"
            strokeWidth={2}
            label={{
              value: `Break-even ar ${breakEvenYear}`,
              position: 'top',
              fill: '#22C55E',
              fontSize: 11,
            }}
          />
        </LineChart>
      </ResponsiveContainer>

      <div className="flex justify-center gap-6 mt-4 text-xs">
        <div className="flex items-center gap-1">
          <div className="w-4 h-0.5 bg-green-500" />
          <span className="text-gray-600">Kumulativ besparing</span>
        </div>
        <div className="flex items-center gap-1">
          <div className="w-4 h-0.5 bg-red-500 border-dashed" style={{ borderWidth: 1, borderStyle: 'dashed' }} />
          <span className="text-gray-600">Investeringskostnad</span>
        </div>
        <div className="flex items-center gap-1">
          <div className="w-4 h-1 bg-blue-500 rounded" />
          <span className="text-gray-600">Nettoresultat</span>
        </div>
      </div>
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit src/components/calculations/results/summary-cards.tsx src/components/calculations/results/savings-breakdown.tsx src/components/calculations/results/roi-timeline-chart.tsx</verify>
  <done>Results display components compile: summary cards, savings breakdown pie chart, and ROI timeline line chart</done>
</task>

<task type="auto">
  <name>Task 3: Create comparison view and results step with natagare lookup</name>
  <files>src/components/calculations/results/comparison-view.tsx, src/components/calculations/wizard/steps/results-step.tsx</files>
  <action>
Create src/components/calculations/results/comparison-view.tsx:
```typescript
'use client'

import type { CalculationResults } from '@/lib/calculations/types'

interface BatteryResult {
  batteryName: string
  results: CalculationResults
}

interface ComparisonViewProps {
  batteries: BatteryResult[]
}

export function ComparisonView({ batteries }: ComparisonViewProps) {
  const formatSek = (n: number) =>
    Math.round(n).toLocaleString('sv-SE') + ' kr'

  const formatYears = (n: number) =>
    n.toFixed(1).replace('.', ',') + ' ar'

  const formatPercent = (n: number) =>
    n.toFixed(1).replace('.', ',') + '%'

  // Find best values for highlighting
  const bestPayback = Math.min(...batteries.map(b => b.results.paybackPeriodYears))
  const bestAnnualSavings = Math.max(...batteries.map(b => b.results.totalAnnualSavingsSek))
  const bestRoi10 = Math.max(...batteries.map(b => b.results.roi10YearPercent))
  const bestRoi15 = Math.max(...batteries.map(b => b.results.roi15YearPercent))

  const metrics = [
    {
      label: 'Aterbetaltningstid',
      key: 'paybackPeriodYears',
      format: formatYears,
      best: bestPayback,
      lowerIsBetter: true,
    },
    {
      label: 'Arlig besparing',
      key: 'totalAnnualSavingsSek',
      format: formatSek,
      best: bestAnnualSavings,
      lowerIsBetter: false,
    },
    {
      label: 'ROI 10 ar',
      key: 'roi10YearPercent',
      format: formatPercent,
      best: bestRoi10,
      lowerIsBetter: false,
    },
    {
      label: 'ROI 15 ar',
      key: 'roi15YearPercent',
      format: formatPercent,
      best: bestRoi15,
      lowerIsBetter: false,
    },
    {
      label: 'Kostnad efter Gron Teknik',
      key: 'costAfterGronTeknikSek',
      format: formatSek,
      best: Math.min(...batteries.map(b => b.results.costAfterGronTeknikSek)),
      lowerIsBetter: true,
    },
    {
      label: 'Spotprisoptimering',
      key: 'spotprisSavingsSek',
      format: formatSek,
      best: Math.max(...batteries.map(b => b.results.spotprisSavingsSek)),
      lowerIsBetter: false,
    },
    {
      label: 'Effekttariffbesparing',
      key: 'effectTariffSavingsSek',
      format: formatSek,
      best: Math.max(...batteries.map(b => b.results.effectTariffSavingsSek)),
      lowerIsBetter: false,
    },
    {
      label: 'Stodtjanster',
      key: 'gridServicesIncomeSek',
      format: formatSek,
      best: Math.max(...batteries.map(b => b.results.gridServicesIncomeSek)),
      lowerIsBetter: false,
    },
  ]

  return (
    <div className="bg-white border rounded-lg overflow-hidden">
      <table className="w-full">
        <thead className="bg-gray-50">
          <tr>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-900">
              Metric
            </th>
            {batteries.map((b, i) => (
              <th key={i} className="px-4 py-3 text-right text-sm font-medium text-gray-900">
                {b.batteryName}
              </th>
            ))}
          </tr>
        </thead>
        <tbody className="divide-y divide-gray-100">
          {metrics.map((metric) => (
            <tr key={metric.key} className="hover:bg-gray-50">
              <td className="px-4 py-3 text-sm text-gray-600">
                {metric.label}
              </td>
              {batteries.map((b, i) => {
                const value = b.results[metric.key as keyof CalculationResults] as number
                const isBest = metric.lowerIsBetter
                  ? value <= metric.best
                  : value >= metric.best

                return (
                  <td
                    key={i}
                    className={`px-4 py-3 text-sm text-right ${
                      isBest && batteries.length > 1
                        ? 'font-bold text-green-600'
                        : 'text-gray-900'
                    }`}
                  >
                    {metric.format(value)}
                    {isBest && batteries.length > 1 && (
                      <span className="ml-1 text-green-500">*</span>
                    )}
                  </td>
                )
              })}
            </tr>
          ))}
        </tbody>
      </table>

      {batteries.length > 1 && (
        <div className="px-4 py-2 bg-gray-50 text-xs text-gray-500">
          * Basta varde markerat med gront
        </div>
      )}
    </div>
  )
}
```

Replace src/components/calculations/wizard/steps/results-step.tsx:
```typescript
'use client'

import { useMemo } from 'react'
import { useCalculationWizardStore } from '@/stores/calculation-wizard-store'
import { calculateBatteryROI } from '@/lib/calculations/engine'
import { VAT_RATE, GRON_TEKNIK_RATE, DEFAULT_GRID_SERVICES_RATE, DEFAULT_CYCLES_PER_DAY, DEFAULT_AVG_DISCHARGE_PERCENT } from '@/lib/calculations/constants'
import { SummaryCards } from '@/components/calculations/results/summary-cards'
import { SavingsBreakdown } from '@/components/calculations/results/savings-breakdown'
import { ROITimelineChart } from '@/components/calculations/results/roi-timeline-chart'
import { ComparisonView } from '@/components/calculations/results/comparison-view'
import type { BatterySpec, CalculationResults } from '@/lib/calculations/types'

interface NatagareInfo {
  id: string
  name: string
  dayRateSekKw: number
  nightRateSekKw: number
}

interface BatteryInfo {
  id: string
  name: string
  brandName: string
  capacityKwh: number
  maxDischargeKw: number
  maxChargeKw: number
  chargeEfficiency: number
  dischargeEfficiency: number
  costPrice: number
}

interface ResultsStepProps {
  quarterlyPrices: Record<string, { avgDayPriceOre: number; avgNightPriceOre: number }> | null
  orgSettings?: {
    isProffsKontaktAffiliated: boolean
    installerFixedCut: number | null
  }
  batteryList?: BatteryInfo[]
  natagareList?: NatagareInfo[]
}

export function ResultsStep({
  quarterlyPrices,
  orgSettings,
  batteryList = [],
  natagareList = [],
}: ResultsStepProps) {
  const {
    customerName,
    elomrade,
    natagareId,
    batteries: selectedBatteries,
  } = useCalculationWizardStore()

  // Get prices for the selected elomrade
  const prices = elomrade && quarterlyPrices ? quarterlyPrices[elomrade] : null

  // Look up the selected natagare to get effect tariff rates
  const selectedNatagare = natagareList.find(n => n.id === natagareId)
  const natagareInfo = selectedNatagare ? {
    dayRateSekKw: selectedNatagare.dayRateSekKw,
    nightRateSekKw: selectedNatagare.nightRateSekKw,
  } : null

  // Calculate results for each selected battery
  const calculatedResults = useMemo(() => {
    if (!prices || !natagareInfo) return []

    return selectedBatteries.map(selection => {
      const batteryInfo = batteryList.find(b => b.id === selection.configId)
      if (!batteryInfo) return null

      const batterySpec: BatterySpec = {
        capacityKwh: batteryInfo.capacityKwh,
        chargeEfficiency: batteryInfo.chargeEfficiency,
        dischargeEfficiency: batteryInfo.dischargeEfficiency,
        maxDischargeKw: batteryInfo.maxDischargeKw,
        maxChargeKw: batteryInfo.maxChargeKw,
        costPrice: batteryInfo.costPrice,
      }

      const { results } = calculateBatteryROI({
        battery: batterySpec,
        cyclesPerDay: DEFAULT_CYCLES_PER_DAY,
        avgDischargePercent: DEFAULT_AVG_DISCHARGE_PERCENT,
        dayPriceOre: prices.avgDayPriceOre,
        nightPriceOre: prices.avgNightPriceOre,
        effectTariffDayRate: natagareInfo.dayRateSekKw,
        effectTariffNightRate: natagareInfo.nightRateSekKw,
        gridServicesRatePerKwYear: DEFAULT_GRID_SERVICES_RATE,
        totalPriceExVat: selection.totalPriceExVat,
        installationCost: selection.installationCost,
        vatRate: VAT_RATE,
        gronTeknikRate: GRON_TEKNIK_RATE,
        installerCut: orgSettings?.installerFixedCut ?? undefined,
        batteryCostPrice: batteryInfo.costPrice,
      })

      return {
        batteryName: `${batteryInfo.brandName} ${batteryInfo.name}`,
        results,
      }
    }).filter(Boolean) as { batteryName: string; results: CalculationResults }[]
  }, [selectedBatteries, batteryList, prices, natagareInfo, orgSettings])

  if (!prices) {
    return (
      <div className="max-w-4xl mx-auto">
        <h2 className="text-xl font-semibold text-gray-900 mb-6">Resultat</h2>
        <div className="p-6 bg-yellow-50 rounded-lg text-yellow-800">
          <p className="font-medium">Elprisdata saknas</p>
          <p className="text-sm mt-1">
            Ingen kvartalsdata finns for {elomrade}. Kontakta administratoren.
          </p>
        </div>
      </div>
    )
  }

  if (!natagareInfo) {
    return (
      <div className="max-w-4xl mx-auto">
        <h2 className="text-xl font-semibold text-gray-900 mb-6">Resultat</h2>
        <div className="p-6 bg-yellow-50 rounded-lg text-yellow-800">
          <p className="font-medium">Natagare saknas</p>
          <p className="text-sm mt-1">
            Vald natagare kunde inte hittas. Ga tillbaka och valj natagare igen.
          </p>
        </div>
      </div>
    )
  }

  if (calculatedResults.length === 0) {
    return (
      <div className="max-w-4xl mx-auto">
        <h2 className="text-xl font-semibold text-gray-900 mb-6">Resultat</h2>
        <div className="p-6 bg-gray-50 rounded-lg text-gray-600">
          <p>Valj minst ett batteri for att se resultat.</p>
        </div>
      </div>
    )
  }

  const primaryResult = calculatedResults[0]

  return (
    <div className="max-w-5xl mx-auto space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Resultat for {customerName}
          </h2>
          <p className="text-sm text-gray-500">
            Elomrade {elomrade} - Elpris {prices.avgDayPriceOre.toFixed(0)}/{prices.avgNightPriceOre.toFixed(0)} ore/kWh (dag/natt)
            {selectedNatagare && ` - ${selectedNatagare.name}`}
          </p>
        </div>
      </div>

      {/* Summary cards for primary battery */}
      <SummaryCards
        results={primaryResult.results}
        batteryName={primaryResult.batteryName}
      />

      {/* Comparison view if multiple batteries */}
      {calculatedResults.length > 1 && (
        <ComparisonView batteries={calculatedResults} />
      )}

      {/* Detailed breakdown for primary battery */}
      <div className="grid lg:grid-cols-2 gap-6">
        <SavingsBreakdown results={primaryResult.results} />
        <ROITimelineChart results={primaryResult.results} batteryName={primaryResult.batteryName} />
      </div>

      {/* Margin display for ProffsKontakt affiliates */}
      {orgSettings?.isProffsKontaktAffiliated && primaryResult.results.marginSek !== undefined && (
        <div className="p-4 bg-blue-50 rounded-lg">
          <h3 className="font-medium text-blue-900 mb-2">Provisionsinfo</h3>
          <div className="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span className="text-blue-700">Din provision (installatorsarvode):</span>
              <span className="ml-2 font-bold text-blue-900">
                {(orgSettings.installerFixedCut ?? 0).toLocaleString('sv-SE')} kr
              </span>
            </div>
          </div>
          <p className="text-xs text-blue-600 mt-2">
            Marginalinformation visas ej for kund.
          </p>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit src/components/calculations/results/comparison-view.tsx src/components/calculations/wizard/steps/results-step.tsx</verify>
  <done>Comparison view and results step compile; results step looks up natagare rates by natagareId from natagareList for effect tariff calculation</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Visit /dashboard/calculations/new - wizard loads all 4 steps
3. Step 3 allows selecting batteries with pricing
4. Step 4 shows calculated results with charts
5. Multiple batteries show comparison table
6. Margin info shown only for ProffsKontakt affiliates
7. Effect tariff rates are correctly looked up from selected natagare
</verification>

<success_criteria>
- Battery step allows selecting 1-4 batteries from org's list
- Pricing inputs for total price ex VAT and installation cost per battery
- Price summary shows totals including VAT and after Gron Teknik
- Results step receives natagareList and looks up rates by natagareId from wizard store
- Results step calculates using calculateBatteryROI engine with natagare effect tariff rates
- Summary cards show payback, annual savings, 10yr and 15yr ROI
- Savings breakdown pie chart shows spotpris, effect tariff, grid services
- ROI timeline chart shows cumulative savings vs cost over 15 years
- Comparison view shows side-by-side metrics with best values highlighted
- Margin/commission info visible only to Closers at ProffsKontakt affiliates
- Missing natagare shows error message instead of crashing
</success_criteria>

<output>
After completion, create `.planning/phases/03-calculator-engine/03-04-SUMMARY.md`
</output>
