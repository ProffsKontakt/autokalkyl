---
phase: 03-calculator-engine
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/calculations/wizard/calculation-wizard.tsx
  - src/components/calculations/wizard/steps/customer-info-step.tsx
  - src/components/calculations/wizard/steps/consumption-step.tsx
  - src/components/calculations/wizard/consumption-simulator/simulator.tsx
  - src/components/calculations/wizard/consumption-simulator/day-chart.tsx
  - src/components/calculations/wizard/consumption-simulator/month-tabs.tsx
  - src/components/calculations/wizard/consumption-simulator/presets.tsx
  - src/components/calculations/wizard/wizard-navigation.tsx
  - src/app/(dashboard)/dashboard/calculations/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Closer can enter customer name, postal code, elomrade, and natagare"
    - "Closer can edit 12x24 consumption profile via bar chart or input fields"
    - "Closer can apply preset consumption templates"
    - "Wizard validates each step before allowing progression"
  artifacts:
    - path: "src/components/calculations/wizard/calculation-wizard.tsx"
      provides: "Main wizard container with step routing"
      exports: ["CalculationWizard"]
    - path: "src/components/calculations/wizard/steps/customer-info-step.tsx"
      provides: "Step 1 form for customer info"
      exports: ["CustomerInfoStep"]
    - path: "src/components/calculations/wizard/consumption-simulator/simulator.tsx"
      provides: "Interactive consumption editor"
      exports: ["ConsumptionSimulator"]
  key_links:
    - from: "src/components/calculations/wizard/calculation-wizard.tsx"
      to: "src/stores/calculation-wizard-store.ts"
      via: "useCalculationWizardStore import"
      pattern: "useCalculationWizardStore"
    - from: "src/components/calculations/wizard/consumption-simulator/day-chart.tsx"
      to: "recharts"
      via: "BarChart import"
      pattern: "import.*BarChart.*from 'recharts'"
---

<objective>
Build the first two wizard steps: Customer Info (CALC-01 through CALC-04) and Consumption Profile (CALC-05 through CALC-07) with interactive chart simulator.

Purpose: Closers need to input customer details and consumption patterns before selecting batteries - this is the data collection foundation for ROI calculations.

Output: Wizard container, customer info form with elomrade/natagare selection, and consumption simulator with draggable bars, presets, and monthly tabs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calculator-engine/03-CONTEXT.md
@.planning/phases/03-calculator-engine/03-RESEARCH.md

# Dependencies from prior plans
@.planning/phases/03-calculator-engine/03-01-PLAN.md
@.planning/phases/03-calculator-engine/03-02-PLAN.md

# Existing UI patterns
@src/components/batteries/battery-config-form.tsx
@src/components/natagare/natagare-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and create wizard container with navigation</name>
  <files>src/components/calculations/wizard/calculation-wizard.tsx, src/components/calculations/wizard/wizard-navigation.tsx, src/app/(dashboard)/dashboard/calculations/new/page.tsx</files>
  <action>
First install Recharts:
```bash
npm install recharts
```

Create src/components/calculations/wizard/wizard-navigation.tsx:
```typescript
'use client'

interface WizardNavigationProps {
  currentStep: number
  totalSteps: number
  onBack: () => void
  onNext: () => void
  onFinalize?: () => void
  canGoNext: boolean
  isLastStep: boolean
  isSaving?: boolean
  lastSavedAt?: Date | null
}

const STEP_LABELS = [
  'Kundinfo',
  'Forbrukning',
  'Batteri',
  'Resultat',
]

export function WizardNavigation({
  currentStep,
  totalSteps,
  onBack,
  onNext,
  onFinalize,
  canGoNext,
  isLastStep,
  isSaving,
  lastSavedAt,
}: WizardNavigationProps) {
  return (
    <div className="bg-white border-t px-6 py-4">
      {/* Progress indicator */}
      <div className="flex items-center justify-center mb-4">
        {STEP_LABELS.slice(0, totalSteps).map((label, index) => (
          <div key={index} className="flex items-center">
            <div className={`
              flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium
              ${index < currentStep
                ? 'bg-blue-600 text-white'
                : index === currentStep
                  ? 'bg-blue-600 text-white ring-4 ring-blue-100'
                  : 'bg-gray-200 text-gray-600'
              }
            `}>
              {index < currentStep ? (
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                </svg>
              ) : (
                index + 1
              )}
            </div>
            <span className={`ml-2 text-sm ${index === currentStep ? 'font-medium text-gray-900' : 'text-gray-500'}`}>
              {label}
            </span>
            {index < totalSteps - 1 && (
              <div className={`w-12 h-0.5 mx-3 ${index < currentStep ? 'bg-blue-600' : 'bg-gray-200'}`} />
            )}
          </div>
        ))}
      </div>

      {/* Navigation buttons and save status */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2 text-sm text-gray-500">
          {isSaving && (
            <>
              <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
              </svg>
              <span>Sparar...</span>
            </>
          )}
          {!isSaving && lastSavedAt && (
            <span>Sparad {lastSavedAt.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' })}</span>
          )}
        </div>

        <div className="flex gap-3">
          <button
            type="button"
            onClick={onBack}
            disabled={currentStep === 0}
            className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Tillbaka
          </button>
          {isLastStep ? (
            <button
              type="button"
              onClick={onFinalize}
              disabled={!canGoNext}
              className="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Slutfor kalkyl
            </button>
          ) : (
            <button
              type="button"
              onClick={onNext}
              disabled={!canGoNext}
              className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Nasta
            </button>
          )}
        </div>
      </div>
    </div>
  )
}
```

Create src/components/calculations/wizard/calculation-wizard.tsx:
```typescript
'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { useCalculationWizardStore } from '@/stores/calculation-wizard-store'
import { useAutoSave } from '@/hooks/use-auto-save'
import { WizardNavigation } from './wizard-navigation'
import { CustomerInfoStep } from './steps/customer-info-step'
import { ConsumptionStep } from './steps/consumption-step'
import { BatteryStep } from './steps/battery-step'
import { ResultsStep } from './steps/results-step'
import { finalizeCalculation } from '@/actions/calculations'

interface NatagareInfo {
  id: string
  name: string
  dayRateSekKw: number
  nightRateSekKw: number
}

interface BatteryInfo {
  id: string
  name: string
  brandName: string
  capacityKwh: number
  maxDischargeKw: number
  maxChargeKw: number
  chargeEfficiency: number
  dischargeEfficiency: number
  costPrice: number
}

interface CalculationWizardProps {
  natagareList: NatagareInfo[]
  batteryList: BatteryInfo[]
  quarterlyPrices: Record<string, { avgDayPriceOre: number; avgNightPriceOre: number }> | null
  orgSettings?: {
    isProffsKontaktAffiliated: boolean
    installerFixedCut: number | null
  }
}

const TOTAL_STEPS = 4

export function CalculationWizard({
  natagareList,
  batteryList,
  quarterlyPrices,
  orgSettings,
}: CalculationWizardProps) {
  const router = useRouter()
  const [isHydrated, setIsHydrated] = useState(false)
  const store = useCalculationWizardStore()
  const { lastSavedAt, isSaving } = useAutoSave()

  // Handle Zustand hydration
  useEffect(() => {
    setIsHydrated(true)
  }, [])

  const handleNext = () => {
    if (store.currentStep < TOTAL_STEPS - 1) {
      store.setStep(store.currentStep + 1)
    }
  }

  const handleBack = () => {
    if (store.currentStep > 0) {
      store.setStep(store.currentStep - 1)
    }
  }

  const handleFinalize = async () => {
    // TODO: Calculate final results and finalize
    if (store.calculationId) {
      const result = await finalizeCalculation(store.calculationId, {})
      if (result.success) {
        store.reset()
        router.push('/dashboard/calculations')
      }
    }
  }

  // Validation per step
  const canGoNext = (): boolean => {
    switch (store.currentStep) {
      case 0: // Customer Info
        return !!(
          store.customerName &&
          store.elomrade &&
          store.natagareId &&
          store.annualConsumptionKwh > 0
        )
      case 1: // Consumption
        // At least one non-zero value
        return store.consumptionProfile.data.some(month =>
          month.some(hour => hour > 0)
        )
      case 2: // Battery
        return store.batteries.length > 0
      case 3: // Results
        return true
      default:
        return false
    }
  }

  // Show loading state during hydration
  if (!isHydrated) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-gray-500">Laddar...</div>
      </div>
    )
  }

  return (
    <div className="flex flex-col h-full bg-gray-50">
      {/* Step content */}
      <div className="flex-1 overflow-auto p-6">
        {store.currentStep === 0 && (
          <CustomerInfoStep natagareList={natagareList} />
        )}
        {store.currentStep === 1 && (
          <ConsumptionStep />
        )}
        {store.currentStep === 2 && (
          <BatteryStep
            batteryList={batteryList}
            orgSettings={orgSettings}
          />
        )}
        {store.currentStep === 3 && (
          <ResultsStep
            quarterlyPrices={quarterlyPrices}
            orgSettings={orgSettings}
            batteryList={batteryList}
            natagareList={natagareList}
          />
        )}
      </div>

      {/* Navigation */}
      <WizardNavigation
        currentStep={store.currentStep}
        totalSteps={TOTAL_STEPS}
        onBack={handleBack}
        onNext={handleNext}
        onFinalize={handleFinalize}
        canGoNext={canGoNext()}
        isLastStep={store.currentStep === TOTAL_STEPS - 1}
        isSaving={isSaving}
        lastSavedAt={lastSavedAt}
      />
    </div>
  )
}
```

Update src/app/(dashboard)/dashboard/calculations/new/page.tsx:
```typescript
import { redirect } from 'next/navigation'
import { auth } from '@/lib/auth/auth'
import { hasPermission } from '@/lib/auth/permissions'
import { createTenantClient } from '@/lib/db/tenant-client'
import { prisma } from '@/lib/db/client'
import { CalculationWizard } from '@/components/calculations/wizard/calculation-wizard'

export const metadata = {
  title: 'Ny kalkyl - Kalkyla.se',
}

export default async function NewCalculationPage() {
  const session = await auth()
  if (!session?.user) redirect('/login')

  if (!hasPermission(session.user.role, 'CALCULATION_CREATE')) {
    redirect('/dashboard')
  }

  // Fetch natagare list for the org (including effect tariff rates for calculations)
  const tenantClient = createTenantClient(session.user.orgId!)
  const natagare = await tenantClient.natagare.findMany({
    where: { isActive: true },
    orderBy: { name: 'asc' },
  })

  // Fetch battery configs for the org (including all fields needed for calculation engine)
  const batteries = await tenantClient.batteryConfig.findMany({
    where: { isActive: true },
    include: { brand: true },
    orderBy: [{ brand: { name: 'asc' } }, { name: 'asc' }],
  })

  // Fetch latest quarterly prices (for calculation preview)
  const latestQuarter = await prisma.electricityPriceQuarterly.findFirst({
    orderBy: [{ year: 'desc' }, { quarter: 'desc' }],
  })

  let quarterlyPrices: Record<string, { avgDayPriceOre: number; avgNightPriceOre: number }> | null = null
  if (latestQuarter) {
    const prices = await prisma.electricityPriceQuarterly.findMany({
      where: { year: latestQuarter.year, quarter: latestQuarter.quarter },
    })
    quarterlyPrices = {}
    for (const p of prices) {
      quarterlyPrices[p.elomrade] = {
        avgDayPriceOre: Number(p.avgDayPriceOre),
        avgNightPriceOre: Number(p.avgNightPriceOre),
      }
    }
  }

  // Fetch org settings for margin calculation
  const org = session.user.role === 'SUPER_ADMIN'
    ? null
    : await prisma.organization.findUnique({
        where: { id: session.user.orgId! },
        select: { isProffsKontaktAffiliated: true, installerFixedCut: true },
      })

  return (
    <div className="bg-white rounded-lg shadow h-[calc(100vh-8rem)]">
      <CalculationWizard
        natagareList={natagare.map(n => ({
          id: n.id,
          name: n.name,
          dayRateSekKw: Number(n.dayRateSekKw),
          nightRateSekKw: Number(n.nightRateSekKw),
        }))}
        batteryList={batteries.map(b => ({
          id: b.id,
          name: b.name,
          brandName: b.brand.name,
          capacityKwh: Number(b.capacityKwh),
          maxDischargeKw: Number(b.maxDischargeKw),
          maxChargeKw: Number(b.maxChargeKw),
          chargeEfficiency: Number(b.chargeEfficiency),
          dischargeEfficiency: Number(b.dischargeEfficiency),
          costPrice: Number(b.costPrice),
        }))}
        quarterlyPrices={quarterlyPrices}
        orgSettings={org ? {
          isProffsKontaktAffiliated: org.isProffsKontaktAffiliated,
          installerFixedCut: org.installerFixedCut ? Number(org.installerFixedCut) : null,
        } : undefined}
      />
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit src/components/calculations/wizard/calculation-wizard.tsx src/components/calculations/wizard/wizard-navigation.tsx src/app/\(dashboard\)/dashboard/calculations/new/page.tsx</verify>
  <done>Wizard container and navigation compile; page fetches natagare with day/night rates and batteries with all efficiency fields for the wizard</done>
</task>

<task type="auto">
  <name>Task 2: Create customer info step</name>
  <files>src/components/calculations/wizard/steps/customer-info-step.tsx</files>
  <action>
Create src/components/calculations/wizard/steps/customer-info-step.tsx:
```typescript
'use client'

import { useCalculationWizardStore } from '@/stores/calculation-wizard-store'
import { lookupElomrade, isValidSwedishPostalCode } from '@/lib/calculations/elomrade-lookup'
import type { Elomrade } from '@/lib/calculations/types'
import { DEFAULT_ANNUAL_CONSUMPTION_KWH } from '@/lib/calculations/constants'

interface CustomerInfoStepProps {
  natagareList: Array<{ id: string; name: string; dayRateSekKw: number; nightRateSekKw: number }>
}

const ELOMRADE_OPTIONS: { value: Elomrade; label: string }[] = [
  { value: 'SE1', label: 'SE1 - Norra Sverige (Lulea)' },
  { value: 'SE2', label: 'SE2 - Norra mellansverige (Sundsvall)' },
  { value: 'SE3', label: 'SE3 - Sodra mellansverige (Stockholm)' },
  { value: 'SE4', label: 'SE4 - Sodra Sverige (Malmo)' },
]

export function CustomerInfoStep({ natagareList }: CustomerInfoStepProps) {
  const {
    customerName,
    postalCode,
    elomrade,
    natagareId,
    annualConsumptionKwh,
    updateCustomerInfo,
  } = useCalculationWizardStore()

  const handlePostalCodeChange = (value: string) => {
    updateCustomerInfo({ postalCode: value })

    // Auto-detect elomrade from postal code
    if (isValidSwedishPostalCode(value)) {
      const detected = lookupElomrade(value)
      if (detected && !elomrade) {
        updateCustomerInfo({ elomrade: detected })
      }
    }
  }

  return (
    <div className="max-w-2xl mx-auto">
      <h2 className="text-xl font-semibold text-gray-900 mb-6">Kunduppgifter</h2>

      <div className="space-y-6">
        {/* Customer name */}
        <div>
          <label htmlFor="customerName" className="block text-sm font-medium text-gray-700 mb-1">
            Kundnamn *
          </label>
          <input
            id="customerName"
            type="text"
            value={customerName}
            onChange={(e) => updateCustomerInfo({ customerName: e.target.value })}
            placeholder="t.ex. Anna Andersson"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
          <p className="mt-1 text-sm text-gray-500">
            Visas i kalkylen som "Hej [namn], har ar din batterikalkyl"
          </p>
        </div>

        {/* Postal code */}
        <div>
          <label htmlFor="postalCode" className="block text-sm font-medium text-gray-700 mb-1">
            Postnummer
          </label>
          <input
            id="postalCode"
            type="text"
            value={postalCode}
            onChange={(e) => handlePostalCodeChange(e.target.value)}
            placeholder="12345"
            maxLength={6}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
          <p className="mt-1 text-sm text-gray-500">
            Elomrade detekteras automatiskt fran postnummer
          </p>
        </div>

        {/* Elomrade */}
        <div>
          <label htmlFor="elomrade" className="block text-sm font-medium text-gray-700 mb-1">
            Elomrade *
          </label>
          <select
            id="elomrade"
            value={elomrade || ''}
            onChange={(e) => updateCustomerInfo({ elomrade: e.target.value as Elomrade })}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">Valj elomrade...</option>
            {ELOMRADE_OPTIONS.map((opt) => (
              <option key={opt.value} value={opt.value}>
                {opt.label}
              </option>
            ))}
          </select>
        </div>

        {/* Natagare */}
        <div>
          <label htmlFor="natagare" className="block text-sm font-medium text-gray-700 mb-1">
            Natagare *
          </label>
          <select
            id="natagare"
            value={natagareId || ''}
            onChange={(e) => updateCustomerInfo({ natagareId: e.target.value })}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">Valj natagare...</option>
            {natagareList.map((n) => (
              <option key={n.id} value={n.id}>
                {n.name}
              </option>
            ))}
          </select>
          <p className="mt-1 text-sm text-gray-500">
            Paverkar effekttariffberakning
          </p>
        </div>

        {/* Annual consumption */}
        <div>
          <label htmlFor="annualConsumption" className="block text-sm font-medium text-gray-700 mb-1">
            Arlig forbrukning (kWh) *
          </label>
          <input
            id="annualConsumption"
            type="number"
            value={annualConsumptionKwh}
            onChange={(e) => updateCustomerInfo({ annualConsumptionKwh: Number(e.target.value) })}
            min={1}
            step={100}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
          <p className="mt-1 text-sm text-gray-500">
            Typiskt villahushall: 15 000-25 000 kWh/ar
          </p>
        </div>

        {/* Summary card */}
        {customerName && elomrade && (
          <div className="mt-8 p-4 bg-blue-50 rounded-lg">
            <h3 className="text-sm font-medium text-blue-900 mb-2">Sammanfattning</h3>
            <dl className="text-sm text-blue-800 space-y-1">
              <div className="flex justify-between">
                <dt>Kund:</dt>
                <dd className="font-medium">{customerName}</dd>
              </div>
              <div className="flex justify-between">
                <dt>Elomrade:</dt>
                <dd className="font-medium">{elomrade}</dd>
              </div>
              <div className="flex justify-between">
                <dt>Arlig forbrukning:</dt>
                <dd className="font-medium">{annualConsumptionKwh.toLocaleString('sv-SE')} kWh</dd>
              </div>
            </dl>
          </div>
        )}
      </div>
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit src/components/calculations/wizard/steps/customer-info-step.tsx</verify>
  <done>Customer info step compiles with elomrade auto-detection, natagare selection, and validation</done>
</task>

<task type="auto">
  <name>Task 3: Create consumption simulator with Recharts</name>
  <files>src/components/calculations/wizard/steps/consumption-step.tsx, src/components/calculations/wizard/consumption-simulator/simulator.tsx, src/components/calculations/wizard/consumption-simulator/day-chart.tsx, src/components/calculations/wizard/consumption-simulator/month-tabs.tsx, src/components/calculations/wizard/consumption-simulator/presets.tsx</files>
  <action>
Create src/components/calculations/wizard/consumption-simulator/presets.tsx:
```typescript
'use client'

import { SYSTEM_PRESETS, type ConsumptionPreset } from '@/lib/calculations/presets'

interface PresetsProps {
  onApply: (presetId: string) => void
}

export function Presets({ onApply }: PresetsProps) {
  return (
    <div className="space-y-2">
      <label className="block text-sm font-medium text-gray-700">
        Snabbval - forbrukningsmonster
      </label>
      <div className="grid grid-cols-2 gap-2">
        {SYSTEM_PRESETS.map((preset) => (
          <button
            key={preset.id}
            type="button"
            onClick={() => onApply(preset.id)}
            className="p-3 text-left border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
          >
            <span className="block text-sm font-medium text-gray-900">{preset.name}</span>
            <span className="block text-xs text-gray-500 mt-1">{preset.description}</span>
          </button>
        ))}
      </div>
    </div>
  )
}
```

Create src/components/calculations/wizard/consumption-simulator/month-tabs.tsx:
```typescript
'use client'

import { MONTHS } from '@/lib/calculations/constants'

interface MonthTabsProps {
  selectedMonth: number
  onSelectMonth: (month: number) => void
  monthTotals: number[] // Total kWh per month for indicator
}

export function MonthTabs({ selectedMonth, onSelectMonth, monthTotals }: MonthTabsProps) {
  const maxTotal = Math.max(...monthTotals, 1)

  return (
    <div className="flex flex-wrap gap-1">
      {MONTHS.map((month, index) => {
        const intensity = monthTotals[index] / maxTotal
        return (
          <button
            key={index}
            type="button"
            onClick={() => onSelectMonth(index)}
            className={`
              relative px-3 py-2 text-sm rounded-md transition-colors
              ${selectedMonth === index
                ? 'bg-blue-600 text-white'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }
            `}
          >
            {month}
            {/* Intensity indicator */}
            <div
              className={`absolute bottom-0 left-0 right-0 h-1 rounded-b ${
                selectedMonth === index ? 'bg-blue-400' : 'bg-blue-200'
              }`}
              style={{ opacity: intensity }}
            />
          </button>
        )
      })}
    </div>
  )
}
```

Create src/components/calculations/wizard/consumption-simulator/day-chart.tsx:
```typescript
'use client'

import { useState } from 'react'
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Cell,
} from 'recharts'

interface DayChartProps {
  data: number[] // 24 values
  onUpdate: (hour: number, value: number) => void
  dayHourStart?: number
  dayHourEnd?: number
}

export function DayChart({ data, onUpdate, dayHourStart = 6, dayHourEnd = 22 }: DayChartProps) {
  const [editingHour, setEditingHour] = useState<number | null>(null)
  const [editValue, setEditValue] = useState('')

  const chartData = data.map((value, hour) => ({
    hour,
    label: `${hour.toString().padStart(2, '0')}`,
    value: value || 0,
    isDay: hour >= dayHourStart && hour < dayHourEnd,
  }))

  const handleBarClick = (_: unknown, index: number) => {
    const entry = chartData[index]
    setEditingHour(entry.hour)
    setEditValue(entry.value.toFixed(2))
  }

  const handleEditSubmit = () => {
    if (editingHour !== null) {
      const newValue = parseFloat(editValue)
      if (!isNaN(newValue) && newValue >= 0) {
        onUpdate(editingHour, newValue)
      }
      setEditingHour(null)
    }
  }

  return (
    <div className="space-y-4">
      <ResponsiveContainer width="100%" height={250}>
        <BarChart data={chartData} margin={{ top: 10, right: 10, left: -10, bottom: 0 }}>
          <CartesianGrid strokeDasharray="3 3" vertical={false} />
          <XAxis
            dataKey="label"
            tick={{ fontSize: 10 }}
            interval={2}
            tickLine={false}
          />
          <YAxis
            tick={{ fontSize: 10 }}
            tickLine={false}
            axisLine={false}
            label={{ value: 'kWh', angle: -90, position: 'insideLeft', fontSize: 11, dx: 10 }}
          />
          <Tooltip
            content={({ active, payload }) => {
              if (active && payload?.[0]) {
                const d = payload[0].payload
                return (
                  <div className="bg-white p-2 border rounded shadow-lg text-sm">
                    <p className="font-medium">{d.label}:00</p>
                    <p>{d.value.toFixed(2)} kWh</p>
                    <p className="text-xs text-gray-500">
                      {d.isDay ? 'Dagtid (hogre pris)' : 'Nattetid (lagre pris)'}
                    </p>
                  </div>
                )
              }
              return null
            }}
          />
          <Bar dataKey="value" onClick={handleBarClick} cursor="pointer">
            {chartData.map((entry, index) => (
              <Cell
                key={`cell-${index}`}
                fill={entry.isDay ? '#3B82F6' : '#1E40AF'}
                stroke={editingHour === entry.hour ? '#F59E0B' : undefined}
                strokeWidth={editingHour === entry.hour ? 2 : 0}
              />
            ))}
          </Bar>
        </BarChart>
      </ResponsiveContainer>

      {/* Legend */}
      <div className="flex justify-center gap-6 text-xs text-gray-600">
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 bg-blue-500 rounded" />
          <span>Dagtid ({dayHourStart}:00-{dayHourEnd}:00)</span>
        </div>
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 bg-blue-900 rounded" />
          <span>Nattetid</span>
        </div>
      </div>

      {/* Inline edit */}
      {editingHour !== null && (
        <div className="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
          <span className="font-medium text-sm">
            {editingHour.toString().padStart(2, '0')}:00
          </span>
          <input
            type="number"
            value={editValue}
            onChange={(e) => setEditValue(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleEditSubmit()}
            className="w-20 px-2 py-1 text-sm border rounded"
            step="0.01"
            min="0"
            autoFocus
          />
          <span className="text-sm text-gray-500">kWh</span>
          <button
            type="button"
            onClick={handleEditSubmit}
            className="px-3 py-1 text-sm bg-blue-600 text-white rounded"
          >
            OK
          </button>
          <button
            type="button"
            onClick={() => setEditingHour(null)}
            className="px-3 py-1 text-sm text-gray-600"
          >
            Avbryt
          </button>
        </div>
      )}

      {/* Manual input grid */}
      <details className="cursor-pointer">
        <summary className="text-sm text-gray-600 hover:text-gray-900">
          Visa alla timvarden
        </summary>
        <div className="mt-2 grid grid-cols-6 gap-2 text-sm">
          {data.map((value, hour) => (
            <div key={hour} className="flex items-center gap-1">
              <span className="w-8 text-gray-500 text-xs">
                {hour.toString().padStart(2, '0')}:
              </span>
              <input
                type="number"
                value={(value || 0).toFixed(2)}
                onChange={(e) => {
                  const v = parseFloat(e.target.value)
                  if (!isNaN(v) && v >= 0) onUpdate(hour, v)
                }}
                className="w-16 px-1 py-0.5 text-xs border rounded text-right"
                step="0.01"
                min="0"
              />
            </div>
          ))}
        </div>
      </details>
    </div>
  )
}
```

Create src/components/calculations/wizard/consumption-simulator/simulator.tsx:
```typescript
'use client'

import { useState } from 'react'
import { useCalculationWizardStore } from '@/stores/calculation-wizard-store'
import { DayChart } from './day-chart'
import { MonthTabs } from './month-tabs'
import { Presets } from './presets'
import { MONTHS } from '@/lib/calculations/constants'

export function ConsumptionSimulator() {
  const [selectedMonth, setSelectedMonth] = useState(0)
  const [copyMode, setCopyMode] = useState(false)
  const [copyTargets, setCopyTargets] = useState<number[]>([])

  const {
    consumptionProfile,
    annualConsumptionKwh,
    updateConsumptionHour,
    applyPresetToProfile,
    copyMonthPattern,
    scaleProfileToAnnual,
  } = useCalculationWizardStore()

  // Calculate totals
  const monthTotals = consumptionProfile.data.map(month =>
    month.reduce((sum, hour) => sum + hour, 0) * 30
  )
  const profileTotal = monthTotals.reduce((sum, m) => sum + m, 0)
  const variance = annualConsumptionKwh > 0
    ? ((profileTotal - annualConsumptionKwh) / annualConsumptionKwh * 100).toFixed(1)
    : '0'

  const handleCopyStart = () => {
    setCopyMode(true)
    setCopyTargets([])
  }

  const handleCopyToggle = (month: number) => {
    if (month === selectedMonth) return
    setCopyTargets(prev =>
      prev.includes(month)
        ? prev.filter(m => m !== month)
        : [...prev, month]
    )
  }

  const handleCopyExecute = () => {
    if (copyTargets.length > 0) {
      copyMonthPattern(selectedMonth, copyTargets)
    }
    setCopyMode(false)
    setCopyTargets([])
  }

  return (
    <div className="space-y-6">
      {/* Presets */}
      <Presets onApply={applyPresetToProfile} />

      {/* Month tabs */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium text-gray-700">
            Manad
          </label>
          {!copyMode ? (
            <button
              type="button"
              onClick={handleCopyStart}
              className="text-sm text-blue-600 hover:text-blue-800"
            >
              Kopiera monster...
            </button>
          ) : (
            <div className="flex gap-2">
              <button
                type="button"
                onClick={handleCopyExecute}
                disabled={copyTargets.length === 0}
                className="text-sm text-green-600 hover:text-green-800 disabled:text-gray-400"
              >
                Kopiera till {copyTargets.length} manad(er)
              </button>
              <button
                type="button"
                onClick={() => { setCopyMode(false); setCopyTargets([]) }}
                className="text-sm text-gray-600 hover:text-gray-800"
              >
                Avbryt
              </button>
            </div>
          )}
        </div>

        {copyMode ? (
          <div className="flex flex-wrap gap-1">
            {MONTHS.map((month, index) => (
              <button
                key={index}
                type="button"
                onClick={() => handleCopyToggle(index)}
                disabled={index === selectedMonth}
                className={`
                  px-3 py-2 text-sm rounded-md transition-colors
                  ${index === selectedMonth
                    ? 'bg-blue-600 text-white cursor-not-allowed'
                    : copyTargets.includes(index)
                      ? 'bg-green-500 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }
                `}
              >
                {month}
              </button>
            ))}
          </div>
        ) : (
          <MonthTabs
            selectedMonth={selectedMonth}
            onSelectMonth={setSelectedMonth}
            monthTotals={monthTotals}
          />
        )}
      </div>

      {/* Chart */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium text-gray-700">
            Dygnsprofil - {MONTHS[selectedMonth]}
          </label>
          <span className="text-sm text-gray-500">
            Klicka pa en stapel for att redigera
          </span>
        </div>
        <DayChart
          data={consumptionProfile.data[selectedMonth]}
          onUpdate={(hour, value) => updateConsumptionHour(selectedMonth, hour, value)}
        />
      </div>

      {/* Summary and scaling */}
      <div className="p-4 bg-gray-50 rounded-lg">
        <div className="flex items-center justify-between mb-3">
          <div>
            <span className="text-sm text-gray-600">Profil totalt: </span>
            <span className="text-sm font-medium">
              {Math.round(profileTotal).toLocaleString('sv-SE')} kWh/ar
            </span>
          </div>
          <div>
            <span className="text-sm text-gray-600">Mal: </span>
            <span className="text-sm font-medium">
              {annualConsumptionKwh.toLocaleString('sv-SE')} kWh/ar
            </span>
          </div>
          <div className={`text-sm ${Math.abs(Number(variance)) > 5 ? 'text-amber-600' : 'text-green-600'}`}>
            {Number(variance) > 0 ? '+' : ''}{variance}%
          </div>
        </div>

        {Math.abs(Number(variance)) > 1 && (
          <button
            type="button"
            onClick={scaleProfileToAnnual}
            className="w-full px-4 py-2 text-sm text-blue-600 bg-blue-50 rounded hover:bg-blue-100"
          >
            Skala profilen till {annualConsumptionKwh.toLocaleString('sv-SE')} kWh/ar
          </button>
        )}
      </div>
    </div>
  )
}
```

Create src/components/calculations/wizard/steps/consumption-step.tsx:
```typescript
'use client'

import { ConsumptionSimulator } from '../consumption-simulator/simulator'

export function ConsumptionStep() {
  return (
    <div className="max-w-4xl mx-auto">
      <h2 className="text-xl font-semibold text-gray-900 mb-2">Forbrukningsprofil</h2>
      <p className="text-sm text-gray-600 mb-6">
        Redigera kundens forbrukningsmonster. Valj ett snabbval eller justera manuellt per timme och manad.
      </p>

      <ConsumptionSimulator />
    </div>
  )
}
```

Create placeholder files for steps 3 and 4 (will be implemented in Plan 04):

Create src/components/calculations/wizard/steps/battery-step.tsx:
```typescript
'use client'

interface BatteryStepProps {
  batteryList: Array<{
    id: string
    name: string
    brandName: string
    capacityKwh: number
    maxDischargeKw: number
    maxChargeKw: number
    chargeEfficiency: number
    dischargeEfficiency: number
    costPrice: number
  }>
  orgSettings?: {
    isProffsKontaktAffiliated: boolean
    installerFixedCut: number | null
  }
}

export function BatteryStep({ batteryList, orgSettings }: BatteryStepProps) {
  return (
    <div className="max-w-4xl mx-auto">
      <h2 className="text-xl font-semibold text-gray-900 mb-6">Valj batteri</h2>
      <p className="text-gray-500">Implementeras i plan 03-04</p>
    </div>
  )
}
```

Create src/components/calculations/wizard/steps/results-step.tsx:
```typescript
'use client'

interface NatagareInfo {
  id: string
  name: string
  dayRateSekKw: number
  nightRateSekKw: number
}

interface BatteryInfo {
  id: string
  name: string
  brandName: string
  capacityKwh: number
  maxDischargeKw: number
  maxChargeKw: number
  chargeEfficiency: number
  dischargeEfficiency: number
  costPrice: number
}

interface ResultsStepProps {
  quarterlyPrices: Record<string, { avgDayPriceOre: number; avgNightPriceOre: number }> | null
  orgSettings?: {
    isProffsKontaktAffiliated: boolean
    installerFixedCut: number | null
  }
  batteryList?: BatteryInfo[]
  natagareList?: NatagareInfo[]
}

export function ResultsStep({ quarterlyPrices, orgSettings, batteryList, natagareList }: ResultsStepProps) {
  return (
    <div className="max-w-4xl mx-auto">
      <h2 className="text-xl font-semibold text-gray-900 mb-6">Resultat</h2>
      <p className="text-gray-500">Implementeras i plan 03-04</p>
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit src/components/calculations/wizard/steps/consumption-step.tsx src/components/calculations/wizard/consumption-simulator/*.tsx</verify>
  <done>Consumption simulator with Recharts bar chart, monthly tabs, presets, and scaling compiles; placeholder steps for battery and results created with correct interfaces including natagareList and full battery fields</done>
</task>

</tasks>

<verification>
1. Run `npm ls recharts` - package installed
2. Run `npx tsc --noEmit` - no TypeScript errors
3. Visit /dashboard/calculations/new - wizard loads
4. Step 1 form validates customer info
5. Step 2 shows consumption chart with clickable bars
6. Presets apply and scale to annual total
7. Auto-save triggers after changes
</verification>

<success_criteria>
- Wizard displays 4-step progress indicator
- Customer info step collects name, postal code (with elomrade auto-detect), natagare, annual consumption
- Consumption simulator shows 24-hour bar chart with day/night coloring
- Monthly tabs switch between months with intensity indicators
- Presets apply consumption patterns from SYSTEM_PRESETS
- Copy month pattern copies selected month to other months
- Scale button adjusts profile to match annual total
- Manual input grid allows precise hour-by-hour editing
- Navigation enforces step validation (cannot proceed with missing required fields)
- natagareList includes dayRateSekKw and nightRateSekKw for effect tariff calculation
- batteryList includes maxChargeKw, chargeEfficiency, dischargeEfficiency for calculation engine
</success_criteria>

<output>
After completion, create `.planning/phases/03-calculator-engine/03-03-SUMMARY.md`
</output>
