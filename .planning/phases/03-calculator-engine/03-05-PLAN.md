---
phase: 03-calculator-engine
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - src/app/(dashboard)/dashboard/calculations/page.tsx
  - src/app/(dashboard)/dashboard/calculations/[id]/page.tsx
  - src/components/calculations/calculation-list.tsx
  - src/components/calculations/pdf/calculation-pdf.tsx
  - src/components/calculations/pdf/pdf-download-button.tsx
autonomous: false

must_haves:
  truths:
    - "Closer can see list of their calculations"
    - "Closer can save, edit, and view existing calculations"
    - "Closer can download PDF of calculation results"
    - "Full wizard flow works end-to-end"
  artifacts:
    - path: "src/app/(dashboard)/dashboard/calculations/page.tsx"
      provides: "Calculation list page"
      min_lines: 30
    - path: "src/components/calculations/pdf/calculation-pdf.tsx"
      provides: "PDF document definition"
      exports: ["CalculationPDF"]
    - path: "src/components/calculations/pdf/pdf-download-button.tsx"
      provides: "PDF download trigger"
      exports: ["PDFDownloadButton"]
  key_links:
    - from: "src/components/calculations/pdf/calculation-pdf.tsx"
      to: "@react-pdf/renderer"
      via: "Document import"
      pattern: "import.*Document.*from '@react-pdf/renderer'"
    - from: "src/app/(dashboard)/dashboard/calculations/page.tsx"
      to: "src/actions/calculations.ts"
      via: "listCalculations import"
      pattern: "listCalculations"
---

<objective>
Complete the calculator by building the calculation list page (CALC-14, CALC-15), PDF export, and verifying the full end-to-end flow works correctly.

Purpose: Closers need to see their saved calculations, return to edit them, and export results for customers - this completes the core calculator functionality.

Output: Calculation list page with filters, edit page, PDF export component, and human verification that full flow works.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calculator-engine/03-CONTEXT.md
@.planning/phases/03-calculator-engine/03-RESEARCH.md

# Dependencies
@.planning/phases/03-calculator-engine/03-03-PLAN.md
@.planning/phases/03-calculator-engine/03-04-PLAN.md

# Existing list patterns
@src/app/(dashboard)/dashboard/batteries/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PDF dependencies and create calculation list page</name>
  <files>src/app/(dashboard)/dashboard/calculations/page.tsx, src/components/calculations/calculation-list.tsx</files>
  <action>
First install PDF dependencies:
```bash
npm install @react-pdf/renderer file-saver
npm install -D @types/file-saver
```

Create src/components/calculations/calculation-list.tsx:
```typescript
'use client'

import Link from 'next/link'
import { useRouter } from 'next/navigation'
import { deleteCalculation } from '@/actions/calculations'
import { useState } from 'react'

interface Calculation {
  id: string
  customerName: string
  elomrade: string
  status: 'DRAFT' | 'COMPLETE' | 'ARCHIVED'
  createdAt: Date
  updatedAt: Date
  batteryName: string | null
  organizationName?: string
}

interface CalculationListProps {
  calculations: Calculation[]
  showOrg?: boolean
}

export function CalculationList({ calculations, showOrg = false }: CalculationListProps) {
  const router = useRouter()
  const [deletingId, setDeletingId] = useState<string | null>(null)

  const handleDelete = async (id: string) => {
    if (!confirm('Ar du saker pa att du vill ta bort denna kalkyl?')) return

    setDeletingId(id)
    const result = await deleteCalculation(id)
    if (result.error) {
      alert(result.error)
    } else {
      router.refresh()
    }
    setDeletingId(null)
  }

  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'DRAFT':
        return (
          <span className="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded">
            Utkast
          </span>
        )
      case 'COMPLETE':
        return (
          <span className="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">
            Klar
          </span>
        )
      case 'ARCHIVED':
        return (
          <span className="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded">
            Arkiverad
          </span>
        )
      default:
        return null
    }
  }

  if (calculations.length === 0) {
    return (
      <div className="text-center py-12 bg-white rounded-lg shadow">
        <svg
          className="mx-auto h-12 w-12 text-gray-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={1}
            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        <h3 className="mt-4 text-sm font-medium text-gray-900">Inga kalkyler</h3>
        <p className="mt-1 text-sm text-gray-500">
          Skapa din forsta kalkyl for att komma igang.
        </p>
        <div className="mt-6">
          <Link
            href="/dashboard/calculations/new"
            className="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
          >
            Ny kalkyl
          </Link>
        </div>
      </div>
    )
  }

  return (
    <div className="bg-white rounded-lg shadow overflow-hidden">
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-gray-50">
          <tr>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Kund
            </th>
            {showOrg && (
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Organisation
              </th>
            )}
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Batteri
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Elomrade
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Uppdaterad
            </th>
            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
              Atgarder
            </th>
          </tr>
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {calculations.map((calc) => (
            <tr key={calc.id} className="hover:bg-gray-50">
              <td className="px-6 py-4 whitespace-nowrap">
                <Link
                  href={`/dashboard/calculations/${calc.id}`}
                  className="text-sm font-medium text-gray-900 hover:text-blue-600"
                >
                  {calc.customerName}
                </Link>
              </td>
              {showOrg && (
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {calc.organizationName || '-'}
                </td>
              )}
              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {calc.batteryName || 'Inget valt'}
              </td>
              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {calc.elomrade}
              </td>
              <td className="px-6 py-4 whitespace-nowrap">
                {getStatusBadge(calc.status)}
              </td>
              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {new Date(calc.updatedAt).toLocaleDateString('sv-SE')}
              </td>
              <td className="px-6 py-4 whitespace-nowrap text-right text-sm">
                <div className="flex justify-end gap-2">
                  <Link
                    href={`/dashboard/calculations/${calc.id}`}
                    className="text-blue-600 hover:text-blue-900"
                  >
                    Visa
                  </Link>
                  {calc.status !== 'ARCHIVED' && (
                    <button
                      onClick={() => handleDelete(calc.id)}
                      disabled={deletingId === calc.id}
                      className="text-red-600 hover:text-red-900 disabled:opacity-50"
                    >
                      {deletingId === calc.id ? 'Tar bort...' : 'Ta bort'}
                    </button>
                  )}
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )
}
```

Replace src/app/(dashboard)/dashboard/calculations/page.tsx:
```typescript
import { redirect } from 'next/navigation'
import { auth } from '@/lib/auth/auth'
import { hasPermission } from '@/lib/auth/permissions'
import { listCalculations } from '@/actions/calculations'
import { CalculationList } from '@/components/calculations/calculation-list'
import { Button } from '@/components/ui/button'
import Link from 'next/link'

export const metadata = {
  title: 'Kalkyler - Kalkyla.se',
}

export default async function CalculationsPage() {
  const session = await auth()
  if (!session?.user) redirect('/login')

  if (!hasPermission(session.user.role, 'CALCULATION_VIEW')) {
    redirect('/dashboard')
  }

  const result = await listCalculations()

  if (result.error) {
    return (
      <div className="p-6 bg-red-50 text-red-700 rounded-lg">
        {result.error}
      </div>
    )
  }

  const calculations = result.calculations || []
  const activeCalculations = calculations.filter(c => c.status !== 'ARCHIVED')

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Kalkyler</h1>
          <p className="text-sm text-gray-500 mt-1">
            {activeCalculations.length} aktiva kalkyler
          </p>
        </div>
        <Link href="/dashboard/calculations/new">
          <Button>Ny kalkyl</Button>
        </Link>
      </div>

      <CalculationList
        calculations={activeCalculations}
        showOrg={session.user.role === 'SUPER_ADMIN'}
      />
    </div>
  )
}
```
  </action>
  <verify>npx tsc --noEmit src/app/\(dashboard\)/dashboard/calculations/page.tsx src/components/calculations/calculation-list.tsx</verify>
  <done>Calculation list page and component compile; shows list of calculations with status, actions, and links</done>
</task>

<task type="auto">
  <name>Task 2: Create edit/view page for existing calculations</name>
  <files>src/app/(dashboard)/dashboard/calculations/[id]/page.tsx</files>
  <action>
Create src/app/(dashboard)/dashboard/calculations/[id]/page.tsx:
```typescript
import { redirect, notFound } from 'next/navigation'
import { auth } from '@/lib/auth/auth'
import { hasPermission } from '@/lib/auth/permissions'
import { getCalculation } from '@/actions/calculations'
import { createTenantClient } from '@/lib/db/tenant-client'
import { prisma } from '@/lib/db/client'
import { CalculationWizard } from '@/components/calculations/wizard/calculation-wizard'
import Link from 'next/link'

export const metadata = {
  title: 'Redigera kalkyl - Kalkyla.se',
}

interface PageProps {
  params: Promise<{ id: string }>
}

export default async function EditCalculationPage({ params }: PageProps) {
  const resolvedParams = await params
  const session = await auth()
  if (!session?.user) redirect('/login')

  if (!hasPermission(session.user.role, 'CALCULATION_VIEW')) {
    redirect('/dashboard/calculations')
  }

  const result = await getCalculation(resolvedParams.id)

  if (result.error) {
    if (result.error === 'Kalkyl hittades inte' || result.error === 'Forbidden') {
      notFound()
    }
    return (
      <div className="p-6 bg-red-50 text-red-700 rounded-lg">
        {result.error}
      </div>
    )
  }

  const calculation = result.calculation!

  // Fetch natagare list for the org
  const orgId = calculation.orgId || session.user.orgId
  const tenantClient = createTenantClient(orgId!)
  const natagare = await tenantClient.natagare.findMany({
    where: { isActive: true },
    orderBy: { name: 'asc' },
  })

  // Fetch battery configs for the org
  const batteries = await tenantClient.batteryConfig.findMany({
    where: { isActive: true },
    include: { brand: true },
    orderBy: [{ brand: { name: 'asc' } }, { name: 'asc' }],
  })

  // Fetch latest quarterly prices
  const latestQuarter = await prisma.electricityPriceQuarterly.findFirst({
    orderBy: [{ year: 'desc' }, { quarter: 'desc' }],
  })

  let quarterlyPrices: Record<string, { avgDayPriceOre: number; avgNightPriceOre: number }> | null = null
  if (latestQuarter) {
    const prices = await prisma.electricityPriceQuarterly.findMany({
      where: { year: latestQuarter.year, quarter: latestQuarter.quarter },
    })
    quarterlyPrices = {}
    for (const p of prices) {
      quarterlyPrices[p.elomrade] = {
        avgDayPriceOre: Number(p.avgDayPriceOre),
        avgNightPriceOre: Number(p.avgNightPriceOre),
      }
    }
  }

  // Fetch org settings
  const org = await prisma.organization.findUnique({
    where: { id: orgId! },
    select: { isProffsKontaktAffiliated: true, installerFixedCut: true },
  })

  // Transform calculation data for wizard initial state
  const initialData = {
    calculationId: calculation.id,
    customerName: calculation.customerName,
    postalCode: calculation.postalCode,
    elomrade: calculation.elomrade,
    natagareId: calculation.natagareId,
    annualConsumptionKwh: calculation.annualConsumptionKwh,
    consumptionProfile: calculation.consumptionProfile as { data: number[][] },
    batteries: calculation.batteries.map(b => ({
      configId: b.batteryConfigId,
      totalPriceExVat: b.totalPriceExVat,
      installationCost: b.installationCost,
    })),
  }

  return (
    <div className="h-[calc(100vh-8rem)]">
      <div className="mb-4 flex items-center justify-between">
        <Link
          href="/dashboard/calculations"
          className="text-sm text-gray-600 hover:text-gray-900 flex items-center"
        >
          <svg className="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
          </svg>
          Tillbaka till kalkyler
        </Link>
        <span className={`px-2 py-1 text-xs font-medium rounded ${
          calculation.status === 'DRAFT'
            ? 'bg-yellow-100 text-yellow-800'
            : calculation.status === 'COMPLETE'
              ? 'bg-green-100 text-green-800'
              : 'bg-gray-100 text-gray-600'
        }`}>
          {calculation.status === 'DRAFT' ? 'Utkast' : calculation.status === 'COMPLETE' ? 'Klar' : 'Arkiverad'}
        </span>
      </div>

      <div className="bg-white rounded-lg shadow h-full">
        <CalculationWizard
          natagareList={natagare.map(n => ({
            id: n.id,
            name: n.name,
          }))}
          batteryList={batteries.map(b => ({
            id: b.id,
            name: b.name,
            brandName: b.brand.name,
            capacityKwh: Number(b.capacityKwh),
            maxDischargeKw: Number(b.maxDischargeKw),
            costPrice: Number(b.costPrice),
          }))}
          quarterlyPrices={quarterlyPrices}
          orgSettings={org ? {
            isProffsKontaktAffiliated: org.isProffsKontaktAffiliated,
            installerFixedCut: org.installerFixedCut ? Number(org.installerFixedCut) : null,
          } : undefined}
          initialData={initialData}
        />
      </div>
    </div>
  )
}
```

Note: The CalculationWizard component needs to be updated to accept and use initialData prop. Add this to the component's interface and useEffect in calculation-wizard.tsx:

```typescript
// Add to CalculationWizardProps interface:
initialData?: {
  calculationId: string
  customerName: string
  postalCode: string | null
  elomrade: Elomrade
  natagareId: string
  annualConsumptionKwh: number
  consumptionProfile: { data: number[][] }
  batteries: Array<{
    configId: string
    totalPriceExVat: number
    installationCost: number
  }>
}

// Add useEffect to load initial data:
useEffect(() => {
  if (initialData && !store.calculationId) {
    store.loadFromServer(initialData)
  }
}, [initialData])
```
  </action>
  <verify>npx tsc --noEmit src/app/\(dashboard\)/dashboard/calculations/\[id\]/page.tsx</verify>
  <done>Edit page compiles; loads existing calculation data into wizard for editing</done>
</task>

<task type="auto">
  <name>Task 3: Create PDF export components</name>
  <files>src/components/calculations/pdf/calculation-pdf.tsx, src/components/calculations/pdf/pdf-download-button.tsx</files>
  <action>
Create src/components/calculations/pdf/calculation-pdf.tsx:
```typescript
import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
  Image,
} from '@react-pdf/renderer'

const styles = StyleSheet.create({
  page: {
    padding: 40,
    fontSize: 10,
    fontFamily: 'Helvetica',
    backgroundColor: '#FFFFFF',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 30,
    paddingBottom: 15,
    borderBottomWidth: 1,
    borderBottomColor: '#E5E7EB',
  },
  logo: {
    width: 80,
    height: 32,
    objectFit: 'contain',
  },
  orgName: {
    fontSize: 14,
    fontWeight: 'bold',
    color: '#1F2937',
  },
  title: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#1F2937',
    marginBottom: 5,
  },
  subtitle: {
    fontSize: 12,
    color: '#6B7280',
    marginBottom: 25,
  },
  section: {
    marginBottom: 20,
  },
  sectionTitle: {
    fontSize: 12,
    fontWeight: 'bold',
    color: '#1F2937',
    marginBottom: 10,
    paddingBottom: 5,
    borderBottomWidth: 1,
    borderBottomColor: '#E5E7EB',
  },
  row: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingVertical: 4,
  },
  label: {
    color: '#6B7280',
  },
  value: {
    fontWeight: 'bold',
    color: '#1F2937',
  },
  highlightBox: {
    backgroundColor: '#EFF6FF',
    padding: 15,
    marginVertical: 15,
    borderRadius: 4,
  },
  highlightLabel: {
    fontSize: 10,
    color: '#3B82F6',
    marginBottom: 5,
  },
  highlightValue: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#1D4ED8',
  },
  highlightSubtext: {
    fontSize: 9,
    color: '#6B7280',
    marginTop: 5,
  },
  savingsGrid: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 10,
  },
  savingsItem: {
    flex: 1,
    paddingRight: 10,
  },
  savingsLabel: {
    fontSize: 9,
    color: '#6B7280',
    marginBottom: 3,
  },
  savingsValue: {
    fontSize: 11,
    fontWeight: 'bold',
    color: '#1F2937',
  },
  footer: {
    position: 'absolute',
    bottom: 30,
    left: 40,
    right: 40,
    fontSize: 8,
    color: '#9CA3AF',
    textAlign: 'center',
    paddingTop: 10,
    borderTopWidth: 1,
    borderTopColor: '#E5E7EB',
  },
})

interface CalculationPDFProps {
  customerName: string
  orgName: string
  orgLogo?: string
  elomrade: string
  annualConsumptionKwh: number
  batteryName: string
  results: {
    totalIncVatSek: number
    costAfterGronTeknikSek: number
    totalAnnualSavingsSek: number
    paybackPeriodYears: number
    roi10YearPercent: number
    roi15YearPercent: number
    spotprisSavingsSek: number
    effectTariffSavingsSek: number
    gridServicesIncomeSek: number
  }
  createdAt: Date
}

export function CalculationPDF({
  customerName,
  orgName,
  orgLogo,
  elomrade,
  annualConsumptionKwh,
  batteryName,
  results,
  createdAt,
}: CalculationPDFProps) {
  const formatSek = (n: number) =>
    Math.round(n).toLocaleString('sv-SE') + ' kr'

  const formatYears = (n: number) => {
    const years = Math.floor(n)
    const months = Math.round((n - years) * 12)
    if (months === 0) return `${years} ar`
    return `${years} ar ${months} man`
  }

  const formatPercent = (n: number) =>
    n.toFixed(1).replace('.', ',') + '%'

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* Header */}
        <View style={styles.header}>
          <Text style={styles.orgName}>{orgName}</Text>
          {orgLogo && <Image src={orgLogo} style={styles.logo} />}
        </View>

        {/* Title */}
        <Text style={styles.title}>Batterikalkyl</Text>
        <Text style={styles.subtitle}>
          Skapad for {customerName} - {createdAt.toLocaleDateString('sv-SE')}
        </Text>

        {/* Customer info */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Forutsattningar</Text>
          <View style={styles.row}>
            <Text style={styles.label}>Elomrade</Text>
            <Text style={styles.value}>{elomrade}</Text>
          </View>
          <View style={styles.row}>
            <Text style={styles.label}>Arlig forbrukning</Text>
            <Text style={styles.value}>{annualConsumptionKwh.toLocaleString('sv-SE')} kWh</Text>
          </View>
          <View style={styles.row}>
            <Text style={styles.label}>Batteri</Text>
            <Text style={styles.value}>{batteryName}</Text>
          </View>
        </View>

        {/* Cost section */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Investering</Text>
          <View style={styles.row}>
            <Text style={styles.label}>Totalkostnad inkl. moms</Text>
            <Text style={styles.value}>{formatSek(results.totalIncVatSek)}</Text>
          </View>
          <View style={styles.row}>
            <Text style={styles.label}>Gron Teknik-avdrag (48.5%)</Text>
            <Text style={styles.value}>-{formatSek(results.totalIncVatSek * 0.485)}</Text>
          </View>
          <View style={[styles.row, { paddingTop: 8, borderTopWidth: 1, borderTopColor: '#E5E7EB' }]}>
            <Text style={[styles.label, { fontWeight: 'bold' }]}>Nettokostnad</Text>
            <Text style={[styles.value, { color: '#059669' }]}>{formatSek(results.costAfterGronTeknikSek)}</Text>
          </View>
        </View>

        {/* Highlight: Payback */}
        <View style={styles.highlightBox}>
          <Text style={styles.highlightLabel}>ATERBETALTNINGSTID</Text>
          <Text style={styles.highlightValue}>{formatYears(results.paybackPeriodYears)}</Text>
          <Text style={styles.highlightSubtext}>
            Baserat pa {formatSek(results.totalAnnualSavingsSek)} i arlig besparing
          </Text>
        </View>

        {/* Savings breakdown */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Arlig besparing - {formatSek(results.totalAnnualSavingsSek)}</Text>
          <View style={styles.savingsGrid}>
            <View style={styles.savingsItem}>
              <Text style={styles.savingsLabel}>Spotprisoptimering</Text>
              <Text style={styles.savingsValue}>{formatSek(results.spotprisSavingsSek)}</Text>
            </View>
            <View style={styles.savingsItem}>
              <Text style={styles.savingsLabel}>Effekttariffbesparing</Text>
              <Text style={styles.savingsValue}>{formatSek(results.effectTariffSavingsSek)}</Text>
            </View>
            <View style={styles.savingsItem}>
              <Text style={styles.savingsLabel}>Stodtjanster</Text>
              <Text style={styles.savingsValue}>{formatSek(results.gridServicesIncomeSek)}</Text>
            </View>
          </View>
        </View>

        {/* ROI section */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Avkastning (ROI)</Text>
          <View style={styles.row}>
            <Text style={styles.label}>ROI efter 10 ar</Text>
            <Text style={[styles.value, { color: results.roi10YearPercent >= 0 ? '#059669' : '#DC2626' }]}>
              {formatPercent(results.roi10YearPercent)}
            </Text>
          </View>
          <View style={styles.row}>
            <Text style={styles.label}>ROI efter 15 ar</Text>
            <Text style={[styles.value, { color: results.roi15YearPercent >= 0 ? '#059669' : '#DC2626' }]}>
              {formatPercent(results.roi15YearPercent)}
            </Text>
          </View>
        </View>

        {/* Footer */}
        <Text style={styles.footer}>
          Denna kalkyl ar en uppskattning baserad pa aktuella elpriser och forbrukningsmonster.
          {'\n'}Verkligt utfall kan variera. Genererad via Kalkyla.se
        </Text>
      </Page>
    </Document>
  )
}
```

Create src/components/calculations/pdf/pdf-download-button.tsx:
```typescript
'use client'

import { useState } from 'react'
import { pdf } from '@react-pdf/renderer'
import { saveAs } from 'file-saver'
import { CalculationPDF } from './calculation-pdf'

interface PDFDownloadButtonProps {
  customerName: string
  orgName: string
  orgLogo?: string
  elomrade: string
  annualConsumptionKwh: number
  batteryName: string
  results: {
    totalIncVatSek: number
    costAfterGronTeknikSek: number
    totalAnnualSavingsSek: number
    paybackPeriodYears: number
    roi10YearPercent: number
    roi15YearPercent: number
    spotprisSavingsSek: number
    effectTariffSavingsSek: number
    gridServicesIncomeSek: number
  }
  createdAt: Date
  className?: string
}

export function PDFDownloadButton({
  customerName,
  orgName,
  orgLogo,
  elomrade,
  annualConsumptionKwh,
  batteryName,
  results,
  createdAt,
  className = '',
}: PDFDownloadButtonProps) {
  const [isGenerating, setIsGenerating] = useState(false)

  const handleDownload = async () => {
    setIsGenerating(true)
    try {
      const blob = await pdf(
        <CalculationPDF
          customerName={customerName}
          orgName={orgName}
          orgLogo={orgLogo}
          elomrade={elomrade}
          annualConsumptionKwh={annualConsumptionKwh}
          batteryName={batteryName}
          results={results}
          createdAt={createdAt}
        />
      ).toBlob()

      const filename = `batterikalkyl-${customerName.toLowerCase().replace(/\s+/g, '-')}-${createdAt.toISOString().split('T')[0]}.pdf`
      saveAs(blob, filename)
    } catch (error) {
      console.error('PDF generation failed:', error)
      alert('Kunde inte skapa PDF. Forsok igen.')
    } finally {
      setIsGenerating(false)
    }
  }

  return (
    <button
      onClick={handleDownload}
      disabled={isGenerating}
      className={`inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
    >
      {isGenerating ? (
        <>
          <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
          </svg>
          Skapar PDF...
        </>
      ) : (
        <>
          <svg className="-ml-1 mr-2 h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Ladda ner PDF
        </>
      )}
    </button>
  )
}
```
  </action>
  <verify>npx tsc --noEmit src/components/calculations/pdf/calculation-pdf.tsx src/components/calculations/pdf/pdf-download-button.tsx</verify>
  <done>PDF components compile; CalculationPDF renders professional-looking PDF, PDFDownloadButton triggers download</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete calculator engine with:
- Multi-step wizard (Customer Info -> Consumption -> Battery -> Results)
- Interactive consumption simulator with Recharts bar chart
- Preset consumption templates (4 types)
- Monthly tab navigation with copy pattern feature
- Battery selection with pricing inputs (1-4 batteries)
- Results display with summary cards, savings breakdown, ROI timeline
- Battery comparison side-by-side view
- Auto-save every 2 seconds to database
- Calculation list page with status filters
- Edit existing calculations
- PDF export with professional formatting
  </what-built>
  <how-to-verify>
1. Run `npm run dev` to start the development server
2. Log in as a Closer user
3. Navigate to /dashboard/calculations
4. Click "Ny kalkyl" to start a new calculation
5. **Step 1 - Customer Info:**
   - Enter customer name (e.g., "Test Kund")
   - Enter postal code and verify elomrade auto-detects
   - Select a natagare from dropdown
   - Enter annual consumption (e.g., 20000 kWh)
   - Click "Nasta"
6. **Step 2 - Consumption:**
   - Click a preset template (e.g., "Varmepump")
   - Verify chart updates with preset pattern
   - Click a bar to edit a single hour
   - Switch between months using tabs
   - Verify "Kopiera monster" copies pattern to other months
   - Click "Nasta"
7. **Step 3 - Battery:**
   - Select a battery from dropdown and click "Lagg till"
   - Enter total price ex VAT (e.g., 100000)
   - Enter installation cost (e.g., 15000)
   - Verify price calculations show correctly
   - Optionally add a second battery for comparison
   - Click "Nasta"
8. **Step 4 - Results:**
   - Verify summary cards show payback, annual savings, ROI
   - Verify savings breakdown pie chart displays
   - Verify ROI timeline chart shows 15-year projection
   - If multiple batteries, verify comparison table appears
   - Click "Slutfor kalkyl"
9. Verify redirected to calculation list
10. Click the saved calculation to edit it
11. Verify data loads correctly into wizard
12. Add PDF download button test (if visible)
13. Download PDF and verify it opens correctly

Expected: All steps work, data persists, charts render, PDF generates
  </how-to-verify>
  <resume-signal>Type "approved" if the calculator flow works end-to-end, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. Run `npm ls @react-pdf/renderer file-saver` - packages installed
2. Run `npx tsc --noEmit` - no TypeScript errors
3. Run `npm run build` - builds successfully
4. Calculation list shows active calculations
5. Edit page loads existing calculation data
6. PDF downloads with correct content
7. Full wizard flow completes successfully
</verification>

<success_criteria>
- Calculation list page shows all user's calculations with status
- Calculation list supports delete (archive) action
- Edit page loads existing calculation into wizard
- PDF export generates professional document with all results
- Full wizard flow: create -> edit consumption -> select battery -> view results -> finalize
- Auto-save persists drafts to database
- Human verification confirms end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/03-calculator-engine/03-05-SUMMARY.md`
</output>
