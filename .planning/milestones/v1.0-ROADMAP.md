# Milestone v1.0: MVP

**Status:** ✅ SHIPPED 2026-01-20
**Phases:** 1-5
**Total Plans:** 26

## Overview

This roadmap delivered a multi-tenant battery ROI calculator SaaS in 5 phases. Started with authentication and organization management (the foundation everything depends on), then built reference data management (batteries, grid operators, pricing), followed by the core calculator engine, the customer-facing shareable view (the core value proposition), and finally operations tooling (alerts, analytics, dashboards). Each phase delivered a complete, verifiable capability.

## Phases

### Phase 1: Foundation

**Goal**: Users can securely access the system and organizations are isolated with proper role hierarchy
**Depends on**: Nothing (first phase)
**Plans**: 8 plans

Plans:
- [x] 01-01: Project Setup & Database Foundation
- [x] 01-02: Auth.js v5 Integration
- [x] 01-03: Login & Logout UI
- [x] 01-04: Organization Management (Super Admin)
- [x] 01-05: User Management
- [x] 01-06: Password Reset Flow
- [x] 01-07: Org Admin Settings
- [x] 01-08: Phase Verification

**Details:**
- Next.js 16 with App Router
- Prisma 7.2 with tenant-scoping extension
- Neon serverless driver for WebSocket/HTTPS database access
- Auth.js v5 with credentials provider
- JWT strategy for stateless sessions
- RBAC: Super Admin → Org Admin → Closer
- ProffsKontakt affiliation model with fixed SEK installer cut

### Phase 2: Reference Data

**Goal**: Org Admins can configure batteries, grid operators, and electricity pricing for their organization
**Depends on**: Phase 1
**Plans**: 4 plans

Plans:
- [x] 02-01: Schema, permissions, and tenant scoping foundation
- [x] 02-02: Battery brand and configuration CRUD
- [x] 02-03: Natagare CRUD with default seeding
- [x] 02-04: Electricity pricing storage and display

**Details:**
- Battery configs with capacity, charge/discharge rates, efficiencies, warranty, degradation
- Natagare (grid operators) with day/night effect tariff rates
- Ellevio rates verified: 81.25/40.625 SEK/kW day/night
- mgrey.se API integration for Nord Pool electricity prices
- Quarterly averages stored per elomrade (SE1-SE4)
- Day/night split: 06:00-22:00 / 22:00-06:00

### Phase 3: Calculator Engine

**Goal**: Closers can build complete battery ROI calculations with accurate Swedish market logic
**Depends on**: Phase 2
**Plans**: 5 plans

Plans:
- [x] 03-01: Database schema and core calculation engine with decimal.js
- [x] 03-02: Wizard state management with Zustand and auto-save
- [x] 03-03: Customer info step and consumption simulator with Recharts
- [x] 03-04: Battery selection and results display with charts
- [x] 03-05: Calculation list, PDF export, and end-to-end verification

**Details:**
- Calculation/CalculationBattery models with JSON fields for profiles and results
- decimal.js for financial precision (no floating point errors)
- Zustand persist middleware with localStorage
- 2-second debounce auto-save with flush on unmount
- 12x24 consumption profile (one average day per month)
- Click-to-edit bars for precise input
- Spotpris optimization, effect tariff savings, grid services income
- Payback period, 10-year ROI, 15-year ROI
- PDF export with @react-pdf/renderer

### Phase 4: Customer Experience

**Goal**: Prospects can view branded, interactive ROI calculations via shareable links
**Depends on**: Phase 3
**Plans**: 4 plans

Plans:
- [x] 04-01: Schema & Share Link Infrastructure
- [x] 04-02: Share UI & Link Management
- [x] 04-03: Public Route & View Components
- [x] 04-04: Interactive Simulator & Mobile Experience

**Details:**
- Share codes using nanoid (21 chars, 126 bits entropy)
- IP addresses hashed with SHA256 for privacy
- Optional password protection with bcrypt
- Public data excludes marginSek, costPrice, installerCut
- CSS custom properties for org branding colors
- Click-to-edit bars with modal input
- On-demand recalculation via "Uppdatera" button
- Changed hours highlighted in orange
- Sticky results bar after 400px scroll
- Mobile battery carousel with snap scrolling
- Variant tracking for prospect experiments

### Phase 5: Operations

**Goal**: Admins have visibility into calculations, alerts for low margins, and analytics on customer engagement
**Depends on**: Phase 4
**Plans**: 4 plans

Plans:
- [x] 05-01: PostHog & Sentry Setup
- [x] 05-02: N8N Margin Alerts
- [x] 05-03: Admin Dashboards
- [x] 05-04: Phase Verification

**Details:**
- PostHog: pageviews, session replays, heatmaps, custom events
- Custom events: calculation_viewed, simulator_adjusted, scroll_depth, time_on_page
- Sentry: error tracking with stack traces, performance monitoring
- N8N webhook for margin alerts (< 24,000 SEK threshold)
- Fire-and-forget webhook pattern (errors logged, never thrown)
- Role-based dashboard data scoping
- View counts and last viewed timestamps

---

## Milestone Summary

**Decimal Phases:**

None - all phases were planned from the start.

**Key Decisions:**

- Prisma 7.2 with new config pattern (no URL in schema, uses prisma.config.ts)
- Tenant scoping via Prisma $extends, not RLS (can add later for defense-in-depth)
- Neon serverless driver for WebSocket/HTTPS database access (port 5432 blocked)
- No PrismaAdapter - credentials-only auth doesn't need OAuth account linking
- JWT strategy for sessions - stateless auth works well with serverless
- ProffsKontakt margin model: installerFixedCut (fixed SEK amount)
- Price storage in ore/kWh as returned by mgrey.se API
- Day hours 6-21, Night hours 22-23 and 0-5 for quarterly average calculation
- decimal.js for financial precision
- Elomrade lookup uses static postal code ranges (no reliable API)
- Zustand persist middleware with localStorage for wizard state
- 2-second debounce for auto-save
- Click-to-edit bars pattern (better UX than dragging)
- Share codes use nanoid with 21 characters (126 bits entropy)
- On-demand recalculation via button (not instant/live)
- Fire-and-forget webhook pattern for margin alerts

**Issues Resolved:**

- Prisma client sync issues with database schema after field renames
- Super Admin self-editing restrictions
- Decimal serialization for client components
- TypeScript strict type checking for tenant client operations
- Recharts Tooltip formatter type errors
- Prisma JSON type incompatibility

**Issues Deferred:**

- Vattenfall/E.ON effect tariff rates not officially published (deadline Jan 2027) - using placeholders
- mgrey.se API has no SLA - manual entry fallback implemented

**Technical Debt Incurred:**

None - all tech debt resolved during milestone.

---

*For current project status, see .planning/PROJECT.md*
