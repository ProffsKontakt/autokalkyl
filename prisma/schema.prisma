// Kalkyla.se - Multi-tenant Battery ROI Calculator
// Prisma schema for Phase 1: Foundation
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum Role {
  SUPER_ADMIN // Platform-level admin, can access all organizations
  ORG_ADMIN   // Organization admin, can manage users and settings
  CLOSER      // Sales closer, can create and manage own calculations
}

enum Elomrade {
  SE1 // Northern Sweden (Lulea)
  SE2 // Northern Central Sweden (Sundsvall)
  SE3 // Southern Central Sweden (Stockholm)
  SE4 // Southern Sweden (Malmo)
}

enum CalculationStatus {
  DRAFT     // Auto-saved draft, not complete
  COMPLETE  // Finalized calculation
  ARCHIVED  // Soft-deleted
}

// =============================================================================
// ORGANIZATION (Tenant)
// =============================================================================

model Organization {
  id                       String   @id @default(cuid())
  name                     String
  slug                     String   @unique // URL-friendly identifier: /acme-solar/calc123
  logoUrl                  String?
  primaryColor             String   @default("#3B82F6")   // Brand primary color
  secondaryColor           String   @default("#1E40AF")   // Brand secondary color

  // ProffsKontakt affiliation
  // When affiliated: ProffsKontakt administers sales for this org
  // Margin calc: Sale Price (ex VAT) - Battery Cost - Installer Cut = ProffsKontakt Margin
  isProffsKontaktAffiliated Boolean  @default(false)
  installerFixedCut        Decimal? @db.Decimal(10, 2)   // Fixed SEK amount to installer (e.g., 23000)
  marginAlertThreshold     Decimal? @db.Decimal(10, 2)   // Min margin in SEK before alert (e.g., 24000)

  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relations
  users          User[]
  batteryBrands  BatteryBrand[]
  batteryConfigs BatteryConfig[]
  natagare       Natagare[]
  calculations   Calculation[]

  @@index([slug])
}

// =============================================================================
// USER
// =============================================================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         Role     @default(CLOSER)
  orgId        String?  // Null for SUPER_ADMIN (platform-level access)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)
  sessions     Session[]
  accounts     Account[]
  passwordResetTokens PasswordResetToken[]

  @@index([orgId])
  @@index([email])
}

// =============================================================================
// AUTH.JS (NextAuth v5) ADAPTER MODELS
// =============================================================================

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// Verification token for email verification (Auth.js pattern)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =============================================================================
// PASSWORD RESET
// =============================================================================

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// =============================================================================
// BATTERY REFERENCE DATA (Tenant-scoped)
// =============================================================================

model BatteryBrand {
  id        String   @id @default(cuid())
  name      String
  logoUrl   String?
  orgId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  configs      BatteryConfig[]

  @@unique([orgId, name]) // No duplicate brand names per org
  @@index([orgId])
}

model BatteryConfig {
  id      String @id @default(cuid())
  name    String
  brandId String
  orgId   String

  // Core specs
  capacityKwh    Decimal @db.Decimal(10, 2) // e.g., 15.00 kWh
  maxDischargeKw Decimal @db.Decimal(10, 2) // e.g., 10.00 kW
  maxChargeKw    Decimal @db.Decimal(10, 2) // e.g., 10.00 kW

  // Efficiencies (stored as percentage, e.g., 95.00 for 95%)
  chargeEfficiency    Decimal @db.Decimal(5, 2) // e.g., 95.00
  dischargeEfficiency Decimal @db.Decimal(5, 2) // e.g., 95.00

  // Lifecycle
  warrantyYears      Int
  guaranteedCycles   Int
  degradationPerYear Decimal @db.Decimal(5, 2) // e.g., 2.50 for 2.5%/year

  // Pricing
  costPrice Decimal @db.Decimal(10, 2) // Battery cost in SEK

  // Flags
  isExtensionCabinet Boolean @default(false) // True for extension/add-on batteries
  isNewStack         Boolean @default(true)  // True for new stack, false for refurbished
  isActive           Boolean @default(true)  // Soft delete / hide from UI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  brand               BatteryBrand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  organization        Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  calculationBatteries CalculationBattery[]

  @@unique([orgId, brandId, name]) // No duplicate config names per brand per org
  @@index([orgId])
  @@index([brandId])
}

// =============================================================================
// NATAGARE (Grid Operator) - Tenant-scoped
// =============================================================================

model Natagare {
  id   String @id @default(cuid())
  name String

  // Effekttariff rates (day/night) in SEK/kW
  dayRateSekKw   Decimal @db.Decimal(10, 4) // e.g., 81.2500
  nightRateSekKw Decimal @db.Decimal(10, 4) // e.g., 10.0000

  // Time windows (24h format)
  dayStartHour Int @default(6)  // Day tariff starts at 06:00
  dayEndHour   Int @default(22) // Day tariff ends at 22:00

  orgId     String
  isDefault Boolean @default(false) // Default natagare for new calculations
  isActive  Boolean @default(true)  // Soft delete / hide from UI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  calculations Calculation[]

  @@unique([orgId, name]) // No duplicate natagare names per org
  @@index([orgId])
}

// =============================================================================
// ELECTRICITY PRICING (Global - NOT tenant-scoped)
// =============================================================================

model ElectricityPrice {
  id       String   @id @default(cuid())
  elomrade Elomrade // SE1, SE2, SE3, SE4
  date     DateTime @db.Date // Date only (no time component)
  hour     Int      // 0-23

  priceOre Decimal @db.Decimal(10, 2) // Price in ore/kWh (e.g., 142.50)

  createdAt DateTime @default(now())

  @@unique([elomrade, date, hour]) // One price per zone/date/hour
  @@index([elomrade, date])
  @@index([date])
}

model ElectricityPriceQuarterly {
  id       String   @id @default(cuid())
  elomrade Elomrade
  year     Int
  quarter  Int      // 1-4

  avgDayPriceOre   Decimal @db.Decimal(10, 2) // Average day price in ore/kWh
  avgNightPriceOre Decimal @db.Decimal(10, 2) // Average night price in ore/kWh
  avgPriceOre      Decimal @db.Decimal(10, 2) // Overall average in ore/kWh

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([elomrade, year, quarter])
  @@index([elomrade])
}

// =============================================================================
// CALCULATION (Tenant-scoped)
// =============================================================================

model Calculation {
  id        String            @id @default(cuid())
  orgId     String
  createdBy String            // User ID who created
  status    CalculationStatus @default(DRAFT)

  // Customer Info (Step 1)
  customerName         String
  postalCode           String?               // Optional, used for elomrade auto-detect
  elomrade             Elomrade
  natagareId           String
  annualConsumptionKwh Decimal  @db.Decimal(10, 2)

  // Consumption Profile (Step 2)
  // Stored as JSON: { data: number[][] } where [month][hour]
  consumptionProfile Json

  // Results (calculated server-side)
  results Json?

  // Metadata
  shareCode   String?   @unique // For public sharing (Phase 4)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  finalizedAt DateTime?

  // Relations
  organization Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  natagare     Natagare             @relation(fields: [natagareId], references: [id])
  batteries    CalculationBattery[]

  @@index([orgId])
  @@index([createdBy])
  @@index([shareCode])
}

model CalculationBattery {
  id              String @id @default(cuid())
  calculationId   String
  batteryConfigId String

  // Pricing
  totalPriceExVat  Decimal @db.Decimal(10, 2)
  installationCost Decimal @db.Decimal(10, 2)

  // Calculated results for this battery
  results Json?

  // For comparison feature
  sortOrder Int @default(0)

  // Relations
  calculation   Calculation   @relation(fields: [calculationId], references: [id], onDelete: Cascade)
  batteryConfig BatteryConfig @relation(fields: [batteryConfigId], references: [id])

  @@unique([calculationId, batteryConfigId])
  @@index([calculationId])
}
